<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.beauty1nside.hr.mapper.DeptMapper">

	<!-- 회사 정보 조회 -->
	<select id="getCompanyInfo" resultType="com.beauty1nside.hr.dto.DeptDTO">
	    SELECT 
	        c.company_num as companyNum,
	        c.company_name as companyName,
	        c.company_eng_name as companyEngName,
	        (SELECT COUNT(*) FROM hr_employee he WHERE he.company_num = c.company_num) AS totalEmployeeCount
	    FROM ERP_COMPANY c
	    WHERE c.company_num = #{companyNum}
	</select>

    <!-- 부서 전체 목록 조회 -->
    <select id="list" resultType="com.beauty1nside.hr.dto.DeptDTO">
	    SELECT
	        d.department_num AS departmentNum,
	        d.department_name AS departmentName,
	        d.parent_department_num AS parentDepartmentNum,
	        d.department_type AS departmentType,
	        dt.cmmn_name AS departmentTypeName,  -- 공통코드에서 부서 유형명 가져옴
	        d.manager_num AS managerNum,
	        e.employee_name AS managerName, -- 부서장 이름 가져오기
	        d.department_status AS departmentStatus,
	        ds.cmmn_name AS departmentStatusName, -- 공통코드에서 부서 상태명 가져옴
	        d.register_date AS registerDate,
	        d.update_date AS updateDate,
	        d.company_num AS companyNum,
	        (SELECT COUNT(*) FROM hr_employee he WHERE he.department_num = d.department_num) AS employeeCount  -- 직원 수 추가
	     FROM HR_DEPARTMENT d
		    LEFT JOIN CMMN dt on d.department_type = dt.cmmn_code  -- 부서 유형 조인
		    LEFT JOIN CMMN ds on d.department_status = ds.cmmn_code  -- 부서 상태 조인
		    LEFT JOIN hr_employee e on d.manager_num = e.employee_num and e.authority = 'au002' -- 부서장 조인
	    WHERE d.company_num = #{companyNum}
	    ORDER BY d.department_num
    </select>


</mapper>