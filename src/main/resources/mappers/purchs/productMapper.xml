<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.beauty1nside.purchs.mapper.productMapper">
<!-- catelist 카테고리 조회-->

<select id="getCatelist" resultType="ProductDTO">
    SELECT * FROM stdr_classification
    WHERE company_num = #{companyNum}
    ORDER BY classification_id DESC
</select>

<!-- brandlist 브랜드 조회 -->
<select id="brandlist" resultType="ProductDTO">
    SELECT BRAND_ID, BRAND_CODE, BRAND_NAME, COMPANY_NUM
    FROM (
        SELECT /*+index_desc(STDR_BRAND PK_STDR_BRAND)*/
               ROWNUM RN,
               BRAND_ID,
               BRAND_CODE,
               BRAND_NAME,
               COMPANY_NUM
        FROM STDR_BRAND
        where company_num = #{companyNum}
        <include refid="searchbrandInfo"/>  <!-- 검색 조건 포함 -->
		ORDER BY BRAND_ID DESC <!-- ORDER BY 위치  -->
        
    )
    WHERE RN BETWEEN #{start} AND #{end}  <!--  WHERE 수정 -->
    
</select>


<!-- 카운트 -->
<select id="brandcount" resultType="int">
	select count(*) from stdr_brand
	 where company_num = #{companyNum}
		<include refid="searchbrandInfo"></include>
</select>

<!--  searchbrandInfo 쿼리 -->
<sql id="searchbrandInfo">
    <where>
    <!-- company_num LIKE '%' || #{companyNum} || '%' -->
        <if test="brandName != null and brandName != ''">
            brand_name LIKE '%' || #{brandName} || '%'
        </if>
    </where>
</sql>


<!-- vendorlist 브랜드 조회 -->
<select id="vendorlist" resultType="ProductDTO">
    SELECT VENDOR_ID, VENDOR_NAME
    FROM (
        SELECT /*+index_desc(STDR_BRAND PK_GRPWR_VENDOR)*/
               ROWNUM RN,
               VENDOR_ID,
               VENDOR_NAME             
        FROM GRPWR_VENDOR
        where company_num = #{companyNum}
        <include refid="searchVendorInfo"/>  <!-- 검색 조건 포함 -->
		ORDER BY VENDOR_ID DESC <!-- ORDER BY 위치  -->
        
    )
    WHERE RN BETWEEN #{start} AND #{end}  <!--  WHERE 수정 -->
    
</select>


<!-- 카운트 -->
<select id="vendorcount" resultType="int">
	select count(*) from GRPWR_VENDOR
	where company_num = #{companyNum}
		<include refid="searchVendorInfo"></include>
</select>

<!--  searchbrandInfo 쿼리 -->
<sql id="searchVendorInfo">
    <where>
    <!-- company_num LIKE '%' || #{companyNum} || '%' -->
        <if test="vendorName != null and vendorName != ''">
            VENDOR_NAME LIKE '%' || #{vendorName} || '%'
        </if>
    </where>
</sql>

<!-- warehouselist  창고 조회 -->
<select id="warehouselist" resultType="ProductDTO">
    SELECT WAREHOUSE_ID, WAREHOUSE_NAME,COMPANY_NUM
    FROM (
        SELECT /*+index_desc(STDR_BRAND PK_STDR_WAREHOUSE)*/
               ROWNUM RN,
               WAREHOUSE_ID,
               WAREHOUSE_NAME,
               COMPANY_NUM
        FROM STDR_WAREHOUSE
        where company_num = #{companyNum}
        <include refid="searchwarehouseInfo"/>  <!-- 검색 조건 포함 -->
		 ORDER BY WAREHOUSE_ID DESC <!-- ORDER BY 위치  -->
        
    )
    WHERE RN BETWEEN #{start} AND #{end}  <!--  WHERE 수정 -->
   
</select>


<!-- 카운트 -->
<select id="warehousecount" resultType="int">
	select count(*) from STDR_WAREHOUSE
	where company_num = #{companyNum}
		<include refid="searchwarehouseInfo"></include>
</select>

<!--  searchwarehouseInfo 쿼리 -->
<sql id="searchwarehouseInfo">
    <where>
    <!-- company_num LIKE '%' || #{companyNum} || '%' -->
        <if test="warehouseName != null and warehouseName != ''">
            warehouse_name LIKE '%' || #{warehouseName} || '%'
        </if>
    </where>
</sql>

<!-- 상품 등록 프로시저 호출  -->
<insert id="goodsinsert" statementType="CALLABLE">
    {CALL purchs_product_register(
        #{goodsName, mode=IN, jdbcType=VARCHAR},
        #{goodsCost, mode=IN, jdbcType=NUMERIC},
        #{goodsPrice, mode=IN, jdbcType=NUMERIC},
        #{goodsSupplyPrice, mode=IN, jdbcType=NUMERIC},
        #{goodsStandard, mode=IN, jdbcType=VARCHAR},
        #{goodsDescription, mode=IN, jdbcType=VARCHAR},
        #{goodsImage, mode=IN, jdbcType=VARCHAR},
        #{classificationId, mode=IN, jdbcType=NUMERIC},
        #{brandId, mode=IN, jdbcType=NUMERIC},
        #{employeeNum, mode=IN, jdbcType=NUMERIC},
        #{vendorId, mode=IN, jdbcType=NUMERIC},
        #{companyNum, mode=IN, jdbcType=NUMERIC},
        #{files, mode=IN, typeHandler=com.beauty1nside.purchs.OracleArrayProductHandler}
    )}
</insert>

<!-- 상품조회 -->
<select id="goodslist" resultType="ProductDTO">
    SELECT * FROM (
        SELECT /*+index_desc(purchse_goods PK_PURCHSE_GOODS)*/
               ROWNUM RN, 
               g.goods_name,
               g.goods_code,
               g.goods_standard,
               g.goods_image,
               g.goods_price,
               g.goods_cost,
               g.goods_supply_price,
               g.goods_description,
               g.brand_id,
               g.classification_id,
               g.vendor_id,
               w.warehouse_id,
               o.option_num,
               o.option_name,
               o.option_code,
               o.option_safety_invoice,
               b.brand_name,
               c.classification_name,
               v.vendor_name,
               w.warehouse_name,
               erp_employee_name(g.employee_num)
        FROM purchse_goods g 
        LEFT JOIN purchse_option o ON g.goods_num = o.goods_num 
        JOIN stdr_brand b ON g.brand_id = b.brand_id
        JOIN stdr_classification c ON g.classification_id = c.classification_id
        JOIN grpwr_vendor v ON g.vendor_id = v.vendor_id
        LEFT JOIN stdr_warehouse w ON o.warehouse_id = w.warehouse_id
        WHERE g.company_num = #{companyNum}  <!-- 기본 WHERE 조건 (회사번호 필수)-->
        <include refid="searchproductlistInfo"/>  <!-- 추가 검색 조건 -->
        ORDER BY g.goods_code DESC
    ) 
    WHERE RN BETWEEN #{start} AND #{end}  <!-- 페이징 조건 추가 -->
</select>

<!-- 상품 수 카운트 -->
<select id="productcount" resultType="int">
    SELECT COUNT(*) 
    FROM purchse_goods g 
    LEFT JOIN purchse_option o ON g.goods_num = o.goods_num
    JOIN stdr_brand b ON g.brand_id = b.brand_id
    JOIN stdr_classification c ON g.classification_id = c.classification_id
    JOIN grpwr_vendor v ON g.vendor_id = v.vendor_id
    LEFT JOIN stdr_warehouse w ON o.warehouse_id = w.warehouse_id
    WHERE g.company_num = #{companyNum}  <!-- ✅ 기본 WHERE 조건 -->
    <include refid="searchproductlistInfo"/>  <!-- ✅ 추가 검색 조건 -->
</select>

<!-- 검색 조건 쿼리 -->
<sql id="searchproductlistInfo">
    <if test="goodsName != null and goodsName != ''">
        AND g.goods_name LIKE '%' || #{goodsName} || '%'
    </if>
    <if test="brandName != null and brandName != ''">
        AND b.brand_name LIKE '%' || #{brandName} || '%'
    </if>
</sql>





</mapper>