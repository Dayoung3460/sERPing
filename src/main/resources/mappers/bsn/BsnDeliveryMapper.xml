<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.beauty1nside.bsn.mapper.BsnOrderMapper">

<!-- 출고 목록 조회 -->
<select id="selectBsnDelivery">
SELECT 
       delivery_id, 
       order_id,
       delivery_date,
       employee_num,
       delivery_status,
       remark,
       company_num,
   --    bo.order_code,
       order_name,
       branch_office_id,
       order_date,
       due_date
FROM
(
SELECT ROW_NUMBER() OVER (
              ORDER BY TO_NUMBER(REGEXP_SUBSTR(bd.delivery_id, '\d+')) desc
       ) AS RN,
       bd.delivery_id, 
       bd.order_id,
       bd.delivery_date,
       bd.employee_num,
       bd.delivery_status,
       bd.remark,
       bd.company_num,
   --    bo.order_code,
       bo.order_name,
       bo.branch_office_id,
       bo.order_date,
       bo.due_date

FROM bsn_delivery bd
LEFT JOIN bsn_order bo ON bo.order_id = bd.order_id
WHERE bd.company_num = 1
<include refid="searchInfoBsnDLV"></include>
<![CDATA[
AND ROWNUM <= #{end}
]]>
)
WHERE RN >= #{start}
</select>

<!-- 출고 목록 수량 -->


<!-- 출고 상세 목록-->
<select id="selectBsnDeliveryDetail">
SELECT 
delivery_detail_id,
delivery_id,
order_detail_id,
option_code,
delivery_demand_qnt,
delivery_total_qnt,
sufficiency_status,
option_barcode,
goods_name,
option_name,
goods_standard
FROM
(
SELECT /*+ INDEX_ASC(bsn_delivery_detail PK_bsn_delivery_detail) */
ROWNUM rn,
bdd.delivery_detail_id,
bdd.delivery_id,
bdd.order_detail_id,
bdd.option_code,
bdd.delivery_demand_qnt,
bdd.delivery_total_qnt,
bdd.sufficiency_status,
bdd.option_barcode,
bod.goods_name,
bod.option_name,
bod.goods_standard

FROM bsn_delivery_detail bdd
LEFT JOIN bsn_order_detail bod ON bdd.order_detail_id = bod.order_detail_id
WHERE bdd.delivery_id = #{deliveryId}
<![CDATA[
AND ROWNUM <= #{end}
]]>
)
WHERE RN >= #{start}
</select>

<!-- 출고 상세 목록 수량-->

<!-- 출고 LOT 상세 목록-->
<select id="selectBsnDeliveryLotDTO">
SELECT delivery_lot_detail_num, 
       delivery_detail_id, 
       goods_lot_num, 
       delivery_possible_qnt, 
       delivery_qnt
FROM
(
SELECT /*+ INDEX_ASC(bsn_delivery_lot_detail PK_BSN_DELIVERY_LOT_DETAIL) */
       ROWNUM rn,
       delivery_lot_detail_num, 
       delivery_detail_id, 
       goods_lot_num, 
       delivery_possible_qnt, 
       delivery_qnt
FROM bsn_delivery_lot_detail
WHERE delivery_detail_id = #{deliveryDetailId}
<![CDATA[
AND ROWNUM <= #{end}
]]>
)
WHERE RN >= #{start}
</select>
<!-- 출고 LOT 상세 목록 수량-->

<!-- 검색조건 -->
<sql id="searchInfoBsnDLV">
	 
	<if test="deteOption != null and deteOption == 'orderDate' and  startDate != null">
		AND bo.order_date >= #{startDate}
	</if>
	<if test="deteOption != null and deteOption == 'orderDate' and  endDate != null">
		<![CDATA[
		AND bo.order_date <= #{endDate}
... < #{endDate}
		]]>
	</if>
	
	<if test="deteOption != null and deteOption =='dueDate' and  startDate != null">
		AND bo.due_date >= #{startDate}
	</if>
	<if test="deteOption != null and deteOption == 'dueDate' and  endDate != null">
		<![CDATA[
		AND bo.due_date <= #{endDate}
		]]>
	</if>
	
	
	
	
	<if test="branch != null and ! branch.equals('all')">
			AND branch_office_id Like '%' || #{branch} || '%'
	</if>
</sql>

<!-- 임시 -->
<select id="selectGoodsWarehouseLot">
SELECT ROW_NUMBER() OVER (
              ORDER BY goods_consumption_date asc
       ) AS RN, 
       pwb.warehousing_body_num,
       pwb.option_num,
       po.option_code,
       pwb.goods_lot_num,
       TRUNC(pwb.warehousing_remaining_quantity / 6) AS warehousing_remaining_quantity
      ,pwb.goods_consumption_date

       

FROM purchs_warehousing_body pwb
LEFT JOIN purchse_option po ON pwb.option_num = po.option_num
WHERE pwb.company_num = 1
  AND po.option_code = #{optionCode}
ORDER by rn

</select>

</mapper>