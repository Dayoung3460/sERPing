<!-- 발주 요청 페이지 -->

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<!-- timePicker -->
<link rel="stylesheet" href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.css" />
<script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.js"></script>

<!-- datePicker -->
<link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>

<!-- paging -->
<link rel="stylesheet" href="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.css" />
<script src="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.js"></script>

<!-- toast grid -->
<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

<!-- 엑셀 -->
<script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>

</head>
<body>
	<div class="container">
		<div class="row">
			<h3 class="mt-2 mb-2">상품 발주 요청</h3>
			<hr>
			<div class="col-md-6 mt-2 mb-2">
				<div class="row">
					<label class="col-sm-4">주문 지점</label> 
					<input type="text"class="col-sm-7" readonly>
				</div>
			</div>
			<div class="col-md-6 mt-2 mb-2">
				<div class="row">
					<div class="col-sm-1"></div>
					<label class="col-sm-4">납기 일자</label> 
					<input type="date"class="col-sm-7">
				</div>
			</div>
			<div class="col-md-12 mt-2 mb-5">
				<div class="row">
					<label class="col-sm-2">비고</label> 
					<input type="text"class="col-sm-10">
				</div>
			</div>
			<div class="col-md-6 stretch-card mt-2 mb-2">
				<div class="card">
					<div class="card-body">
						<div class="row mb-3">
							<label class="col-sm-2">상품명</label> 
							<input type="text" class="col-sm-6" id="goodsName">
							<button type="button" class="col-sm-2" onclick="search()">검색</button>
							<button type="button" class="col-sm-2">초기화</button>
						</div>
						<div id="goods"></div>
						<div id="pagination" class="tui-pagination"></div>
					</div>
				</div>
			</div>
			<div class="col-md-6 stretch-card mt-2">
				<div class="card">
					<div class="card-body">
						<h6 class="mb-4">상품별 옵션</h6>
						<div id="option"></div>
						<div id="pagination" class="tui-pagination"></div>
					</div>
				</div>
			</div>
			<div class="col-md-12 stretch-card mt-3 mb-5">
				<div class="card">
					<div class="card-body">
						<h6 class="mb-4">발주서 작성</h6>
						<div id="order"></div>
						<div id="pagination" class="tui-pagination"></div>
						<div style="text-align : center">
							<button>등록</button>
							<button>초기화</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>

<script>
	var Grid = tui.Grid;
	
	document.addEventListener("DOMContentLoaded",()=>{
		OPnodata();
		ODnodata();
	})
	
	// 상품조회 쿼리 호출
	const dataSource = {
		api: {
			readData: { url: 'http://localhost:81/bhf/rest/goods/list', method: 'GET', initParams: { page: 1 }},
		},
		contentType: 'application/json'
		
	};
	//상품 테이블
	const grid = new Grid({
		el: document.getElementById('goods'), // 컨테이너 엘리먼트
		pageOptions: {
			useClient: true,
			perPage: 5,
		},
		columns: [ 
			{ header : "상품코드", name : "goodsCode"},
			{ header : "상품명", name : "goodsName"},
			{ header : "규격", name : "goodsStandard"}
		],
		data: dataSource
	});
	// 상품 테이블 행 선택
	grid.on('click', (ev) => {
		const rowKey = ev.rowKey;  // 클릭된 행의 키값
		const rowData = grid.getRow(rowKey);  //해당 행의 데이터 가져오기
		const goodsCode = rowData.goodsCode;  //url의 보내기 위해서 변수담기	
		// 옵션조회 쿼리 호출(goodsCode)
	    fetch('http://localhost:81/bhf/rest/option/list?goodsCode=' + goodsCode, {
	        method: 'GET',
	        headers: {
	            'Content-Type': 'application/json'
	        }
	    })
	    .then(response => response.json())
	    .then(data => {
	    	console.log(data.data.contents)
	        grid2.resetData(data.data.contents);  // 옵션 테이블 데이터 업데이트
	    })
	    .catch(error => console.error("데이터 요청 실패:", error));
	});
	// 옵션 테이블
	const grid2 = new Grid({
		el: document.getElementById('option'), 
		pageOptions: {
			useClient: false,
			perPage: 5
		},
		columns: [ 
			{ header : "상품코드", name : "goodsCode"},
			{ header : "옵션코드", name : "optionCode"},
			{ header : "옵션명", name : "optionName"}
		],
		data: "",
		language: {
	        emptyMessage: "데이터가 없습니다. 상품을 선택해 주세요." // "NO DATA" 메시지 변경
	    }
	});
	// 옵션 테이블 행 선택
	grid2.on('click', (ev) => {
	    const rowData = grid2.getRow(ev.rowKey); // 해당 행의 데이터 가져오기
        if (rowData) {
	        const currentData = grid3.getData(); // 기존 데이터 가져오기
	        grid3.resetData([...currentData, rowData]); // 기존 데이터에 새로운 행 추가하여 발주테이블 업데이트
	    }
	});
	
	// 발주 테이블
	const grid3 = new Grid({
		el: document.getElementById('order'), // 컨테이너 엘리먼트
		pageOptions: {
			useClient: true,
			perPage: 5
		},
		columns: [ 
			{ header : "상품코드", name : "goodsCode"},
			{ header : "상품명", name : "goodsName"},
			{ header : "옵션코드", name : "optionCode"},
			{ header : "옵션명", name : "optionName"},
			{ header : "규격", name : "goodsStandard"},
			{ header : "발주수량", name : "quantity", editor: 'text'}
		],
		data: ""
	});
	
	// 검색 함수
	function search(){
		console.log("click")
		let goodsName = document.querySelector('#goodsName').value;
		grid.setRequestParams({"goodsName" : goodsName})
		grid.readData();
	}
	
	// 옵션 테이블 데이터 없을때 나오는 문구
	function OPnodata(){
		setTimeout( () => {
			let nodata = document.querySelectorAll('.tui-grid-layer-state-content p')[1];
			nodata.innerHTML = '상품을 선택 해주세요.';
		}, 10)
	}
	// 발주 테이블 데이터 없을때 나오는 문구
	function ODnodata(){
		setTimeout( () => {
			let nodata = document.querySelectorAll('.tui-grid-layer-state-content p')[2];
			nodata.innerHTML = '옵션을 선택 해주세요';
		}, 10)
	}
	
</script>
</html>