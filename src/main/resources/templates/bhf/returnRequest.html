<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<meta charset="UTF-8">
<title>교환 및 반품 요청</title>
</head>
<body layout:fragment="content">
	<div class="container">
		<div class="row">
			<h3 class="mt-2 mb-2">교환 및 반품 요청</h3>
			<hr>
			<div class="col-md-6 mt-2 mb-5">
				<div class="row">
					<label class="col-sm-4">상품명</label> 
					<input type="text" class="col-sm-5" id="goodsName">
					<button type="button" class="col-sm-2" onclick="search()">검색</button>
				</div>
			</div>
			<div class="col-md-6 mt-2 mb-5">
				<div class="row">
					
					<label class="col-sm-4">주문 지점</label> 
					<input type="text"class="col-sm-7" id="branchOfficeId">
				</div>
			</div>
			<div class="col-md-6 stretch-card mt-2 mb-2">
				<div class="card">
					<div class="card-body">
						<h6 class="mb-4">보유 상품</h6>
						<div id="housegoods"></div>
						<div id="pagination" class="tui-pagination"></div>
					</div>
				</div>
			</div>
			<div class="col-md-6 stretch-card mt-2 mb-2">
				<div class="card">
					<div class="card-body">
						<h6 class="mb-4">상품별 옵션</h6>
						<div id="option"></div>
						<div id="pagination" class="tui-pagination"></div>
					</div>
				</div>
			</div>
			<div class="col-md-12 stretch-card mt-3 mb-5">
				<div class="card">
					<div class="card-body">
						<h6 class="mb-4">요청서 작성</h6>
						<div id="returning"></div>
						<div id="pagination" class="tui-pagination"></div>
						<div style="text-align : center">
							<button onclick="orderInsert()">등록</button>
							<button onclick="reset()">초기화</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<script>
		var Grid = tui.Grid;
		
		//페이지가 로드되면 테이블에 데이터가 없을때 뜨는 문구 함수 실행
		document.addEventListener("DOMContentLoaded",()=>{
			OPnodata();
			RTnodata();
		})
		
		// 창고상품조회 쿼리 호출
		const dataSource = {
			api: {
				readData: { url: 'http://localhost:81/bhf/rest/housegoods/list', method: 'GET', initParams: { page: 1 }},
			},
			contentType: 'application/json'
			
		};
		// 창고상품 테이블
		const grid = new Grid({
			el: document.getElementById('housegoods'), // 컨테이너 엘리먼트
			pageOptions: {
				useClient: false,
				perPage: 5,
			},
			columns: [ 
				{ header : "상품코드", name : "goodsCode"},
				{ header : "상품명", name : "goodsName"},
				{ header : "규격", name : "goodsStandard"}
			],
			data: dataSource
		});
		// 상품 테이블 행 선택
		grid.on('click', (ev) => {
			const rowKey = ev.rowKey;  	// 클릭된 행의 키값
			if(rowKey != undefined){	// 행 말고 다른데 클릭해도 이 함수가 실행되서 행의 키값이 있을때만 실행되게 함
				const rowData = grid.getRow(rowKey);  //해당 행의 데이터 가져오기
				const goodsCode = rowData.goodsCode;  //url의 보내기 위해서 변수담기	
				// 옵션조회 쿼리 호출(goodsCode)
			    fetch('http://localhost:81/bhf/rest/houseoption/list?goodsCode=' + goodsCode, {
			        method: 'GET',
			        headers: {
			            'Content-Type': 'application/json'
			        }
			    })
			    .then(response => response.json())
			    .then(data => {
			        grid2.resetData(data.data.contents);  // 옵션 테이블 데이터 업데이트
			    })
			    .catch(error => console.error("데이터 요청 실패:", error));
			}
		});
		// 옵션 테이블
		const grid2 = new Grid({
			el: document.getElementById('option'), 
			pageOptions: {
				useClient: false,
				perPage: 5
			},
			columns: [ 
				{ header : "상품코드", name : "goodsCode"},
				{ header : "옵션코드", name : "optionCode"},
				{ header : "옵션명", name : "optionName"}
			],
			data: "",
		});
		// 옵션 테이블 행 선택
		grid2.on('click', (ev) => {
		    const rowData = grid2.getRow(ev.rowKey); // 해당 행의 데이터 가져오기
	        if (rowData) {
		        const currentData = grid3.getData(); // 기존 데이터 가져오기
		        
		        // 중복 체크(옵션코드가 동일한 행에 이미 있으면 추가하지 않음)
		        const check = currentData.find(item => item.optionCode === rowData.optionCode );
		        if(check){
		        	alert("이미 추가된 옵션입니다.")
		        }else{	        	
		        	grid3.resetData([...currentData, rowData]); // 기존 데이터에 새로운 행 추가하여 발주테이블 업데이트
		        }
		    }
		});
		// 교환,반품 테이블
		const grid3 = new Grid({
			el: document.getElementById('returning'), // 컨테이너 엘리먼트
			pageOptions: {
				useClient: false,
				perPage: 5
			},
			columns: [ 
				{ header : "상품코드", name : "goodsCode"},
				{ header : "상품명", name : "goodsName"},
				{ header : "옵션코드", name : "optionCode"},
				{ header : "옵션명", name : "optionName"},
				{ 
					header : "수량", 
					name : "quantity", 
					editor: 'text',
					onAfterChange: function(ev) { // onAfterChange는 해당 열에 변경이 있을때마다 호출되는 이벤트
		                // ev.value:사용자가 입력한 값, ev.rowkey:변경된 셀이 어떤 행인지 알려주는 키
		                // 값이 숫자만 포함하고 있는지 확인
		                const value = /^[0-9]*$/.test(ev.value); // 숫자만 허용하는 정규식
		                // 숫자가 아닌 값이 들어왔을 때 
		                if (!value) {
		                    grid3.setValue(ev.rowKey, ev.columnName, '');  // 해당 셀을 비웁니다
		                    alert("수량은 숫자만 입력할 수 있습니다.");
		                }
		            }
				},
				{ header : "교환 및 반품", name : "exchangeReturningChoice", editor: 'text'},
				{ header : "사유", name : "returningReason", editor: 'text'}
			],
			data: ""
		});
		
		// 검색 함수
		function search(){
			let goodsName = document.querySelector('#goodsName').value;
			grid.setRequestParams({"goodsName" : goodsName})
			grid.readData();
		}
		
		// 초기화 버튼 함수
		function reset(){
			grid2.resetData([]);
	        grid3.resetData([]);
	     	//테이블 데이터 없을떄 나오는 문구 다시 실행
	        OPnodata();
	        RTnodata();
		}
		
		// 옵션 테이블 데이터 없을때 나오는 문구
		function OPnodata(){
			setTimeout( () => {
				let nodata = document.querySelectorAll('.tui-grid-layer-state-content p')[1];
				nodata.innerHTML = '상품을 선택 해주세요.';
			}, 10)
		}
		// 교환 및 반품 테이블 데이터 없을때 나오는 문구
		function RTnodata(){
			setTimeout( () => {
				let nodata = document.querySelectorAll('.tui-grid-layer-state-content p')[2];
				nodata.innerHTML = '옵션을 선택 해주세요';
			}, 10)
		}
		
	</script>
	
</body>
</html>