<!DOCTYPE html>
<html
        layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:sec=""
>
<body layout:fragment="content">
<div class="row">
  <div class="col-md-12 grid-margin">
    <div class="row">
      <div class="col-12 col-xl-8 mb-4 mb-xl-0">
        <h3 class="font-weight-bold">결재문서</h3>
<!--        <div sec:authorize="isAnonymous()">-->
<!--          로그인 전-->
<!--        </div>-->
        <div sec:authorize="isAuthenticated()">
          환영합니다. <span sec:authentication="name" class="h4"></span>님!
<!--          <p sec:authentication="principal.username"></p>-->
<!--          <p sec:authentication="principal.userDTO.deptName"></p>-->
<!--          <p th:text="${session.deptName}"></p>-->
        </div>
      </div>
<!--      <div class="col-12 col-xl-4">-->
<!--        <div class="justify-content-end d-flex">-->
<!--          <div class="dropdown flex-md-grow-1 flex-xl-grow-0">-->
<!--            <button class="btn btn-sm btn-light bg-white dropdown-toggle" type="button" id="dropdownMenuDate2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">-->
<!--              <i class="mdi mdi-calendar"></i> Today (10 Jan 2021)-->
<!--            </button>-->
<!--            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuDate2">-->
<!--              <a class="dropdown-item" href="#">January - March</a>-->
<!--              <a class="dropdown-item" href="#">March - June</a>-->
<!--              <a class="dropdown-item" href="#">June - August</a>-->
<!--              <a class="dropdown-item" href="#">August - November</a>-->
<!--            </div>-->
<!--          </div>-->
<!--        </div>-->
<!--      </div>-->
    </div>
  </div>
</div>
<div class="row approval">
<!--  <div th:replace="~{mainpage/mainpage :: approval}"></div>-->
<!--  <body>-->
  <div class="container">
    <div class="search-grid">
      <div class="row 1row">
        <div class="col-5 row">
          <label class="label-search col-4" for="inApprovalType">요청 구분</label>
          <select name="inApprovalType" id="inApprovalType" class="col-8 input-box">
            <option value="" selected>선택</option>
            <option value="WAITING">대기</option>
            <option value="APPROVED">승인</option>
            <option value="REJECTED">반려</option>
          </select>
        </div>
      </div>
      <div class="row 2row">
        <div class="col-1"></div>
        <div class="col-5 row ">
          <label class="label-search col-4" for="requester">요청자</label>
          <input type="text" name="requester" id="requester" class="col-8 input-box">
        </div>
        <div class="col-1"></div>
        <div class="col-5 row ">
          <label class="label-search col-4" for="display_amount">표시수량</label>
          <select name="display_amount" id="display_amount" class="col-8 input-box" onchange="changeDisplay()">
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>
      <div class="row 3row">
        <div class="col-4"></div>
        <button type="button" class="btn btn-primary col-1" onclick="search()">검색</button>
        <div class="col-1"></div>
        <button type="button" class="btn btn-secondary col-1" onclick="reset()">초기화</button>
      </div>

    </div>
    <!-- 그리드 -->
    <div id="table-container">
      <div id="grid"></div>
      <div id="pagination" class="tui-pagination"></div>
    </div>
    <!-- 하부 버튼 -->
    <!--		<div class="button-bar row">-->
    <!--			<div class="col-1"></div>-->
    <!--			<button type="button" class="btn btn-primary col-1">Excel</button>-->
    <!--			<button type="button" class="btn btn-secondary col-1">PDF</button>-->
    <!--			<div class="col-7"></div>-->
    <!--			<div class="btn-group dropup col-2">-->
    <!--				<button type="button" class="btn btn-success unpay">미지급금등록</button>-->
    <!--				<button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split" id="dropupMenuSplitButton3" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">-->
    <!--					<span class="sr-only"></span>-->
    <!--				</button>-->
    <!--				<div class="dropdown-menu" aria-labelledby="dropupMenuSplitButton3">-->
    <!--					<h6 class="dropdown-header">채무 등록</h6>-->
    <!--					<a class="dropdown-item" href="#">외상매입금 등록</a>-->
    <!--					<a class="dropdown-item" href="#">대출금 등록</a>-->
    <!--					<div class="dropdown-divider"></div>-->
    <!--					<a class="dropdown-item" href="#">미지급금 등록</a>-->
    <!--				</div>-->
    <!--			</div>-->
    <!--		</div>-->
  </div>


<!--  </body>-->

</div>
<script>

  document.addEventListener("DOMContentLoaded",()=>{
    // grid.readData(1);
  })
  // function gotobtn(){
  // 	document.querySelector(".dropup").addEventListener("click", ()=>{
  // 		if(event.target.className.includes("unpay")){
  // 			console.log("미지급금");
  // 		} else if(event.target.className.includes("dropdown-item")){
  // 			switch (event.target.innerHTML) {
  // 				case "외상매입금 등록":
  // 					console.log("외상매입금")
  // 					break;
  // 				case "대출금 등록":
  // 					console.log("대출금")
  // 					break;
  // 				case "미지급금 등록":
  // 					console.log("미지급금")
  // 					break;
  // 				default:
  // 					break;
  // 			}
  // 		}
  //
  // 	})
  // }

  let Grid = tui.Grid;

  const dataSource = {
    api: {
      readData: { url: 'http://localhost:81/mainpage/rest/approval/list', method: 'GET', initParams: { page: 1 } },
      contentType: 'application/json'
    },
  };

  const grid = new Grid({
            el: document.querySelector('#grid'),
            scrollX: false,
            scrollY: false,
            pageOptions: {
              useClient: false,
              perPage: 5,
            },
            columns: [
              {header: "번호", name: "inApprovalId", sortable: true},
              {header: "요청 구분", name: "documentType", sortable: true},
              {header: "요청자", name: "employeeName", sortable: true},
              {
                header: "결재요청 날짜",
                name: "inApprovalRequestDate",
                sortable: true,
                width: 150,
                formatter: ({value}) => {
                  return formatDateTime(value)
                }
              },
              {
                header: "처리",
                name: "process",
                formatter: ({row}) => {
                  return `
                    <button class="btn btn-approve" data-in-approval-id="${row.inApprovalId}">승인</button>
                    <button class="btn btn-reject" data-in-approval-id="${row.inApprovalId}">반려</button>`
                }
              },
              {
                header: "상태",
                name: "inApprovalStatus",
                sortable: true,
                rowClassName: 'center',
                width: 80,
                hidden: true,
                formatter: ({value}) => {
                  const statusMap = {
                    WAITING: {text: "대기중", color: "gray"},
                    APPROVED: {text: "승인", color: "green"},
                    REJECTED: {text: "거절", color: "red"}
                  };
                  const status = statusMap[value] || {text: "알 수 없음", color: "black"};
                  return `<span class="status-label"
                                style="background-color: ${status.color};
                            ">${status.text}</span>`;
                }
              },
              {header: "요청 내용", name: "inApprovalRequestContent", sortable: true, hidden: true},
              {header: "요청 내용 확인", name: "moveToPage", sortable: true,
              formatter: ({ row }) => {
                return `<button class="move-btn" data-id="${row.inApprovalId}">
                          <i class="mdi mdi-arrow-right-bold"></i>
                        </button>`;
              }
          },
          {
            header: "다운로드",
            name: "download",
        sortable: true,
        formatter: ({ row }) => {
          return `<button class="download-btn" data-content="${row.inApprovalRequestContent}">
              <i class="mdi mdi-folder-download"></i>
            </button>`;
        }
      }

      // { header : "반려 내용", name : "inApprovalRejectedContent",  sortable : true},
      // { header : "승인 파일 주소", name : "inApprovalFilePath",  sortable : true}
    ],
    data : dataSource,
  });

  document.addEventListener("click", function (event) {
    const buttonApprove = event.target.closest(".btn-approve");
    const buttonReject = event.target.closest(".btn-reject");

    if (buttonApprove) {
      const inApprovalId = buttonApprove.dataset.inApprovalId;
      processApproval(inApprovalId, 'approve')
    } else if(buttonReject) {
      const inApprovalId = buttonReject.dataset.inApprovalId;
      processApproval(inApprovalId, 'reject')
    }
  });

  document.addEventListener("click", function (event) {
    const button = event.target.closest(".move-btn");
    if (button) {
      const dataset = button.dataset; // 버튼에서 data-id 값 가져오기
      window.location.href = `/mainpage/approval?inApprovalId=${dataset.id}`;

    }
  });

  document.addEventListener("click", function (event) {
    const button = event.target.closest(".download-btn");
    if (button) {
      const dataset = button.dataset;
      downloadPDF(dataset);
    }
  });

</script>
<script src="/js/mainpage/mainpage.js"></script>

</body>

</html>
