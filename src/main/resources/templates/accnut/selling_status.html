<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<meta charset="UTF-8">
<title>매출 현황</title>
<style>
	.nav-tabs {
	    display: flex;
	    flex-direction: row !important; /* 강제적으로 가로 정렬 */
	    flex-wrap: nowrap; /* 버튼이 줄 바꿈되지 않도록 설정 */
	}
	
	.nav-tabs .nav-link {
	    white-space: nowrap; /* 버튼 내용이 줄바꿈되지 않도록 설정 */
	}
</style>
</head>
<body layout:fragment="content">
	<div class="container">
		<!-- 메뉴이름 -->
		 <div>
			 <h2>매출 현황</h2>
		 </div>

		<!-- 검색창 -->
		<div class="search-grid">
			<!-- 검색창 첫줄 -->
			<div class="row 1row">
				<div class="col-1"></div>
				<!-- 자산명 인풋 -->
				<div class="col-5 row ">
					<span class="label-search col-4">지점</span>
					<select name="officeId" id="officeId" class="col-8 input-box">
						<option value="" selected>전체</option>
						<option value="대구점" >대구점</option>
						<option value="대구중구점" >대구중구점</option>
						<option value="부산점" >부산점</option>
						<option value="서대문점" >서대문점</option>
						<option value="태전동점" >태전동점</option>
						<option value="홍대점" >홍대점</option>

					</select>
				</div>
				<div class="col-1"></div>
				<!-- 구분 인풋 -->
				<div class="col-5 row ">
					<span class="label-search col-4">시작일</span>
					<input type="date" name="startDate" id="startDate" class="col-8 input-box">
				</div>
			</div>
			<!-- 검색창 두번째 줄 -->
			<div class="row 2row">
				<div class="col-1"></div>
				<!-- 금융기관 인풋 -->
				<div class="col-5 row ">
					<span class="label-search col-4">상품</span>
					<input type="text" name="optCode" id="optCode" class="col-8 input-box" data-bs-toggle="modal" data-bs-target="#optSearchModal">
				</div>
				<div class="col-1"></div>
				
				<div class="col-5 row ">
					<span class="label-search col-4">종료일</span>
					<input type="date" name="endDate" id="endDate" class="col-8 input-box">
				</div>
			</div>
			<!-- 검색 버튼 줄 -->
			<div class="row 3row">
				<div class="col-4"></div>
				<button type="button" class="btn btn-primary col-1" onclick="search()">검색</button>
				<div class="col-1"></div>
				<button type="button" class="btn btn-secondary col-1" onclick="reset()">초기화</button>
			</div>
		</div>

		<!--
		-- 차팅그리드
		-->
		<nav class="p-0 m-0 d-flex justify-content-start">
		    <div class="nav nav-tabs" id="nav-tab" role="tablist">
		        <button class="nav-link border active fw-bold" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-fp"
		            type="button" role="tab" aria-controls="#nav-fp" aria-selected="true">지점별 판매 통계</button>
		            
		        <button class="nav-link border" id="nav-profile-tab" data-bs-toggle="tab" data-bs-target="#nav-rg"
		            type="button" role="tab" aria-controls="#nav-rg" aria-selected="false">상품별 판매 통계</button>
		            
		        <button class="nav-link border" id="nav-profile-tab" data-bs-toggle="tab" data-bs-target="#nav-st"
		            type="button" role="tab" aria-controls="#nav-st" aria-selected="false">지점별 일자별 통계(막대)</button>
		            
		        <button class="nav-link border" id="nav-profile-tab" data-bs-toggle="tab" data-bs-target="#nav-sv"
		            type="button" role="tab" aria-controls="#nav-sv" aria-selected="false">상품별 일자별 통계(막대)</button>
		    </div>
		</nav>
		 <div class="tab-content border" id="nav-tabContent" style="background-color: #ffffff;">
            <div class="tab-pane fade show active" id="nav-fp" role="tabpanel" aria-labelledby="nav-fp-tab" tabindex="0">
            	<div id="table-container">
					<div id="chart-area"></div>
				</div>
            </div>
            <div class="tab-pane fade" id="nav-rg" role="tabpanel" aria-labelledby="nav-rg-tab" tabindex="0">
            	<div id="table-container">
					<div id="chart-goods-round"></div>
				</div>
            </div>
            <div class="tab-pane fade" id="nav-st" role="tabpanel" aria-labelledby="nav-rg-tab" tabindex="0">
            	<div id="table-container">
					<div id="chart-point-bar"></div>
				</div>
            </div>
            <div class="tab-pane fade" id="nav-sv" role="tabpanel" aria-labelledby="nav-rg-tab" tabindex="0">
            	<div id="table-container">
					<div id="chart-goods-bar"></div>
				</div>
            </div>
        </div>
<script th:inline="javascript">
	
	var session = sessionData;
	console.log("세션",session);

	function search(){
		let officeId = document.querySelector('#officeId').value;
		let optCode = document.querySelector('#optCode').value;
		let startDate = document.querySelector('#startDate').value;
		let endDate = document.querySelector('#endDate').value;
		
		console.log(startDate);
		console.log(endDate);
		
		let params = {};
		
		params.officeId = officeId;
		params.optionCode = optCode;
		if(startDate != '') params.startDate = startDate;
		if(endDate != '') params.endDate = endDate;
		
		grid.setRequestParams(params);
		//grid.setRequestParams({"officeId" : officeId, "optionCode" : optCode, "startDate" : startDate, "endDate" : endDate , "page" : 1});
		grid.readData();
	}
	
	function reset(){
		let officeId = document.querySelector('#officeId').value = '';
		let optCode = document.querySelector('#optCode').value = '';
		let yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1); // 하루 빼기
        let formattedDate = yesterday.toISOString().split('T')[0]; // YYYY-MM-DD 형식 변환
        document.getElementById("startDate").value = formattedDate;
        document.getElementById("endDate").value = formattedDate;
		grid.setRequestParams({"officeId" : officeId, "optionCode" : optCode });
	}
	
	/*
	* 차팅그리드
	*/
	document.addEventListener("DOMContentLoaded",()=>{
		let yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1); // 하루 빼기
        let formattedDate = yesterday.toISOString().split('T')[0]; // YYYY-MM-DD 형식 변환
        document.getElementById("startDate").value = formattedDate;
        document.getElementById("endDate").value = formattedDate;
        //차트 생성
		charting(formattedDate);
	});
	
	function charting(formattedDate){
		const url = `/accnut/rest/selling/chartinfo?companyNum=${session.companyNum}&startDate=${formattedDate}&endDate=${formattedDate}`;
		console.log(url);
		fetch(`/accnut/rest/selling/chartinfo?companyNum=${session.companyNum}&startDate=2025-03-01`, {
		    method: 'GET',
		    headers: { 'Content-Type': 'application/json' }
		})
		.then(response => response.json())
		.then(responseData  => {
			console.log("API 응답 데이터:", responseData);
			//사용할 객체 배열
			let contents = responseData.data.contents;
			
			//==========================
			// 지점별 판매통계(원형) 차트 생성
			//==========================
			let categories = [...new Set(contents.map(item => item.officeId))];
			let officeTotalPriceMap = {};
			contents.forEach(ele => {
			    let officeId = ele.officeId;
			    let totalPrice = ele.totalPrice || 0;
			    if (officeTotalPriceMap[officeId]) {
			        officeTotalPriceMap[officeId] += totalPrice;
			    } else {
			        officeTotalPriceMap[officeId] = totalPrice;
			    }
			});
			let series = categories.map(officeId => ({
	            name: officeId,
	            data: officeTotalPriceMap[officeId] || 0
	        }));
			console.log("categories:", categories);
			console.log("series:", series);
			renderroundChart(series);
			//==========================
			// 지점별 판매통계(원형) 차트 생성 끝
			//==========================
			
			//==========================
			// 상품별 판매통계(원형) 차트 생성
			//==========================
			let goodsCategories = [...new Set(contents.map(item => item.goodsName))]; // 상품 기준 카테고리
			let goodsTotalPriceMap = {}; // 상품별 totalPrice 저장
			
			contents.forEach(ele => {
			    let goodsName = ele.goodsName; // optionName → goodsName으로 변경
			    let totalPrice = ele.totalPrice || 0;
			    if (goodsTotalPriceMap[goodsName]) {
			        goodsTotalPriceMap[goodsName] += totalPrice;
			    } else {
			        goodsTotalPriceMap[goodsName] = totalPrice;
			    }
			});
			
			// 상품별 판매 통계 데이터 생성
			let goodsSeries = goodsCategories.map(goodsName => ({
			    name: goodsName,
			    data: goodsTotalPriceMap[goodsName] || 0
			}));
			
			console.log("goodsCategories:", goodsCategories);
			console.log("goodsSeries:", goodsSeries);
			optionRoundChart(goodsSeries);
			//==========================
			// 상품별 판매통계(원형) 차트 생성 끝
			//==========================
				
				
			//==========================
			// 기간 및 지점별 판매통계(막대) 차트 생성
			//==========================
			const salesDates = [...new Set(contents.map(item => item.resultDate))]; 
			const branchIds = [...new Set(contents.map(item => item.officeId))]; 
			let branchSalesMap = {};
			branchIds.forEach(branchId => {
			    branchSalesMap[branchId] = Array(salesDates.length).fill(0); // 각 날짜별 초기값 0 설정
			});
			contents.forEach(item => {
			    let dateIndex = salesDates.indexOf(item.resultDate);
			    if (dateIndex !== -1) {
			        branchSalesMap[item.officeId][dateIndex] += item.totalPrice || 0;
			    }
			});
			const branchSeries = branchIds.map(branchId => ({
			    name: branchId,
			    data: branchSalesMap[branchId]
			}));
			const salesData = {
			    categories: salesDates, // resultDate 목록
			    series: branchSeries // officeId별 totalPrice 데이터
			};
			console.log(salesData);
			renderChart(salesDates, branchSeries);
			//==========================
			// 기간 및 지점별 판매통계(막대) 차트 끝
			//==========================
				
			//==========================
			// 기간 및 상품별 판매통계(막대) 차트 생성
			//==========================
			const productSalesDates = [...new Set(contents.map(item => item.resultDate))]; 

			// 상품별(goodsName) 목록 생성
			const productNames = [...new Set(contents.map(item => item.goodsName))]; 
			
			// 상품별 totalPrice를 저장할 객체 초기화
			let productSalesMap = {};
			productNames.forEach(goodsName => {
			    productSalesMap[goodsName] = Array(productSalesDates.length).fill(0); // 각 날짜별 초기값 0 설정
			});
			
			// 데이터 매핑 (resultDate 기준 상품별 매출 합산)
			contents.forEach(item => {
			    let dateIndex = productSalesDates.indexOf(item.resultDate);
			    if (dateIndex !== -1) {
			        productSalesMap[item.goodsName][dateIndex] += item.totalPrice || 0;
			    }
			});
			
			// series 배열 생성 (상품별 데이터)
			const productSeries = productNames.map(goodsName => ({
			    name: goodsName,
			    data: productSalesMap[goodsName]
			}));
			
			// 최종 변환된 데이터
			const productSalesData = {
			    categories: productSalesDates, // resultDate 목록
			    series: productSeries // 상품별 totalPrice 데이터
			};
			
			console.log("상품별 판매 차트 데이터:", productSalesData);
			
			// 상품별 판매 차트 렌더링
			rendergoodsChart(productSalesDates, productSeries);
			//==========================
			// 기간 및 상품별 판매통계(막대) 차트 끝
			//==========================
				//rendergoodsChart

			
		});
		
		// 원형 그래프용 (지점별 판매통계)
		function renderroundChart(series) {
		    console.log("renderroundChart 함수 실행됨:", series);
		    const el = document.getElementById('chart-area');
		    if (!el) {
		        console.error("chart-area 요소를 찾을 수 없습니다!");
		        return;
		    }
		    el.innerHTML = ''; // 기존 차트 제거
		    const data = {
		        series: series // PIE 차트 형식 (label, data 형태)
		    };
		    const options = {
		        chart: { title: '지점별 매출 통계', width: 1250, height: 600 },
		        tooltip: {
		            formatter: (value) => value.toLocaleString() + ' 원' // 툴팁에서 천 단위 쉼표 추가
		        },
		        series: {
		            dataLabels: {
		                visible: true,
		                pieSeriesName: {
		                    visible: true,
		                },
		            },
		        },
		    };
		    toastui.Chart.pieChart({ el, data, options });
		}

		// 원형 그래프용 (상품별 판매통계)
		function optionRoundChart(series) {
		    console.log("optionRoundChart 함수 실행됨:", series);
		    const el = document.getElementById('chart-goods-round');
		    if (!el) {
		        console.error("chart-goods-round 요소를 찾을 수 없습니다!");
		        return;
		    }
		    el.innerHTML = ''; // 기존 차트 제거
		    const data = {
		        series: series // PIE 차트 형식 (label, data 형태)
		    };
		    const options = {
		        chart: { title: '상품별 매출 통계', width: 1250, height: 600 },
		        tooltip: {
		            formatter: (value) => value.toLocaleString() + ' 원' // 툴팁에서 천 단위 쉼표 추가
		        },
		        series: {
		            dataLabels: {
		                visible: true,
		                pieSeriesName: {
		                    visible: true,
		                },
		            },
		        },
		    };
		    toastui.Chart.pieChart({ el, data, options });
		}

		// 막대 그래프용 (기간 및 지점별 판매통계)
		function renderChart(categories, series) {
		    const el = document.getElementById('chart-point-bar');
		    el.innerHTML = ''; // 기존 차트 제거
		    const formattedSeries = series.map(item => ({
		        name: item.name || 'Unknown',  // name이 없는 경우 대비
		        data: Array.isArray(item.data) ? item.data : [] // data가 배열이 아닐 경우 빈 배열로 처리
		    }));
		    const data = {
		        categories: categories, // 날짜 목록 (resultDate)
		        series: formattedSeries // `{ name: string, data: number[] }` 구조 유지
		    };
		    const options = {
		        chart: { title: '일자별 지점 매출 통계', width: 1250, height: 600 },
		        xAxis: { title: '날짜' },
		        yAxis: { title: '매출', tick: { format: value => value.toLocaleString() } }
		    };
		    toastui.Chart.columnChart({ el, data, options });
		}
		
		// 막대 그래프용 (기간 및 상품별 판매통계)
		function rendergoodsChart(categories, series) {
		    const el = document.getElementById('chart-goods-bar');
		    el.innerHTML = ''; // 기존 차트 제거
		    const formattedSeries = series.map(item => ({
		        name: item.name || 'Unknown',  // name이 없는 경우 대비
		        data: Array.isArray(item.data) ? item.data : [] // data가 배열이 아닐 경우 빈 배열로 처리
		    }));
		    const data = {
		        categories: categories, // 날짜 목록 (resultDate)
		        series: formattedSeries // `{ name: string, data: number[] }` 구조 유지
		    };
		    const options = {
		        chart: { title: '일자별 상품 매출 통계', width: 1250, height: 600 },
		        xAxis: { title: '날짜' },
		        yAxis: { title: '매출', tick: { format: value => value.toLocaleString() } }
		    };
		    toastui.Chart.columnChart({ el, data, options });
		}
	}
</script>
	
</body>

</html>