<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}" lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="UTF-8">
<title>ê·¼ë¡œê³„ì•½ ì¡°íšŒ</title>

<!-- âœ… Toast Grid -->
<link rel="stylesheet" href="https://uicdn.toast.com/tui.grid/latest/tui-grid.css">
<script src="https://uicdn.toast.com/tui.grid/latest/tui-grid.js"></script>

<!-- âœ… Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    .custom-swal-popup {
        word-wrap: break-word;
        white-space: pre-line;
        padding: 24px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .btn-sm {
        font-size: 14px;
        padding: 5px 10px;
    }
	.tui-grid-cell {
	    font-size: 16px !important;
	}
</style>
</head>

<body layout:fragment="content">

<div class="container mt-4">
    <h2 class="fw-bold">ê·¼ë¡œê³„ì•½ ì¡°íšŒ</h2>
    <hr>

    <!-- ğŸ” ê²€ìƒ‰ í•„í„° -->
<div class="card p-3 mb-4" style="max-width: 1295px; margin: auto;">
    <div class="row w-100 justify-content-center">
        <!-- ì‚¬ì›ëª… ê²€ìƒ‰ -->
        <div class="col-lg-3 col-md-6 col-sm-12 d-flex flex-column">
            <label class="form-label  ms-3">ì‚¬ì›ëª… ê²€ìƒ‰</label>
            <input type="text" class="form-control mx-auto" id="searchEmployeeName" placeholder="ì‚¬ì›ëª… ì…ë ¥ í›„ [Enter]" style="max-width: 90%;">
        </div>

        <!-- ê³„ì•½ ê¸°ê°„ -->
        <div class="col-lg-3 col-md-6 col-sm-12 d-flex flex-column">
            <label class="form-label  ms-3">ê³„ì•½ ê¸°ê°„</label>
            <div class="d-flex justify-content-center">
                <input type="date" class="form-control me-2 text-center" id="searchStartDate" style="max-width: 45%;">
                <span class="mx-1">~</span>
                <input type="date" class="form-control text-center" id="searchEndDate" style="max-width: 45%;">
            </div>
        </div>

        <!-- ê³„ì•½ ìœ í˜• -->
        <div class="col-lg-3 col-md-6 col-sm-12 d-flex flex-column">
            <label class="form-label ms-3">ê³„ì•½ ìœ í˜•</label>
            <select class="form-select mx-auto" id="searchContractType" style="max-width: 90%;">
                <option value="">ì „ì²´</option>
                <option value="ET001">ì •ê·œì§</option>
                <option value="ET002">ê³„ì•½ì§</option>
            </select>
        </div>

        <!-- ê³„ì•½ ìƒíƒœ -->
        <div class="col-lg-3 col-md-6 col-sm-12 d-flex flex-column">
            <label class="form-label  ms-3">ê³„ì•½ ìƒíƒœ</label>
            <select class="form-select mx-auto" id="searchContractStatus" style="max-width: 90%;">
                <option value="">ì „ì²´</option>
                <option value="CS001">ì§„í–‰ì¤‘</option>
                <option value="CS002">ì¢…ë£Œ</option>
            </select>
        </div>
    </div>

    <!-- ê²€ìƒ‰ ë²„íŠ¼ -->
    <div class="text-center mt-3">
        <button type="button" class="btn btn-primary me-2" onclick="searchContracts()">ê²€ìƒ‰</button>
        <button type="button" class="btn btn-secondary" onclick="resetFilters()">ì´ˆê¸°í™”</button>
    </div>
</div>

	
    <!-- ğŸ“Š ê³„ì•½ ëª©ë¡ -->
    <div id="contractGrid"></div>
    
    <div id="pagination" class="d-flex justify-content-center mt-3"></div>
</div>

<!-- ğŸ“„ ê·¼ë¡œê³„ì•½ì„œ ë³´ê¸° ëª¨ë‹¬ -->
<div class="modal fade" id="contractModal" tabindex="-1" aria-labelledby="contractModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ê·¼ë¡œê³„ì•½ì„œ ë³´ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <iframe id="contractViewer" width="100%" height="500px"></iframe>
            </div>
        </div>
    </div>
</div>

<script>
const header = document.querySelector('meta[name="_csrf_header"]').content;
const token = document.querySelector('meta[name="_csrf"]').content;

// âœ… Toast Grid ì´ˆê¸°í™”
const grid = new tui.Grid({
    el: document.getElementById("contractGrid"),
    scrollX: false,
    scrollY: false,
    pageOptions: {
        useClient: false, // ì„œë²„ ì‚¬ì´ë“œ í˜ì´ì§€ë„¤ì´ì…˜ ì‚¬ìš©
        perPage: 10, // ê¸°ë³¸ í˜ì´ì§€ë‹¹ 10ê°œ í‘œì‹œ
        visiblePages: 5, // í•œ ë²ˆì— í‘œì‹œí•  í˜ì´ì§€ ê°œìˆ˜
    },
    columns: [
        { header: "ê³„ì•½ë²ˆí˜¸", name: "contractNum", align: "center", width: 80 }, 
        { header: "ì‚¬ì›ëª…", name: "employeeName", align: "center", width: 130 },
        { 
            header: "ê³„ì•½ ìœ í˜•", 
            name: "contractType", 
            align: "center", 
            width: 120,
            formatter: ({ value }) => {
                console.log("ğŸ“Œ [DEBUG] contractType ê°’:", value); // ë””ë²„ê¹…ìš© ë¡œê·¸ ì¶”ê°€
                if (value === "ET001") return "ì •ê·œì§";
                if (value === "ET002") return "ê³„ì•½ì§";
                return "ì•Œ ìˆ˜ ì—†ìŒ"; // ì˜ˆì™¸ ì²˜ë¦¬
            }
        },
        { header: "ë¶€ì„œ", name: "departmentName", align: "center", width: 120 },
        { header: "ì§ê¸‰", name: "position", align: "center", width: 120 },
        { header: "ê¸‰ì—¬ (ì›”)", name: "monthlySalary", align: "right", width: 150, 
            formatter: ({ value }) => value.toLocaleString() + " ì›" 
        },
        { header: "ê³„ì•½ ì‹œì‘ì¼", name: "contractStartDate", align: "center", width: 140 },
        { header: "ê³„ì•½ ì¢…ë£Œì¼", name: "contractEndDate", align: "center", width: 140 },
        { header: "ê³„ì•½ ìƒíƒœ", name: "contractStatus", align: "center", width: 120, 
            formatter: ({ value }) => value === "CS001" ? "ğŸŸ¢ ì§„í–‰ì¤‘" : "ğŸ”´ ì¢…ë£Œ" 
        },
        { 
            header: "ê³„ì•½ì„œ", 
            name: "actions", 
            align: "center", 
            width: 180, 
            formatter: function({ row }) {
                return `
                    <button class="btn btn-outline-info btn-sm" onclick="viewContract(${row.employeeNum})">ë³´ê¸°</button>
                    <button class="btn btn-outline-success btn-sm" onclick="downloadContract(${row.employeeNum})">ë‹¤ìš´ë¡œë“œ</button>
                `;
            }
        }
    ]
});


//âœ… ê²€ìƒ‰ ì‹¤í–‰

let currentPage = 1; // í˜„ì¬ í˜ì´ì§€ (ì´ˆê¸°ê°’)
let perPage = grid.getPagination().perPage;

function searchContracts(page = 1) {
    currentPage = page;

    const params = {
        searchType: "employeeName",
        searchKeyword: document.getElementById("searchEmployeeName").value,
        contractStatus: document.getElementById("searchContractStatus").value,
        contractType: document.getElementById("searchContractType").value,
        startDate: document.getElementById("searchStartDate").value,
        endDate: document.getElementById("searchEndDate").value,
        page: page,
        perPage: perPage
    };

    fetch("/hr/rest/contract/search", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": token
        },
        body: JSON.stringify(params)
    })
    .then(response => response.json())
    .then(data => {
        console.log("ğŸ“Š ê³„ì•½ ë°ì´í„°:", data);
        
        if (data.contracts.length > 0) {
            grid.resetData(data.contracts);
            grid.getPagination().setTotalItems(data.totalPages * perPage); // âœ… ì´ í˜ì´ì§€ ë°˜ì˜
            grid.getPagination().movePageTo(page); // âœ… í˜„ì¬ í˜ì´ì§€ë¡œ ì´ë™
        } else {
            grid.resetData([]);
            grid.getPagination().setTotalItems(1); // âœ… ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ë„ í˜ì´ì§€ë„¤ì´ì…˜ ìœ ì§€
            grid.getPagination().movePageTo(1);
        }
    })
    .catch(error => console.error("âŒ ê²€ìƒ‰ ì‹¤íŒ¨:", error));
};

//âœ… í˜ì´ì§€ë„¤ì´ì…˜ ë™ì‘ ì„¤ì •
grid.getPagination().on("beforeMove", function(event) {
    searchContracts(event.page);
});

// âœ… í•„í„° ì´ˆê¸°í™”
function resetFilters() {
    document.getElementById("searchEmployeeName").value = "";
    document.getElementById("searchContractStatus").value = "";
    document.getElementById("searchContractType").value = "";
    document.getElementById("searchStartDate").value = "";
    document.getElementById("searchEndDate").value = "";

    searchContracts();
}

// âœ… ê³„ì•½ì„œ ë³´ê¸°
function viewContract(employeeNum) {
    document.getElementById("contractViewer").src = `/hr/rest/contract/report?employeeNum=${employeeNum}`;
    new bootstrap.Modal(document.getElementById("contractModal")).show();
}

// âœ… ê³„ì•½ì„œ ë‹¤ìš´ë¡œë“œ
function downloadContract(employeeNum) {
    window.location.href = `/hr/rest/contract/report/down?employeeNum=${employeeNum}`;
}

//âœ… Enter í‚¤ë¡œ ê²€ìƒ‰ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ì´ë²¤íŠ¸ ì¶”ê°€
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll("input, select").forEach((input) => {
        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€
                searchContracts(); // ê²€ìƒ‰ ì‹¤í–‰
            }
        });
    });

    searchContracts(); // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ê²€ìƒ‰ ì‹¤í–‰
});

document.getElementById("searchContractType").addEventListener("change", function() {
    let selectedValue = this.value;

    if (selectedValue === "ì •ê·œì§") {
        this.value = "ET001";  // âœ… ì •ê·œì§ ì„ íƒ ì‹œ ì„œë²„ì— ET001ë¡œ ì „ë‹¬
    } else if (selectedValue === "ê³„ì•½ì§") {
        this.value = "ET002";  // âœ… ê³„ì•½ì§ ì„ íƒ ì‹œ ì„œë²„ì— ET002ë¡œ ì „ë‹¬
    }

    console.log("ğŸ“Œ [DEBUG] ë³€ê²½ëœ contractType ê°’:", this.value); // âœ… ë””ë²„ê¹… ì¶”ê°€
});



</script>

</body>
</html>
