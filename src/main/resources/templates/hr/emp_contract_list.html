<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}" lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="UTF-8">
<title>ê·¼ë¡œê³„ì•½ ì¡°íšŒ</title>

<!-- âœ… Toast Grid -->
<link rel="stylesheet" href="https://uicdn.toast.com/tui.grid/latest/tui-grid.css">
<script src="https://uicdn.toast.com/tui.grid/latest/tui-grid.js"></script>

<!-- âœ… Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    .custom-swal-popup {
        word-wrap: break-word;
        white-space: pre-line;
        padding: 24px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .btn-sm {
        font-size: 14px;
        padding: 5px 10px;
    }
</style>
</head>

<body layout:fragment="content">

<div class="container mt-4">
    <h2>ê·¼ë¡œê³„ì•½ ì¡°íšŒ</h2>
    <hr>

    <!-- ğŸ” ê²€ìƒ‰ í•„í„° -->
    <div class="card p-3 mb-4">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">ì‚¬ì›ëª… ê²€ìƒ‰</label>
                <input type="text" class="form-control" id="searchEmployeeName" placeholder="ì‚¬ì›ëª… ì…ë ¥">
            </div>
            <div class="col-md-3">
                <label class="form-label">ê³„ì•½ ìƒíƒœ</label>
                <select class="form-select" id="searchContractStatus">
                    <option value="">ì „ì²´</option>
                    <option value="CS001">ì§„í–‰ì¤‘</option>
                    <option value="CS002">ì¢…ë£Œ</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">ê³„ì•½ ìœ í˜•</label>
                <select class="form-select" id="searchContractType">
                    <option value="">ì „ì²´</option>
                    <option value="ET001">ì •ê·œì§</option>
                    <option value="ET002">ê³„ì•½ì§</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">ê³„ì•½ ê¸°ê°„</label>
                <div class="d-flex">
                    <input type="date" class="form-control me-2" id="searchStartDate">
                    <span class="mx-1">~</span>
                    <input type="date" class="form-control" id="searchEndDate">
                </div>
            </div>
        </div>

        <div class="text-end mt-3">
            <button class="btn btn-primary" onclick="searchContracts()">ğŸ” ê²€ìƒ‰</button>
            <button class="btn btn-secondary" onclick="resetFilters()">âŸ² ì´ˆê¸°í™”</button>
        </div>
    </div>

    <!-- ğŸ“Š ê³„ì•½ ëª©ë¡ -->
    <div id="contractGrid"></div>
</div>

<!-- ğŸ“„ ê·¼ë¡œê³„ì•½ì„œ ë³´ê¸° ëª¨ë‹¬ -->
<div class="modal fade" id="contractModal" tabindex="-1" aria-labelledby="contractModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ê·¼ë¡œê³„ì•½ì„œ ë³´ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <iframe id="contractViewer" width="100%" height="500px"></iframe>
            </div>
        </div>
    </div>
</div>

<script>
const header = document.querySelector('meta[name="_csrf_header"]').content;
const token = document.querySelector('meta[name="_csrf"]').content;

// âœ… Toast Grid ì´ˆê¸°í™”
const grid = new tui.Grid({
    el: document.getElementById("contractGrid"),
    scrollX: false,
    scrollY: true,
    columns: [
        { header: "ê³„ì•½ë²ˆí˜¸", name: "contractNum", align: "center", width: 80 },
        { header: "ì‚¬ì›ëª…", name: "employeeName", align: "center", width: 150 },
        { header: "ê³„ì•½ ìœ í˜•", name: "contractType", align: "center", width: 120 },
        { header: "ê³„ì•½ ì‹œì‘ì¼", name: "contractStartDate", align: "center", width: 120 },
        { header: "ê³„ì•½ ì¢…ë£Œì¼", name: "contractEndDate", align: "center", width: 120 },
        { header: "ê¸‰ì—¬ (ì›”)", name: "monthlySalary", align: "center", width: 120, formatter: ({ value }) => value.toLocaleString() + "ì›" },
        { header: "ê³„ì•½ ìƒíƒœ", name: "contractStatus", align: "center", width: 100, formatter: ({ value }) => value === "CS001" ? "ğŸŸ¢ ì§„í–‰ì¤‘" : "ğŸ”´ ì¢…ë£Œ" },
        { header: "ê³„ì•½ì„œ", name: "contractNum", align: "center", width: 150, 
            formatter: function({ row }) {
                return `
                    <button class="btn btn-info btn-sm" onclick="viewContract(${row.employeeNum})">ë³´ê¸°</button>
                    <button class="btn btn-success btn-sm" onclick="downloadContract(${row.employeeNum})">ë‹¤ìš´ë¡œë“œ</button>
                `;
            }
        }
    ]
});

// âœ… ê²€ìƒ‰ ì‹¤í–‰
function searchContracts() {
    const params = {
        employeeName: document.getElementById("searchEmployeeName").value,
        contractStatus: document.getElementById("searchContractStatus").value,
        contractType: document.getElementById("searchContractType").value,
        startDate: document.getElementById("searchStartDate").value,
        endDate: document.getElementById("searchEndDate").value
    };

    fetch("/hr/rest/search", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": token
        },
        body: JSON.stringify(params)
    })
    .then(response => response.json())
    .then(data => {
        console.log("ğŸ“Š ê³„ì•½ ë°ì´í„°:", data);
        grid.resetData(data);
    })
    .catch(error => console.error("âŒ ê²€ìƒ‰ ì‹¤íŒ¨:", error));
}

// âœ… í•„í„° ì´ˆê¸°í™”
function resetFilters() {
    document.getElementById("searchEmployeeName").value = "";
    document.getElementById("searchContractStatus").value = "";
    document.getElementById("searchContractType").value = "";
    document.getElementById("searchStartDate").value = "";
    document.getElementById("searchEndDate").value = "";

    searchContracts();
}

// âœ… ê³„ì•½ì„œ ë³´ê¸°
function viewContract(employeeNum) {
    document.getElementById("contractViewer").src = `/hr/rest/contract/report?employeeNum=${employeeNum}`;
    new bootstrap.Modal(document.getElementById("contractModal")).show();
}

// âœ… ê³„ì•½ì„œ ë‹¤ìš´ë¡œë“œ
function downloadContract(employeeNum) {
    window.location.href = `/hr/rest/contract/report/down?employeeNum=${employeeNum}`;
}

// âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ê²€ìƒ‰ ì‹¤í–‰
document.addEventListener("DOMContentLoaded", searchContracts);
</script>

</body>
</html>
