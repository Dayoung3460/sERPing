<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}" lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">

    <!-- TOAST UI Library -->
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
    <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style type="text/css">
		.container {
		    max-width: 1400px;
		}
		
    /* âœ… ê²€ìƒ‰ í•„í„° ë°•ìŠ¤ í†µì¼ (í°ìƒ‰ ë°°ê²½ + ê·¸ë¦¼ì ì¶”ê°€) */
    #custom-container {
        background-color: white !important; /* í°ìƒ‰ ë°°ê²½ */
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* ê·¸ë¦¼ì ì¶”ê°€ */
        margin-bottom: 20px;
    }

	.tui-grid-cell {
	    font-size: 16px !important;
	}
    </style>

    <title>ì¸ì‚¬ ë°œë ¹ ê´€ë¦¬</title>
</head>

<body layout:fragment="content">
<div class="container mt-3">
    <h2 class="fw-bold">ì¸ì‚¬ ë°œë ¹ ê´€ë¦¬</h2>
	<hr>
	
    <!-- ğŸ” ì‚¬ì› ê²€ìƒ‰ -->
    <div class="search-box bg-light p-3 rounded shadow-sm" id="custom-container">
        <div class="row align-items-center">
            <div class="col-md-2 text-end"><label class="fw-bold">ì‚¬ì› ê²€ìƒ‰</label></div>
            <div class="col-md-3">
                <select class="form-select" id="employeeSearchCategory">
                    <option value="ì „ì²´">ì „ì²´</option>
                    <option value="employeeName">ì‚¬ì›ëª…</option>
                    <option value="employeeId">ì‚¬ì›ID</option>
                    <option value="phone">ì—°ë½ì²˜</option>
                </select>
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control" id="employeeSearchKeyword" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ í›„ [Enter]">
            </div>
        </div>
        <div class="row mt-2">
            <div class="col text-center">
                <button class="btn btn-primary" id="searchEmployeeBtn">ì¡°íšŒ</button>
                <button class="btn btn-secondary" id="resetBtn">ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <!-- ğŸ”² ì‚¬ì› ëª©ë¡ -->
    <div class="row mt-3">
        <div class="col">
            <h5>ì‚¬ì› ëª©ë¡</h5>
            <div id="employeeGrid"></div>
        </div>
    </div>
    
    <!-- ì¸ì‚¬ ë°œë ¹ ì¶”ê°€ ë²„íŠ¼ -->
    <div class="row mt-3">
        <div class="col text-end">
            <button class="btn btn-success" id="openHistoryModalBtn">ì¸ì‚¬ ë°œë ¹ ë“±ë¡</button>
        </div>
    </div>

    <!-- ì¸ì‚¬ ë°œë ¹ ì´ë ¥ -->
    <div class="row mt-3">
        <div class="col">
            <h5>ì¸ì‚¬ ë°œë ¹ ì´ë ¥</h5>
            <div id="historyGrid"></div>
        </div>
    </div>


</div>

<!-- ì¸ì‚¬ ë°œë ¹ ë“±ë¡ ëª¨ë‹¬ -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì¸ì‚¬ ë°œë ¹ ë“±ë¡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="fw-bold">ëŒ€ìƒ ì‚¬ì›</label>
                    <input type="text" class="form-control" id="modalEmployeeName" readonly>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">ë³€ê²½ ìœ í˜•</label>
                    <select class="form-select" id="modalChangeType">
                        <option value="ì§ê¸‰ ë³€ê²½">ì§ê¸‰ ë³€ê²½</option>
                        <option value="ë¶€ì„œ ì´ë™">ë¶€ì„œ ì´ë™</option>
                        <option value="ê·¼ë¬´ í˜•íƒœ ë³€ê²½">ê·¼ë¬´ í˜•íƒœ ë³€ê²½</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="fw-bold">ìƒˆ ì§ê¸‰</label>
                    <select class="form-select" id="modalNewPosition"></select>
                </div>
                
                <div class="mb-3">
                    <label class="fw-bold">ìƒˆ ë¶€ì„œ</label>
                    <select class="form-select" id="modalNewDepartment"></select>
                </div>
                
                <div class="mb-3">
                    <label class="fw-bold">ë°œë ¹ ì‚¬ìœ </label>
                    <textarea class="form-control" id="modalReason"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="fw-bold">ì ìš©ì¼</label>
                    <input type="date" class="form-control" id="modalEffectiveDate">
                </div>
                
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button class="btn btn-primary" id="saveHistoryBtn">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>


<!-- ğŸ“Œ JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    loadCommonCodes();

    var Grid = tui.Grid;
    let employeeGrid;
    var positionList = [];
    var departmentList = [];
    var employmentTypeList = [];
    var authList = [];

    
    // âœ… ì´ˆê¸° Grid ì„¤ì •
    function initializeEmployeeGrid() {
        const dataSource = {
            api: {
                readData: {
                    url: '/hr/rest/emp/list',
                    method: 'GET',
                    initParams: { page: 1 }
                }
            },
            contentType: 'application/json',
            initialRequest: false, // ìë™ìœ¼ë¡œ ë°ì´í„° ìš”ì²­í•˜ì§€ ì•ŠìŒ
        };

        employeeGrid = new tui.Grid({
            el: document.getElementById('employeeGrid'),
            width: "100%",
            autoWidth: true,
            pageOptions: {
                useClient: false,
                perPage: 5,
            },
            rowHeaders: [{
                type: 'rowNum',
                header: "ìˆœë²ˆ",
                width: 50,
            }],
            rowHeaders: ['checkbox'],
            columns: getUpdatedColumns(), // ì»¬ëŸ¼ ì„¤ì • í•¨ìˆ˜ í˜¸ì¶œ
            data: dataSource,
        });
    }

    // âœ… ê³µí†µ ì½”ë“œ ë¡œë“œ í›„ select ì˜µì…˜ ì—…ë°ì´íŠ¸
    setTimeout(() => {
        // âœ… ì§ê¸‰ ëª©ë¡ ë§¤í•‘
        positionList = positions.map(pos => ({
            text: pos.CMMNNAME,
            value: pos.CMMNCODE
        }));
        
        // âœ… ë¶€ì„œ ëª©ë¡ ë§¤í•‘ (ìˆ˜ì •ë¨)
        departmentList = departments.map(dept => ({
            text: dept.DEPARTMENT_NAME, // í™”ë©´ì— í‘œì‹œí•  ë¶€ì„œëª…
            value: String(dept.DEPARTMENT_NUM)  // ì‹¤ì œ DB ì €ì¥í•  ë¶€ì„œë²ˆí˜¸
        }));
        
        // âœ… ê·¼ë¬´ ìœ í˜• ëª©ë¡ ë§¤í•‘
        employmentTypeList = employmentTypes.map(empt => ({
            text: empt.CMMNNAME, 
            value: empt.CMMNCODE  
        }));
        
        // âœ… ê·¼ë¬´ ìœ í˜• ëª©ë¡ ë§¤í•‘
        authList = auths.map(auth => ({
            text: auth.CMMNNAME, 
            value: auth.CMMNCODE  
        }));
        
        
        console.log("ğŸ“Œ ì§ê¸‰ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:", positionList);
        console.log("ğŸ“Œ ë¶€ì„œ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:", departmentList);
        console.log("ğŸ“Œ ê·¼ë¬´ ìœ í˜• ëª©ë¡ ë¡œë“œ ì™„ë£Œ:", employmentTypeList);
        console.log("ğŸ“Œ ê¶Œí•œ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:", authList);
        
        // âœ… Grid ì»¬ëŸ¼ì„ ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        employeeGrid.setColumns(getUpdatedColumns());
        
        // âœ… ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
        employeeGrid.readData();
    }, 1000);


    
    // âœ… ì»¬ëŸ¼ ë™ì  ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function getUpdatedColumns() {
    	
    	console.log("ğŸ”¥ getUpdatedColumns ì‹¤í–‰ë¨"); // âœ… ì‹¤í–‰ ì—¬ë¶€ í™•ì¸
    	console.log("ğŸ“Œ í˜„ì¬ ì§ê¸‰ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:", positionList);
        console.log("ğŸ“Œ í˜„ì¬ ë¶€ì„œ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:", departmentList);
        console.log("ğŸ“Œ í˜„ì¬ ê·¼ë¬´ ìœ í˜• ëª©ë¡ ë¡œë“œ ì™„ë£Œ:", employmentTypeList);
        console.log("ğŸ“Œ í˜„ì¬ ê¶Œí•œ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:", authList);
    	
        return [
            { header: "ì‚¬ì›ë²ˆí˜¸", name: "employeeId", width: 150, align: 'center' },
            { header: "ì‚¬ì›ëª…", name: "employeeName", width: 150, align: 'center' },
            { header: "ì§ê¸‰", name: "position", width: 110, align: 'center' },
            { header: "ìƒˆ ì§ê¸‰", name: "newPosition", width: 110, align: 'center' },
            {
                header: "ìƒˆ ì§ê¸‰",
                name: "newPosition",
                formatter: positionFormatter,
                align: 'center',
                editor: {
                    type: "select",
                    options: { listItems: positionList}
                }
            },
            { header: "ë¶€ì„œ", name: "departmentName", width: 150, align: 'center' },
            { header: "ìƒˆ ë¶€ì„œ", name: "newDepartment", width: 100, align: 'center' },
            {
                header: "ìƒˆ ë¶€ì„œ",
                name: "newDepartment",
                formatter: departmentFormatter,
                align: 'center',
                editor: {
                    type: "select",
                    options: { listItems: departmentList  }
                }
            },
            { header: "ê·¼ë¬´ ìœ í˜•", name: "employmentType", align: "center", sortable: true, width: 100 },
            { header: "ìƒˆ ê·¼ë¬´ ìœ í˜•", name: "newEmploymentType", align: "center", sortable: true, width: 100 },
            {
                header: "ìƒˆ ê·¼ë¬´ ìœ í˜•",
                name: "newEmploymentType",
                formatter: employmentTypeFormatter,
                align: 'center',
                editor: {
                    type: "select",
                    options: { listItems: employmentTypeList }
                }
            },
            { header: "ê¶Œí•œ", name: "authority", align: "center", sortable: true, width: 100 },
            { header: "ìƒˆ ê¶Œí•œ", name: "newAuthority", width: 100, align: 'center' },
            {
                header: "ìƒˆ ê¶Œí•œ",
                name: "newAuthority",
                formatter: authFormatter,
                align: 'center',
                editor: {
                    type: "select",
                    options: { listItems: authList}
                }
            },
            { header: "ì…ì‚¬ì¼", name: "hireDate", align: "center", sortable: true, width: 150, formatter: ({ value }) => value?.split('T')[0] || '' },
        ];
    }

    // âœ… í¬ì§€ì…˜ Formatter
    function positionFormatter({ value }) {
    	console.log("aa");
        const position = positionList.find(item => item.value === value);
        console.log("ğŸ› ï¸ ë§¤í•‘ëœ ë¶€ì„œ:", position);
        return position ? position.text : value;
    }
    
    // âœ… ë¶€ì„œ Formatter
    function departmentFormatter({ value }) {
    	console.log("bb");
        const department = departmentList.find(item => item.value === String(value));
        console.log("ğŸ› ï¸ ë§¤í•‘ëœ ë¶€ì„œ:", department);
        return department ? department.text : value;
    }
    
    // âœ… ê·¼ë¬´ìš°í˜• Formatter
    function employmentTypeFormatter({ value }) {
    	console.log("cc");
        const employmentType = employmentTypeList.find(item => item.value === value);
        console.log("ğŸ› ï¸ ë§¤í•‘ëœ ë¶€ì„œ:", employmentType);
        return employmentType ? employmentType.text : value;
    }
    
    // âœ… ê·¼ë¬´ìš°í˜• Formatter
    function authFormatter({ value }) {
    	console.log("ddd");
        const auth = authList.find(item => item.value === value);
        console.log("ğŸ› ï¸ ë§¤í•‘ëœ ë¶€ì„œ:", auth);
        return auth ? auth.text : value;
    }



    
    
    initializeEmployeeGrid(); // ì´ˆê¸° Grid ìƒì„±
    
    console.log("ğŸ” employeeGrid ë°ì´í„° í™•ì¸:", employeeGrid.getData());
});
</script>
<script src="/js/hr/common-codes.js"></script>
</body>
</html>
