<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}" lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="UTF-8">
<title>조직도 관리</title>
  <link rel="stylesheet" href="https://uicdn.toast.com/tui.grid/latest/tui-grid.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://uicdn.toast.com/tui.grid/latest/tui-grid.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #f8f9fa;
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .header-section {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    .content-section {
      display: flex;
      gap: 20px;
    }

    .org-chart {
      width: 30%;
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .employee-table {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .department-tree ul {
      list-style: none;
      padding-left: 20px;
    }

    .toggle-btn {
      cursor: pointer;
      margin-right: 5px;
    }

    #grid {
      width: 100%;
      height: 300px;
    }
  </style>
</head>

<body layout:fragment="content">
  <div class="container mt-3">
    <div class="header-section">
      <h5 class="fw-bold">인사 관리 / 조직도 관리</h5>
      <div class="d-flex gap-2">
        <button class="btn btn-primary btn-sm">➕ 부서 추가</button>
        <button class="btn btn-secondary btn-sm" disabled>✏️ 부서 수정</button>
        <button class="btn btn-danger btn-sm">❌ 부서 삭제</button>
      </div>
    </div>

    <div class="content-section">
      <section class="org-chart">
        <input type="text" class="form-control mb-3" placeholder="부서 검색 후 [Enter]">
        <div class="department-tree">
			<ul>
			    <!-- ✅ 회사 정보 -->
			    <li th:data-company-id="${company.companyNum}">
			        <span class="toggle-btn">▶</span> 
			        <span th:text="${company.companyName}"></span> / 
			        <span th:text="${company.companyEngName}"></span> 
			        (<span th:text="${company.totalEmployeeCount}"></span>)
			
			        <ul>
			            <!-- ✅ 본사 & 지점 -->
			            <li th:each="dept : ${departments}" th:if="${dept.parentDepartmentNum == null}" th:data-dept-id="${dept.departmentNum}">
			                <span class="toggle-btn">▶</span> 
			                <span th:text="${dept.departmentName}"></span> 
			                (<span th:text="${dept.totalEmployeeCount}"></span>)
			
			                <ul>
			                    <!-- ✅ 하위 부서 -->
			                    <li th:each="subDept : ${departments}" th:if="${subDept.parentDepartmentNum == dept.departmentNum}" th:data-dept-id="${subDept.departmentNum}">
			                        📄 <span th:text="${subDept.departmentName}"></span> 
			                        (<span th:text="${subDept.totalEmployeeCount}"></span>)
			                    </li>
			                </ul>
			            </li>
			        </ul>
			    </li>
			</ul>
        </div>
      </section>

      <section class="employee-table">
        <h5 class="fw-bold">선택한 부서: 선택한부서이름</h5>
        <input type="text" class="form-control mb-3" placeholder="사원 검색 후 [Enter]">
        <div id="grid"></div>
      </section>
    </div>
  </div>

  <script>
	  $(document).ready(function () {
		    // ✅ 트리 메뉴 토글 버튼
		    $(document).on("click", ".toggle-btn", function () {
		        $(this).siblings("ul").toggle(); // 하위 부서 목록 보이기/숨기기
		        $(this).text($(this).text() === "▶" ? "▼" : "▶"); // 버튼 아이콘 변경
		    });
	
		    // ✅ 부서 클릭 시 직원 정보 가져오기
		    $(document).on("click", ".department-tree li", function () {
		        let departmentNum = $(this).data("dept-id"); // 부서번호 가져오기
		        let isCompany = $(this).hasClass("company-node"); // 회사인지 확인
		        let departmentName = $(this).find("span").first().text().trim(); // 부서명 가져오기
	
		        console.log("📌 선택한 조직 번호:", departmentNum, "회사 여부:", isCompany);
	
		        // ✅ UI 업데이트 (선택한 부서 이름 표시)
		        $(".employee-table h5").text("선택한 부서: " + departmentName);
	
		        // ✅ AJAX 요청으로 직원 목록 가져오기
		        $.ajax({
		            url: isCompany ? `/api/hr/employees/company/${departmentNum}` : `/api/hr/employees/${departmentNum}`,
		            type: "GET",
		            dataType: "json",
		            success: function (data) {
		                console.log("✅ 조회된 사원 목록:", data);
		                grid.resetData(data);
		            },
		            error: function (xhr, status, error) {
		                console.error("🚨 사원 조회 오류:", error);
		            }
		        });
		    });
	
		    // ✅ TUI Grid 초기화
		    const grid = new tui.Grid({
		        el: document.getElementById("grid"),
		        pageOptions: {
		            useClient: true, // ✅ 클라이언트 측 페이지네이션 적용
		            perPage: 5
		        },
		        columns: [
		            { header: "사원 ID", name: "employeeId" },
		            { header: "사원명", name: "employeeName" },
		            { header: "이메일", name: "email" },
		            { header: "직급", name: "position" },
		            { header: "부서", name: "departmentName" }
		        ]
		    });
		});



  </script>
</body>
</html>