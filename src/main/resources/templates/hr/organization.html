<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}" lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="UTF-8">
<title>Ï°∞ÏßÅÎèÑ Í¥ÄÎ¶¨</title>
  <link rel="stylesheet" href="https://uicdn.toast.com/tui.grid/latest/tui-grid.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://uicdn.toast.com/tui.grid/latest/tui-grid.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #f8f9fa;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .header-section {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    .content-section {
      display: flex;
      gap: 20px;
    }
    .org-chart {
      width: 30%;
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .employee-table {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .department-tree ul {
      list-style: none;
      padding-left: 20px;
    }
    .toggle-btn {
      cursor: pointer;
      margin-right: 5px;
    }
    .select-wrapper {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    #grid {
      width: 100%;
      height: 300px;
    }
  </style>
</head>

<body layout:fragment="content">
  <div class="container mt-3">
    <div class="header-section">
      <h5 class="fw-bold">Ïù∏ÏÇ¨ Í¥ÄÎ¶¨ / Ï°∞ÏßÅÎèÑ Í¥ÄÎ¶¨</h5>
      <div class="d-flex gap-2">
        <button class="btn btn-primary btn-sm">‚ûï Î∂ÄÏÑú Ï∂îÍ∞Ä</button>
        <button class="btn btn-secondary btn-sm" disabled>‚úèÔ∏è Î∂ÄÏÑú ÏàòÏ†ï</button>
        <button class="btn btn-danger btn-sm">‚ùå Î∂ÄÏÑú ÏÇ≠Ï†ú</button>
      </div>
    </div>

    <div class="content-section">
      <section class="org-chart">
        <input type="text" class="form-control mb-3" id="deptSearchKW" placeholder="Î∂ÄÏÑú Í≤ÄÏÉâ ÌõÑ [Enter]">
        <div class="department-tree">
            <ul>
                <!-- ‚úÖ ÌöåÏÇ¨ Ï†ïÎ≥¥ -->
                <li th:data-company-id="${company.companyNum}" class="select-item" id="selectCompanySJ">
                    <div class="select-wrapper" id="comClick">
                        <span class="toggle-btn">‚ñº</span> 
                        <span class="select-text" th:text="${company.companyName}" id="selectComKorName"></span> <span> / </span> 
                        <span class="select-text" th:text="${company.companyEngName}" id="selectComEngName"></span> 
                        (<span class="count" th:text="${company.totalEmployeeCount}"></span>)
                    </div>
                    <ul class="sub-list company-sub-list">
                        <!-- ‚úÖ Î≥∏ÏÇ¨ & ÏßÄÏ†ê -->
                        <li th:each="dept : ${departments}" th:if="${dept.parentDepartmentNum == null}" th:data-dept-id="${dept.departmentNum}" class="select-item selectTopDept">
                            <div class="select-wrapper" id="topDeptClick">
                                <span class="toggle-btn">‚ñº</span> 
                                <span class="select-text" th:text="${dept.departmentName}"></span> 
                                (<span class="count" th:text="${dept.totalEmployeeCount}"></span>)
                            </div>
                            <ul class="sub-list">
                                <!-- ‚úÖ ÌïòÏúÑ Î∂ÄÏÑú -->
                                <li th:each="subDept : ${departments}" th:if="${subDept.parentDepartmentNum == dept.departmentNum}" th:data-dept-id="${subDept.departmentNum}" class="select-item selectSubDept">
                                    <div class="select-wrapper" id="subDeptClick">
                                        üìÑ <span class="select-text" th:text="${subDept.departmentName}"></span> 
                                        (<span class="count" th:text="${subDept.totalEmployeeCount}"></span>)
                                    </div>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
      </section>

      <section class="employee-table">
        <h5 class="fw-bold">ÏÇ¨Ïõê Î™©Î°ù</h5>
        <div id="grid"></div>
      </section>
    </div>
  </div>

  <script th:inline="javascript">
  let companyNumSJ = [[${company.companyNum}]];
  let departmentNumSJ = 0;
  
  
  const dataSource = {
	        api: {
	            readData: {
	                url: 'http://localhost:81/hr/rest/emp/organization',
	                method: 'GET',
	                initParams: { companyNum:companyNumSJ , departmentNum:departmentNumSJ  }
	            }
	        },
	        contentType: 'application/json',
	    };

      $(document).ready(function () {
          $(".company-sub-list, .sub-list").show();

          // ‚úÖ Î∂ÄÏÑú Ìä∏Î¶¨ ÌÜ†Í∏Ä Í∏∞Îä•Îßå Ïú†ÏßÄ
          $(document).on("click", ".toggle-btn", function (event) {
              event.stopPropagation();
              let $targetList = $(this).closest("li").children("ul.sub-list");
              $targetList.slideToggle(200);
              $(this).text($(this).text() === "‚ñº" ? "‚ñ∂" : "‚ñº");
          });

          // ‚úÖ Toast Grid Ï¥àÍ∏∞Ìôî (Îç∞Ïù¥ÌÑ∞ ÏóÜÏù¥)
          const grid = new tui.Grid({
              el: document.getElementById("grid"),
              pageOptions: { useClient: false, perPage: 1 }, // ‚úÖ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Î™®Îìú
              data: dataSource,
              columns: [
                  { header: "ÏÇ¨Ïõê ID", name: "employeeId" },
                  { header: "ÏÇ¨ÏõêÎ™Ö", name: "employeeName" },
                  { header: "Ïù¥Î©îÏùº", name: "email" },
                  { header: "ÏßÅÍ∏â", name: "position" },
                  { header: "Î∂ÄÏÑú", name: "departmentName" }
              ]
          });

          
          
          
          $(document).on('click', '.department-tree [data-company-id], .department-tree [data-dept-id]', function(event) {
        	    event.stopPropagation(); // Î∂ÄÎ™® ÏöîÏÜåÎ°ú Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Î∞©ÏßÄ

        	    let companyId = $(this).data('company-id'); // `data-company-id` Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
        	    let departmentId = $(this).data('dept-id'); // `data-dept-id` Í∞í Í∞ÄÏ†∏Ïò§Í∏∞

        	    if (companyId !== undefined) {
        	        
        	        departmentNumSJ=0;
        	        fetch(`/hr/rest/emp/organization?perPage=5&companyNum=${companyNumSJ}&departmentNum=${departmentNumSJ}&page=1`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        grid.resetData(data.data.contents);  // ÏòµÏÖò ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                        console.log(data);
                    })
                    .catch(error => console.error("Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠ Ïã§Ìå®:", error));
        	        
        	        
        	        
        	    } else if (departmentId !== undefined) {
        	        departmentNumSJ = departmentId;
                 //http://localhost:81/hr/rest/emp/organization?perPage=5&companyNum=1&departmentNum=0&page=1
                //http://localhost:81/hr/rest/emp/organization??perPage=5&companyNum=${companyNumSJ}&departmentNum=${departmentNumSJ}&page=1
        	     // ÏòµÏÖòÏ°∞Ìöå ÏøºÎ¶¨ Ìò∏Ï∂ú(goodsCode)
                    fetch(`/hr/rest/emp/organization?perPage=5&companyNum=${companyNumSJ}&departmentNum=${departmentNumSJ}&page=1`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        grid.resetData(data.data.contents);  // ÏòµÏÖò ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                        console.log(data);
                    })
                    .catch(error => console.error("Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠ Ïã§Ìå®:", error));
        	        
        	    }
        	});
      });
      



      
  </script>
</body>
</html>
