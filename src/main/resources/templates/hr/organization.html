<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}" lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="UTF-8">
<title>Ï°∞ÏßÅÎèÑ Í¥ÄÎ¶¨</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #f8f9fa;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .header-section {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    .content-section {
      display: flex;
      gap: 20px;
    }
    .org-chart {
      width: 30%;
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .employee-table {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .department-tree ul {
      list-style: none;
      padding-left: 20px;
    }
    .toggle-btn {
      cursor: pointer;
      margin-right: 5px;
    }
    .select-wrapper {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    #grid {
      width: 100%;
      height: 300px;
    }
  </style>
</head>

<body layout:fragment="content">

  <div class="container mt-3">
    <div class="header-section">
      <h5 class="fw-bold">Ïù∏ÏÇ¨ Í¥ÄÎ¶¨ / Ï°∞ÏßÅÎèÑ Í¥ÄÎ¶¨</h5>
      <div class="d-flex gap-2">
        <button class="btn btn-primary"><i class="fas fa-plus-circle"></i> Î∂ÄÏÑú Ï∂îÍ∞Ä</button>
        <button class="btn btn-secondary" disabled><i class="fas fa-pencil-alt"></i>Î∂ÄÏÑú ÏàòÏ†ï</button>
        <button class="btn btn-danger"><i class="fas fa-trash"></i>Î∂ÄÏÑú ÏÇ≠Ï†ú</button>
      </div>
    </div>

    <div class="content-section">
      <section class="org-chart">
        <input type="text" class="form-control mb-3" id="deptSearchKW" placeholder="Î∂ÄÏÑú Í≤ÄÏÉâ ÌõÑ [Enter]">
        <div class="department-tree">
            <ul>
                <!-- ÌöåÏÇ¨ Ï†ïÎ≥¥ -->
                <li th:data-company-id="${company.companyNum}" class="select-item" id="selectCompanySJ">
                    <div class="select-wrapper" id="comClick">
                        <span class="toggle-btn">‚ñº</span> 
                        <span class="select-text" th:text="${company.companyName}" id="selectComKorName"></span> <span> / </span> 
                        <span class="select-text" th:text="${company.companyEngName}" id="selectComEngName"></span> 
                        (<span class="count" th:text="${company.totalEmployeeCount}"></span>)
                    </div>
                    <ul class="sub-list company-sub-list">
                        <!-- Î≥∏ÏÇ¨ & ÏßÄÏ†ê -->
                        <li th:each="dept : ${departments}" th:if="${dept.parentDepartmentNum == null}" th:data-dept-id="${dept.departmentNum}" class="select-item selectTopDept">
                            <div class="select-wrapper" id="topDeptClick">
                                <span class="toggle-btn">‚ñº</span> 
                                <span class="select-text" th:text="${dept.departmentName}"></span> 
                                (<span class="count" th:text="${dept.totalEmployeeCount}"></span>)
                            </div>
                            <ul class="sub-list">
                                <!-- ÌïòÏúÑ Î∂ÄÏÑú -->
                                <li th:each="subDept : ${departments}" th:if="${subDept.parentDepartmentNum == dept.departmentNum}" th:data-dept-id="${subDept.departmentNum}" class="select-item selectSubDept">
                                    <div class="select-wrapper" id="subDeptClick">
                                        üìÑ <span class="select-text" th:text="${subDept.departmentName}"></span> 
                                        (<span class="count" th:text="${subDept.totalEmployeeCount}"></span>)
                                    </div>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
      </section>

      <section class="employee-table">
        <h5 class="fw-bold">ÏÇ¨Ïõê Î™©Î°ù</h5>
        <div id="grid"></div>
      </section>
    </div>
    
    
    <!-- ÏÇ¨Ïõê Ï†ïÎ≥¥ / Ïù∏ÏÇ¨ Î∞úÎ†π Î™®Îã¨ -->
<div class="modal fade" id="employeeModal" tabindex="-1" aria-labelledby="employeeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <!-- Î™®Îã¨ Ìó§Îçî -->
      <div class="modal-header">
        <h5 class="modal-title" id="employeeModalLabel">ÏÇ¨Ïõê Ï†ïÎ≥¥</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Î™®Îã¨ Î∞îÎîî -->
      <div class="modal-body">
        <div class="row">
          <!-- ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ -->
          <div class="col-md-3 text-center">
            <img src="https://via.placeholder.com/150" class="profile-image" id="modalProfileImage" alt="ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ">
          </div>

          <!-- ÏÇ¨Ïõê Ï†ïÎ≥¥ -->
          <div class="col-md-9">
            <div class="row mb-2">
              <label class="col-md-4 fw-bold">ÏÇ¨ÏõêÎ≤àÌò∏</label>
              <div class="col-md-8">
                <input type="text" class="form-control" id="modalEmployeeId" readonly>
              </div>
            </div>

            <div class="row mb-2">
              <label class="col-md-4 fw-bold">ÏÇ¨ÏõêÎ™Ö</label>
              <div class="col-md-8">
                <input type="text" class="form-control" id="modalEmployeeName" readonly>
              </div>
            </div>

            <div class="row mb-2">
              <label class="col-md-4 fw-bold">ÏßÅÍ∏â</label>
              <div class="col-md-8">
                <input type="text" class="form-control" id="modalPosition" readonly>
              </div>
            </div>

            <div class="row mb-2">
              <label class="col-md-4 fw-bold">Î∂ÄÏÑú</label>
              <div class="col-md-8">
                <input type="text" class="form-control" id="modalDepartment" readonly>
              </div>
            </div>

            <div class="row mb-2">
              <label class="col-md-4 fw-bold">ÏûÖÏÇ¨Ïùº</label>
              <div class="col-md-8">
                <input type="date" class="form-control" id="modalHireDate" readonly>
              </div>
            </div>

            <div class="row mb-2">
              <label class="col-md-4 fw-bold">Ïó∞ÎùΩÏ≤ò</label>
              <div class="col-md-8">
                <input type="text" class="form-control" id="modalPhone" readonly>
              </div>
            </div>

            <div class="row mb-2">
              <label class="col-md-4 fw-bold">Ïù¥Î©îÏùº</label>
              <div class="col-md-8">
                <input type="email" class="form-control" id="modalEmail" readonly>
              </div>
            </div>

            <!-- Ïù∏ÏÇ¨ Î∞úÎ†π Ïãú Î≥¥Ïùº Î∂ÄÎ∂Ñ (Ïà®ÍπÄ Ï≤òÎ¶¨) -->
            <div id="transferFields" style="display: none;">
              <hr>
              <div class="row mb-2">
                <label class="col-md-4 fw-bold">Ïù¥Ï†Ñ ÏßÅÍ∏â</label>
                <div class="col-md-8">
                  <input type="text" class="form-control" id="modalOldPosition" readonly>
                </div>
              </div>

              <div class="row mb-2">
                <label class="col-md-4 fw-bold">Ïù¥Ï†Ñ Î∂ÄÏÑú</label>
                <div class="col-md-8">
                  <input type="text" class="form-control" id="modalOldDepartment" readonly>
                </div>
              </div>

              <div class="row mb-2">
                <label class="col-md-4 fw-bold">Î∞úÎ†π ÏßÅÍ∏â</label>
                <div class="col-md-8">
                  <select class="form-select" id="modalNewPosition"></select>
                </div>
              </div>

              <div class="row mb-2">
                <label class="col-md-4 fw-bold">Î∞úÎ†π Î∂ÄÏÑú</label>
                <div class="col-md-8">
                  <select class="form-select" id="modalNewDepartment"></select>
                </div>
              </div>

              <div class="row mb-2">
                <label class="col-md-4 fw-bold">Î∞úÎ†π ÏÇ¨Ïú†</label>
                <div class="col-md-8">
                  <textarea class="form-control" id="modalReason" rows="2"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Î™®Îã¨ Ìë∏ÌÑ∞ -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
        <button type="button" class="btn btn-warning" id="transferBtn" style="display: none;">Ïù∏ÏÇ¨ Î∞úÎ†π</button>
        <button type="button" class="btn btn-primary" id="saveBtn" style="display: none;">Ï†ÄÏû•</button>
      </div>
    </div>
  </div>
</div>
    
  </div>

  <script th:inline="javascript">
  let companyNumSJ = /*[[${company.companyNum}]]*/ null;
  let departmentNumSJ = 0;
  
  
  const dataSource = {
	        api: {
	            readData: {
	                url: 'http://localhost:81/hr/rest/emp/organization',
	                method: 'GET',
	                initParams: { companyNum:companyNumSJ , departmentNum:departmentNumSJ  }
	            }
	        },
	        contentType: 'application/json',
	    };
  
  
  // Î™®Îã¨ Ïó¥Í∏∞ Ìï®Ïàò (Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Ï†ïÏùò)
  function openEmployeeModal(mode, data) {
    $("#employeeModalLabel").text(mode === "transfer" ? "Ïù∏ÏÇ¨ Î∞úÎ†π" : "ÏÇ¨Ïõê Ï†ïÎ≥¥");

    $("#modalEmployeeId").val(data.employeeId);
    $("#modalEmployeeName").val(data.employeeName);
    $("#modalPosition").val(data.position);
    $("#modalDepartment").val(data.departmentName);
    $("#modalHireDate").val(data.hireDate);
    $("#modalPhone").val(data.phone);
    $("#modalEmail").val(data.email);
    $("#modalProfileImage").attr("src", data.profileImage || "https://via.placeholder.com/150");

    if (mode === "transfer") {
      $("#transferFields").show();
      $("#transferBtn").show();
      $("#saveBtn").hide();
    } else {
      $("#transferFields").hide();
      $("#transferBtn").hide();
      $("#saveBtn").show();
    }

    $("#employeeModal").modal('show');
  }

      $(document).ready(function () {
          $(".company-sub-list, .sub-list").show();

          // Î∂ÄÏÑú Ìä∏Î¶¨ ÌÜ†Í∏Ä Í∏∞Îä•Îßå Ïú†ÏßÄ
          $(document).on("click", ".toggle-btn", function (event) {
              event.stopPropagation();
              let $targetList = $(this).closest("li").children("ul.sub-list");
              $targetList.slideToggle(200);
              $(this).text($(this).text() === "‚ñº" ? "‚ñ∂" : "‚ñº");
          });

          // Toast Grid Ï¥àÍ∏∞Ìôî (Îç∞Ïù¥ÌÑ∞ ÏóÜÏù¥)
          const grid = new tui.Grid({
              el: document.getElementById("grid"),
              pageOptions: { useClient: false, perPage: 5 },
              data: dataSource,
              columns: [
                  { header: "ÏÇ¨Ïõê ID", name: "employeeId" },
                  { header: "ÏÇ¨ÏõêÎ™Ö", name: "employeeName" },
                  { header: "Ïù¥Î©îÏùº", name: "email" },
                  { header: "ÏßÅÍ∏â", name: "position" },
                  { header: "Î∂ÄÏÑú", name: "departmentName" }
              ]
          });

          
          // Toast Grid ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (Î™®Îã¨ Ïó¥Í∏∞)
          grid.on('click', function(ev) {
            if (ev.rowKey !== null) {
              let rowData = grid.getRow(ev.rowKey); // ÏÑ†ÌÉùÌïú ÌñâÏùò Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
              openEmployeeModal("view", rowData);
            }
          });

          
          
       // Î∂ÄÏÑú ÏÑ†ÌÉù Ïãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
          $(document).on('click', '.department-tree [data-company-id], .department-tree [data-dept-id]', function(event) {
        	    event.stopPropagation(); // Î∂ÄÎ™® ÏöîÏÜåÎ°ú Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Î∞©ÏßÄ

        	    let companyId = $(this).data('company-id'); // `data-company-id` Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
        	    let departmentId = $(this).data('dept-id'); // `data-dept-id` Í∞í Í∞ÄÏ†∏Ïò§Í∏∞

        	    if (companyId !== undefined) {
        	        
        	        departmentNumSJ=0;
        	        fetch(`/hr/rest/emp/organization?perPage=5&companyNum=${companyNumSJ}&departmentNum=${departmentNumSJ}&page=1`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        grid.resetData(data.data.contents);  // ÏòµÏÖò ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                        console.log(data);
                    })
                    .catch(error => console.error("Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠ Ïã§Ìå®:", error));
        	        
        	        
        	        
        	    } else if (departmentId !== undefined) {
        	        departmentNumSJ = departmentId;
                 //http://localhost:81/hr/rest/emp/organization?perPage=5&companyNum=1&departmentNum=0&page=1
                //http://localhost:81/hr/rest/emp/organization??perPage=5&companyNum=${companyNumSJ}&departmentNum=${departmentNumSJ}&page=1
        	     // ÏòµÏÖòÏ°∞Ìöå ÏøºÎ¶¨ Ìò∏Ï∂ú(goodsCode)
                    fetch(`/hr/rest/emp/organization?perPage=5&companyNum=${companyNumSJ}&departmentNum=${departmentNumSJ}&page=1`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        grid.resetData(data.data.contents);  // ÏòµÏÖò ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                        console.log(data);
                    })
                    .catch(error => console.error("Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠ Ïã§Ìå®:", error));
        	        
        	    }
        	});
      });
      
      
      



      
  </script>
  
  <!-- ‚úÖ Î∂ÄÏÑú Ï∂îÍ∞Ä Î™®Îã¨ -->
<div class="modal fade" id="deptModal" tabindex="-1" aria-labelledby="deptModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Î™®Îã¨ Ìó§Îçî -->
      <div class="modal-header">
        <h5 class="modal-title" id="deptModalLabel">Î∂ÄÏÑú Ï∂îÍ∞Ä</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Î™®Îã¨ Î∞îÎîî -->
      <div class="modal-body">
        <form id="deptForm">
          <div class="mb-3">
            <label class="fw-bold">Î∂ÄÏÑúÎ™Ö</label>
            <input type="text" class="form-control" id="deptName" required>
          </div>

          <div class="mb-3">
            <label class="fw-bold">ÏÉÅÏúÑ Î∂ÄÏÑú</label>
            <select class="form-select" id="parentDept">
              <option value="">ÏµúÏÉÅÏúÑ Î∂ÄÏÑú</option>
              <!-- ÏÉÅÏúÑ Î∂ÄÏÑú Î™©Î°ùÏùÄ JavaScriptÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú Ï±ÑÏö¥Îã§ -->
            </select>
          </div>
        </form>
      </div>

      <!-- Î™®Îã¨ Ìë∏ÌÑ∞ -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
        <button type="button" class="btn btn-primary" id="saveDeptBtn">Ï†ÄÏû•</button>
      </div>
    </div>
  </div>
</div>
  
  
</body>
</html>
