<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}" lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="UTF-8">
<title>근로계약관리</title>
  <link rel="stylesheet" href="https://uicdn.toast.com/tui.grid/latest/tui-grid.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://uicdn.toast.com/tui.grid/latest/tui-grid.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body layout:fragment="content">

<div class="container mt-4">
    <h2 class="mb-4">근로계약 등록</h2>

    <form id="contractForm">
        <!-- 📌 (1) 기본 정보 -->
        <div class="card mb-4">
            <div class="card-header">📌 기본 정보</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">회사명</label>
                        <input type="text" class="form-control" id="companyName" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">회사번호</label>
                        <input type="number" class="form-control" id="companyNum" readonly>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">사원 번호</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="employeeNum" required readonly>
                            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#employeeSelectModal">사원 선택</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">사원명</label>
                        <input type="text" class="form-control" id="employeeName" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- 📌 (2) 근로 조건 -->
        <div class="card mb-4">
            <div class="card-header">📌 근로 조건</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">계약 유형</label>
						<select class="form-select" id="contractType">
						    <option value="ET001">정규직</option>
						    <option value="ET002">계약직</option>
						</select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">계약 기간 (기간제일 경우 입력)</label>
                        <div class="d-flex">
                            <input type="date" class="form-control" id="contractStartDate" required>
                            <span class="mx-2">~</span>
                            <input type="date" class="form-control" id="contractEndDate">
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">근무지</label>
                        <input type="text" class="form-control" id="workLocation" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">업무 내용</label>
                        <input type="text" class="form-control" id="jobDescription" required>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">근무 시간</label>
                        <div class="d-flex">
                            <input type="time" class="form-control" id="workStartTime" value="09:00">
                            <span class="mx-2">~</span>
                            <input type="time" class="form-control" id="workEndTime" value="18:00">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">휴게 시간</label>
                        <div class="d-flex">
                            <input type="time" class="form-control" id="breakStartTime">
                            <span class="mx-2">~</span>
                            <input type="time" class="form-control" id="breakEndTime">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 📌 (3) 급여 정보 -->
        <div class="card mb-4">
            <div class="card-header">📌 급여 정보 (연봉제 기준)</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">연봉 (원)</label>
                        <input type="number" class="form-control" id="annualSalary" required oninput="calculateMonthlySalary()">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">월 기본급 (자동 계산)</label>
                        <input type="text" class="form-control" id="monthlyBaseSalary" readonly>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">상여금</label>
                        <input type="number" class="form-control" id="bonus" value="0">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">기타 수당</label>
                        <input type="number" class="form-control" id="additionalPay" value="0">
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">급여 지급일</label>
                        <input type="number" class="form-control" id="salaryPaymentDate" required placeholder="매월 몇 일">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">급여 지급 방식</label>
                        <select class="form-select" id="salaryPaymentMethod">
                            <option value="BANK">계좌이체</option>
                            <option value="CASH">직접지급</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-primary w-100" onclick="submitContract()">📄 계약 등록</button>
    </form>
</div>

<!-- 사원 선택 모달 -->
<div class="modal fade" id="employeeSelectModal" tabindex="-1" aria-labelledby="employeeSelectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">사원 선택</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 🔍 검색 필터 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchKeyword" placeholder="사원명 검색">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary" onclick="loadEmployees()" id="searchButton">검색</button>
                    </div>
                </div>

                <!-- 🔽 사원 리스트 (Toast Grid) -->
                <div id="employeeGrid"></div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    let companyNum = /*[[${session.companyNum}]]*/ null; 
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
	
    // ✅ 테스트용 변수 설정
    let testContractData = {
        employeeNum: "49",
        companyNum: "1",
        departmentNum: "101",  // ✅ 부서 번호 추가 (예시: IT 부서)
        position: "PO001",      // ✅ 직급 추가 (예시: 주임)
        contractType: "ET002",
        contractStartDate: "2025-02-25",
        contractEndDate: "2025-02-26",
        workLocation: "본사 - IT팀",
        jobDescription: "백엔드 개발 업무 수행",
        workStartTime: "09:00",
        workEndTime: "18:00",
        breakStartTime: "15:46",
        breakEndTime: "15:47",
        annualSalary: "40000000",
        bonus: "0",
        additionalPay: "0",
        salaryPaymentDate: "25",
        paymentMethod: "BANK"
    };

    // ✅ 테스트 버튼 추가
    let testButton = document.createElement("button");
    testButton.textContent = "📋 테스트 계약 등록";
    testButton.className = "btn btn-warning w-100 mt-3";
    testButton.onclick = function() {
        console.log("📋 테스트 데이터 전송:", testContractData);

        fetch("/hr/rest/contract/register", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(testContractData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("✅ 테스트 계약 등록 성공!");
                window.location.reload();
            } else {
                alert("❌ 테스트 계약 등록 실패: " + data.message);
            }
        })
        .catch(error => {
            console.error("❌ 테스트 계약 등록 오류:", error);
            alert("서버 오류로 인해 테스트 계약을 등록할 수 없습니다.");
        });
    };

    // 버튼을 폼 아래 추가
    document.getElementById("contractForm").appendChild(testButton);
	

    // ✅ Toast Grid 설정 (사원 목록)
    const grid = new tui.Grid({
        el: document.getElementById('employeeGrid'),
        scrollX: false,
        scrollY: false,
        columns: [
            { header: "사원번호", name: "employeeNum", align: "center" },
            { header: "이름", name: "employeeName", align: "center" },
            { header: "부서명", name: "departmentName", align: "center" },
            { header: "부서번호", name: "departmentNum", align: "center" },
            { header: "직급", name: "position", align: "center" },
            { header: "회사번호", name: "companyNum", align: "center" },
            { header: "회사명", name: "companyName", align: "center" }
        ]
    });

    // ✅ 모달이 열릴 때 자동으로 사원 목록 불러오기
    document.getElementById("employeeSelectModal").addEventListener("shown.bs.modal", function () {
        loadEmployees();
        grid.refreshLayout(); // ✅ 그리드가 모달 내에서 안 보이는 문제 해결
    });

    // ✅ 검색 버튼 클릭 시 실행
    document.getElementById("searchButton").addEventListener("click", function() {
        loadEmployees();
    });

    // ✅ 엔터키 입력 시 검색 실행
    document.getElementById("searchKeyword").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            loadEmployees();
        }
    });

    // ✅ 사원 목록 불러오기 (검색 포함)
    function loadEmployees() {
        let searchKeyword = document.getElementById("searchKeyword").value; // 검색어 가져오기

        if (!companyNum) {
            alert("회사 번호가 없습니다. 다시 확인해주세요.");
            return;
        }

        // ✅ API 요청
        fetch(`/hr/rest/emp/list-by-company?companyNum=${companyNum}&searchKeyword=${searchKeyword}`)
            .then(response => response.json())
            .then(data => {
                console.log("📊 사원 목록 데이터:", data);

                if (data.employees && data.employees.length > 0) {
                    grid.resetData(data.employees); // Toast Grid에 데이터 넣기
                } else {
                    alert("⚠️ 검색 결과가 없습니다.");
                    grid.resetData([]); // 결과 없을 경우 빈 배열 처리
                }
            })
            .catch(error => {
                console.error("❌ 사원 목록 불러오기 실패:", error);
                alert("사원 목록을 불러오는 데 실패했습니다.");
            });
    }

    let selectedEmployee = {}; // ✅ 전역 변수 추가 (선택된 사원 정보 저장)
    
    grid.on('click', function(ev) {
        const rowData = grid.getRow(ev.rowKey);

        if (!rowData) {
            alert("⚠️ 데이터를 가져올 수 없습니다.");
            return;
        }
        
        // ✅ 데이터 확인 로그
        console.log("📊 선택된 사원 데이터:", rowData);

        selectedEmployee = { 
                employeeNum: rowData.employeeNum, 
                departmentNum: rowData.departmentNum || null,  // ✅ 사원 정보에서 부서번호 가져오기
                position: rowData.position || null,  // ✅ 사원 정보에서 직급 가져오기
                companyNum: rowData.companyNum,
                companyName: rowData.companyName,
                employeeName: rowData.employeeName
            };

        document.getElementById("employeeNum").value = rowData.employeeNum;
        document.getElementById("employeeName").value = rowData.employeeName;
        document.getElementById("companyName").value = rowData.companyName;
        document.getElementById("companyNum").value = rowData.companyNum;

        // ✅ 계약 유형 자동 선택
        document.getElementById("contractType").value = rowData.employmentTypeCode;  

        let workLocation = rowData.parentDepartmentName ? `${rowData.parentDepartmentName} - ${rowData.departmentName}` : rowData.departmentName;
        document.getElementById("workLocation").value = workLocation;

        // ✅ 모달 닫기
        setTimeout(function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById("employeeSelectModal"));
            if (modal) {
                modal.hide();
            }
        }, 100);
    });
});

function submitContract() {
    let contractData = {
        employeeNum: document.getElementById("employeeNum").value,
        companyNum: document.getElementById("companyNum").value,
        departmentNum: selectedEmployee.departmentNum || null, // ✅ 전역 변수에서 가져오기
        position: selectedEmployee.position || null, // ✅ 전역 변수에서 가져오기
        contractType: document.getElementById("contractType").value,
        contractStartDate: document.getElementById("contractStartDate").value,
        contractEndDate: document.getElementById("contractEndDate").value,
        workLocation: document.getElementById("workLocation").value,
        jobDescription: document.getElementById("jobDescription").value,
        workStartTime: document.getElementById("workStartTime").value,
        workEndTime: document.getElementById("workEndTime").value,
        breakStartTime: document.getElementById("breakStartTime").value,
        breakEndTime: document.getElementById("breakEndTime").value,
        annualSalary: document.getElementById("annualSalary").value,
        bonus: document.getElementById("bonus").value,
        additionalPay: document.getElementById("additionalPay").value,
        salaryPaymentDate: document.getElementById("salaryPaymentDate").value,
        paymentMethod: document.getElementById("salaryPaymentMethod").value
    };

    console.log("📋 계약 등록 데이터:", contractData);

    // ✅ 유효성 검사 (필수 필드 체크)
    if (!contractData.employeeNum || !contractData.companyNum || !contractData.contractStartDate || !contractData.annualSalary) {
        alert("⚠️ 필수 정보를 입력해주세요.");
        return;
    }

    // ✅ AJAX 요청 (근로계약 + 급여 등록 API 호출)
    fetch(`http://localhost:81/hr/rest/contract/register`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(contractData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("✅ 근로계약이 성공적으로 등록되었습니다!");
            window.location.reload(); // 페이지 새로고침
        } else {
            alert("❌ 계약 등록 실패: " + data.message);
        }
    })
    .catch(error => {
        console.error("❌ 계약 등록 오류:", error);
        alert("서버 오류로 인해 계약을 등록할 수 없습니다.");
    });
}

</script>


</body>
</html>
