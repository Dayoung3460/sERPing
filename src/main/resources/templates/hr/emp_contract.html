<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}" lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="UTF-8">
<title>ê·¼ë¡œê³„ì•½ê´€ë¦¬</title>
  <link rel="stylesheet" href="https://uicdn.toast.com/tui.grid/latest/tui-grid.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://uicdn.toast.com/tui.grid/latest/tui-grid.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
		.custom-swal-popup {
		    word-wrap: break-word;  /* ê¸´ ë¬¸ì¥ ìë™ ì¤„ë°”ê¿ˆ */
		    white-space: pre-line;  /* \në„ ì¤„ë°”ê¿ˆ ì ìš© */
		    padding: 24px;          /* ì ë‹¹í•œ íŒ¨ë”© */
		    max-height: 80vh;       /* ë‚´ìš©ì´ ë§ìœ¼ë©´ ìŠ¤í¬ë¡¤ */
		    overflow-y: auto;       /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ ìë™ */
		}
  </style>
</head>

<body layout:fragment="content">

<div class="container mt-4">
    <h2>ê·¼ë¡œê³„ì•½ ë“±ë¡</h2>
    <hr>

    <form id="contractForm">
        <!-- (1) ê¸°ë³¸ ì •ë³´ -->
        <div class="card mb-4">
            <div class="card-header">ê¸°ë³¸ ì •ë³´</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">íšŒì‚¬ëª…</label>
                        <input type="text" class="form-control" id="companyName" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">íšŒì‚¬ë²ˆí˜¸</label>
                        <input type="number" class="form-control" id="companyNum" readonly>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">ì‚¬ì›ëª…</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="employeeName" required readonly>
                            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" onclick="resetEmployeeSelection()" data-bs-target="#employeeSelectModal">ì‚¬ì› ì„ íƒ</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ì‚¬ì›ë²ˆí˜¸</label>
                        <input type="number" class="form-control" id="employeeNum" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- (2) ê·¼ë¡œ ì¡°ê±´ -->
        <div class="card mb-4">
            <div class="card-header">ê·¼ë¡œ ì¡°ê±´</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">ê³„ì•½ ìœ í˜•</label>
						<select class="form-select" id="contractType">
						    <option value="ET001">ì •ê·œì§</option>
						    <option value="ET002">ê³„ì•½ì§</option>
						</select>
                    </div>
					<div class="col-md-6">
					    <label class="form-label pb-3 pe-3">ê³„ì•½ ê¸°ê°„</label>
					    
				    	<!-- âœ… ë²„íŠ¼ ê·¸ë£¹ì„ ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ ì •ë ¬ -->
				        <div class="btn-group ms-auto" role="group">
				            <button type="button" class="btn btn-outline-primary " onclick="setContractPeriod(3)">3ê°œì›”</button>
				            <button type="button" class="btn btn-outline-primary " onclick="setContractPeriod(6)">6ê°œì›”</button>
				            <button type="button" class="btn btn-outline-primary " onclick="setContractPeriod(12)">1ë…„</button>
				        </div>
				        
					    <div class="d-flex align-items-center">
					        <input type="date" class="form-control" id="contractStartDate" required>
					        <span class="mx-2">~</span>
					        <input type="date" class="form-control" id="contractEndDate">
					

					    </div>
					</div>

                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">ê·¼ë¬´ì§€</label>
                        <input type="text" class="form-control" id="workLocation" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ì—…ë¬´ ë‚´ìš©</label>
                        <input type="text" class="form-control" id="jobDescription" required>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">ê·¼ë¬´ ì‹œê°„</label>
                        <div class="d-flex">
                            <input type="time" class="form-control" id="workStartTime" value="09:00">
                            <span class="mx-2">~</span>
                            <input type="time" class="form-control" id="workEndTime" value="18:00">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">íœ´ê²Œ ì‹œê°„</label>
                        <div class="d-flex">
                            <input type="time" class="form-control" id="breakStartTime">
                            <span class="mx-2">~</span>
                            <input type="time" class="form-control" id="breakEndTime">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- (3) ê¸‰ì—¬ ì •ë³´ -->
        <div class="card mb-4">
            <div class="card-header">ê¸‰ì—¬ ì •ë³´ (ì—°ë´‰ì œ ê¸°ì¤€)</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">ì—°ë´‰ (ì›)</label>
                        <input type="text" class="form-control" id="annualSalary" required onfocus="resetValue(this)" onblur="restoreDefaultValue(this)" oninput="calculateMonthlySalary()">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ì›” ê¸°ë³¸ê¸‰ (ìë™ ê³„ì‚°)</label>
                        <input type="text" class="form-control" id="monthlyBaseSalary" readonly>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">ìƒì—¬ê¸ˆ</label>
                        <input type="text" class="form-control" id="bonus" value="0" onfocus="resetValue(this)" onblur="restoreDefaultValue(this)" oninput="formatAndSetCursor(this)">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ê¸°íƒ€ ìˆ˜ë‹¹</label>
                        <input type="text" class="form-control" id="additionalPay" value="0" onfocus="resetValue(this)" onblur="restoreDefaultValue(this)" oninput="formatAndSetCursor(this)">
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">ê¸‰ì—¬ ì§€ê¸‰ì¼</label>
                        <input type="number" class="form-control" id="salaryPaymentDate" required placeholder="ë§¤ì›” ëª‡ ì¼" value="25">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ê¸‰ì—¬ ì§€ê¸‰ ë°©ì‹</label>
                        <select class="form-select" id="salaryPaymentMethod">
                            <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                            <option value="ì§ì ‘ì§€ê¸‰">ì§ì ‘ì§€ê¸‰</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mt-3">
					<div class="col-md-6">
					    <label class="form-label">ì—°ì°¨</label>
					    <input type="text" class="form-control" placeholder="ê·¼ë¡œê¸°ì¤€ë²•ì— ë”°ë¼ ìë™ ë¶€ì—¬ë©ë‹ˆë‹¤."
					        readonly>
					</div>
					<div class="col-md-6">
					    <label class="form-label">ì‚¬íšŒë³´í—˜ ê°€ì…</label><br>
					    <input type="checkbox" class="social-insurance" value="ê³ ìš©ë³´í—˜"> ê³ ìš©ë³´í—˜
					    <input type="checkbox" class="social-insurance" value="ì‚°ì¬ë³´í—˜"> ì‚°ì¬ë³´í—˜
					    <input type="checkbox" class="social-insurance" value="êµ­ë¯¼ì—°ê¸ˆ"> êµ­ë¯¼ì—°ê¸ˆ
					    <input type="checkbox" class="social-insurance" value="ê±´ê°•ë³´í—˜"> ê±´ê°•ë³´í—˜
					</div>
                </div>
                
            </div>
        </div>

        <button type="button" class="btn btn-primary w-100" onclick="submitContract()">ğŸ“„ ê³„ì•½ ë“±ë¡</button>
    </form>
</div>



<!-- ì‚¬ì› ì„ íƒ ëª¨ë‹¬ -->
<div class="modal fade" id="employeeSelectModal" tabindex="-1" aria-labelledby="employeeSelectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì‚¬ì› ì„ íƒ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- ğŸ” ê²€ìƒ‰ í•„í„° -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchKeyword" placeholder="ì‚¬ì›ëª… ê²€ìƒ‰">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary" onclick="loadEmployees()" id="searchButton">ê²€ìƒ‰</button>
                    </div>
                </div>

                <!-- ğŸ”½ ì‚¬ì› ë¦¬ìŠ¤íŠ¸ (Toast Grid) -->
                <div id="employeeGrid"></div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    let companyNum = /*[[${session.companyNum}]]*/ null; 
</script>

<script>

const header = document.querySelector('meta[name="_csrf_header"]').content;
const token = document.querySelector('meta[name="_csrf"]').content;

let selectedEmployee = {}; // ì„ íƒëœ ì‚¬ì› ì •ë³´ ì €ì¥
let salaryPaymentDateValue = document.getElementById("salaryPaymentDate").value;
salaryPaymentDateValue = salaryPaymentDateValue ? parseInt(salaryPaymentDateValue, 10) : 25; // ë¹ˆ ê°’ì´ë©´ 25ë¡œ ì„¤ì •

//input í•„ë“œë¥¼ í´ë¦­í•˜ë©´ ê°’ ì´ˆê¸°í™”
function resetValue(inputElement) {
    if (inputElement.value === "0") {
        inputElement.value = "";
    }
}

// í¬ì»¤ìŠ¤ë¥¼ ë²—ì–´ë‚˜ë©´ ê°’ì´ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’ "0" ì„¤ì •
function restoreDefaultValue(inputElement) {
    if (inputElement.value.trim() === "") {
        inputElement.value = "0";
    }
}

// ìˆ«ì ì…ë ¥ ì‹œ 3ìë¦¬ë§ˆë‹¤ ì½¤ë§ˆ ì¶”ê°€í•˜ë©´ì„œ ì»¤ì„œ ìœ„ì¹˜ ìœ ì§€í•˜ëŠ” í•¨ìˆ˜
function formatAndSetCursor(inputElement) {
    let cursorPosition = inputElement.selectionStart; // í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ ì €ì¥
    let originalLength = inputElement.value.length; // ê¸°ì¡´ ë¬¸ìì—´ ê¸¸ì´ ì €ì¥

    // ì…ë ¥ëœ ê°’ì—ì„œ ìˆ«ìë§Œ ë‚¨ê¸°ê³ , ë‚˜ë¨¸ì§€ ë¬¸ì ì œê±°
    let value = inputElement.value.replace(/,/g, "").replace(/[^0-9]/g, "");
    if (value === "") value = "0"; // ë¹ˆ ê°’ ë°©ì§€

    // ì½¤ë§ˆ ì¶”ê°€ëœ ê°’ ì„¤ì •
    inputElement.value = formatNumberWithCommas(value);

    // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì • (ì½¤ë§ˆ ì¶”ê°€ë¡œ ì¸í•´ ë³€í•œ ê¸¸ì´ë¥¼ ê³ ë ¤)
    let newLength = inputElement.value.length;
    cursorPosition += (newLength - originalLength);

    // ì»¤ì„œ ìœ„ì¹˜ ë³µì›
    inputElement.setSelectionRange(cursorPosition, cursorPosition);
}

// 3ìë¦¬ë§ˆë‹¤ ì½¤ë§ˆ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
function formatNumberWithCommas(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
//ìˆ«ìì— 3ìë¦¬ë§ˆë‹¤ ì½¤ë§ˆ(,)ë¥¼ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
function formatNumberWithCommas(num) {
    if (!num) return "0"; // ê°’ì´ ì—†ì„ ë•Œ ê¸°ë³¸ê°’ 0
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}


document.addEventListener("DOMContentLoaded", function() {
	
	// ì—°ë´‰ ì…ë ¥ í›„ ì›”ê¸‰ ê³„ì‚° ì‹œ ì†Œìˆ˜ì  ë°˜ì˜¬ë¦¼ ì²˜ë¦¬
	document.getElementById("annualSalary").addEventListener("input", function () {
	    let value = this.value.replace(/,/g, "").replace(/[^0-9]/g, ""); // ìˆ«ì ì™¸ ë¬¸ì ì œê±°
	    if (value === "") value = "0"; // ë¹ˆ ê°’ì¼ ê²½ìš° 0ìœ¼ë¡œ ì²˜ë¦¬
	    value = parseInt(value, 10) || 0; // NaN ë°©ì§€

	    this.value = formatNumberWithCommas(value); // ë‹¤ì‹œ í¬ë§· ì ìš©

	    // ì›”ê¸‰ ìë™ ê³„ì‚° (ì—°ë´‰ / 12, ë°˜ì˜¬ë¦¼)
	    let monthlySalary = Math.round(value / 12); 
	    document.getElementById("monthlyBaseSalary").value = formatNumberWithCommas(monthlySalary);
	});
	
    // í…ŒìŠ¤íŠ¸ìš© ë³€ìˆ˜ ì„¤ì •
	let testContractData = {
		    employeeNum: 3, // EMPLOYEE_ID 250102006ì— í•´ë‹¹í•˜ëŠ” EMPLOYEE_NUM ê°’ (ì¡°íšŒí•œ ê°’ ì‚¬ìš©)
		    companyNum: 2, // ì‹¤ì œ COMPANY_NUM
		    departmentNum: 2, // ì‹¤ì œ DEPARTMENT_NUM
		    position: "PO001",
		    contractType: "ET001",
		    contractStartDate: "2025-02-26",
		    contractEndDate: "2026-02-25",
		    workLocation: "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬",
		    jobDescription: "ë°±ì—”ë“œ ê°œë°œ",
		    workStartTime: "09:00",
		    workEndTime: "18:00",
		    breakStartTime: "12:00",
		    breakEndTime: "13:00",
		    probationPeriod: 3,
		    contractStatus: "CS001",
		    annualSalary: 50000000,
		    bonus: 1000000,
		    additionalPay: 500000,
		    salaryPaymentDate: 25,
		    paymentMethod: "ê³„ì¢Œì´ì²´",
		    socialInsurance: "ê³ ìš©ë³´í—˜, ì‚°ì¬ë³´í—˜, êµ­ë¯¼ì—°ê¸ˆ, ê±´ê°•ë³´í—˜"
	};

    // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€
    let testButton = document.createElement("button");
    testButton.textContent = "ğŸ“‹ í…ŒìŠ¤íŠ¸ ê³„ì•½ ë“±ë¡";
    testButton.className = "btn btn-warning w-100 mt-3";
    testButton.onclick = function () {
    	
        fetch("/hr/rest/contract/register", { // API ê²½ë¡œ ì•ì— `/` ì¶”ê°€
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRF-Token": token
            },
            body: JSON.stringify(testContractData)
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error("âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: " + text);
                });
            }
            return response.json();
        })
        .then(data => {
            alert("í…ŒìŠ¤íŠ¸ ê³„ì•½ ë“±ë¡ ì„±ê³µ!");
            window.location.reload();
        })
        .catch(error => {
            console.error("âŒ í…ŒìŠ¤íŠ¸ ê³„ì•½ ë“±ë¡ ì˜¤ë¥˜:", error);
            alert("ì„œë²„ ì˜¤ë¥˜: " + error.message);
        });
    };


    // ë²„íŠ¼ì„ í¼ ì•„ë˜ ì¶”ê°€(í…ŒìŠ¤íŠ¸ ì‹œì—ë§Œ)
    //document.getElementById("contractForm").appendChild(testButton);
	

    // Toast Grid ì„¤ì • (ì‚¬ì› ëª©ë¡)
    const grid = new tui.Grid({
        el: document.getElementById('employeeGrid'),
        scrollX: false,
        scrollY: false,
        columns: [
            { header: "ì‚¬ì›ID", name: "employeeId", align: "center" },
            { header: "ì‚¬ì›ë²ˆí˜¸", name: "employeeNum", align: "center", hidden: true },
            { header: "ì´ë¦„", name: "employeeName", align: "center" },
            { header: "ë¶€ì„œëª…", name: "departmentName", align: "center" },
            { header: "ë¶€ì„œë²ˆí˜¸", name: "departmentNum", align: "center", hidden: true },
            { header: "ì§ê¸‰", name: "position", align: "center" },
            { header: "íšŒì‚¬ë²ˆí˜¸", name: "companyNum", align: "center", hidden: true },
            { header: "íšŒì‚¬ëª…", name: "companyName", align: "center" },
        ]
    });

    // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ìë™ìœ¼ë¡œ ì‚¬ì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    document.getElementById("employeeSelectModal").addEventListener("shown.bs.modal", function () {
        loadEmployees();
        grid.refreshLayout(); // ê·¸ë¦¬ë“œê°€ ëª¨ë‹¬ ë‚´ì—ì„œ ì•ˆ ë³´ì´ëŠ” ë¬¸ì œ í•´ê²°
    });
    
 	// Bootstrap ëª¨ë‹¬ ë‹«í ë•Œ `backdrop` ì œê±°
    document.getElementById("employeeSelectModal").addEventListener("hidden.bs.modal", function () {
        document.querySelectorAll(".modal-backdrop").forEach(el => el.remove());
        document.body.classList.remove("modal-open");
    });

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
    document.getElementById("searchButton").addEventListener("click", function() {
        loadEmployees();
    });

    // ì—”í„°í‚¤ ì…ë ¥ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
    document.getElementById("searchKeyword").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            loadEmployees();
        }
    });

    // ì‚¬ì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ê²€ìƒ‰ í¬í•¨)
    function loadEmployees() {
        let searchKeyword = document.getElementById("searchKeyword").value; // ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°

        if (!companyNum) {
            alert("íšŒì‚¬ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
            return;
        }

        // API ìš”ì²­
        fetch(`/hr/rest/emp/list-by-company?companyNum=${companyNum}&searchKeyword=${searchKeyword}`)
            .then(response => response.json())
            .then(data => {
                console.log("ğŸ“Š ì‚¬ì› ëª©ë¡ ë°ì´í„°:", data);

                if (data.employees && data.employees.length > 0) {
                    grid.resetData(data.employees); // Toast Gridì— ë°ì´í„° ë„£ê¸°
                } else {
                    alert("âš ï¸ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    grid.resetData([]); // ê²°ê³¼ ì—†ì„ ê²½ìš° ë¹ˆ ë°°ì—´ ì²˜ë¦¬
                }
            })
            .catch(error => {
                console.error("âŒ ì‚¬ì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                alert("ì‚¬ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
    }
    
    grid.on('click', function(ev) {
        const rowData = grid.getRow(ev.rowKey);

        if (!rowData) {
            alert("âš ï¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        
        // ë°ì´í„° í™•ì¸ ë¡œê·¸
        console.log("ğŸ“Š ì„ íƒëœ ì‚¬ì› ë°ì´í„°:", rowData);

        selectedEmployee = { 
                employeeNum: rowData.employeeNum, 
                departmentNum: rowData.departmentNum || null,  // ì‚¬ì› ì •ë³´ì—ì„œ ë¶€ì„œë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
                position: rowData.position || null,  // ì‚¬ì› ì •ë³´ì—ì„œ ì§ê¸‰ ê°€ì ¸ì˜¤ê¸°
                companyNum: rowData.companyNum,
                companyName: rowData.companyName,
                employeeName: rowData.employeeName
            };

        document.getElementById("employeeNum").value = rowData.employeeNum;
        document.getElementById("employeeName").value = rowData.employeeName;
        document.getElementById("companyName").value = rowData.companyName;
        document.getElementById("companyNum").value = rowData.companyNum;

        // ê³„ì•½ ìœ í˜• ìë™ ì„ íƒ
        document.getElementById("contractType").value = rowData.employmentTypeCode;  

        let workLocation = rowData.parentDepartmentName ? `${rowData.parentDepartmentName} - ${rowData.departmentName}` : rowData.departmentName;
        document.getElementById("workLocation").value = workLocation;

        // ëª¨ë‹¬ ë‹«ê¸°
        setTimeout(function() {
            $("#employeeSelectModal").modal("hide");
        }, 100);
    });
});


/** ì²´í¬ëœ ì‚¬íšŒë³´í—˜ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ **/
function getSelectedInsurance() {
    let selected = [];
    document.querySelectorAll('.social-insurance:checked').forEach((checkbox) => {
        selected.push(checkbox.value);
    });
    return selected.length > 0 ? selected.join(',') : null;  // ì„ íƒëœ ê°’ì´ ì—†ìœ¼ë©´ `null` ë°˜í™˜
}

//ê³„ì•½ ë“±ë¡ ë°ì´í„°ì— ì¶”ê°€
function submitContract(event) {
	
    if (!selectedEmployee || !selectedEmployee.employeeNum) {
        Swal.fire({
            icon: 'warning',
            title: 'ì‚¬ì› ì„ íƒ í•„ìš”',
            html: 'ë¨¼ì € ì‚¬ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”!',
            confirmButtonText: 'OK',
            width: '450px', // ğŸ“Œ ì ë‹¹í•œ ë„ˆë¹„ ìœ ì§€
            customClass: {
                popup: 'custom-swal-popup' // ğŸ“Œ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ì ìš©
            }
        });
        return;
    }
	
    let contractData = {
            employeeNum: document.getElementById("employeeNum").value,
            companyNum: document.getElementById("companyNum").value,
            departmentNum: selectedEmployee.departmentNum || null,
            position: selectedEmployee.position || null,
            contractType: document.getElementById("contractType").value,
            contractStartDate: document.getElementById("contractStartDate").value,
            contractEndDate: document.getElementById("contractEndDate").value || null,
            workLocation: document.getElementById("workLocation").value,
            jobDescription: document.getElementById("jobDescription").value,
            workStartTime: document.getElementById("workStartTime").value,
            workEndTime: document.getElementById("workEndTime").value,
            breakStartTime: document.getElementById("breakStartTime").value || null,
            breakEndTime: document.getElementById("breakEndTime").value || null,

            // ìˆ«ì ê°’ìœ¼ë¡œ ë³€í™˜
            annualSalary: parseFloat(document.getElementById("annualSalary").value.replace(/,/g, "")) || 0,
            bonus: parseFloat(document.getElementById("bonus").value.replace(/,/g, "")) || 0,
            additionalPay: parseFloat(document.getElementById("additionalPay").value.replace(/,/g, "")) || 0,

            salaryPaymentDate: salaryPaymentDateValue,
            paymentMethod: document.getElementById("salaryPaymentMethod").value,
            socialInsurance: getSelectedInsurance(),
            workDays: "ì›”~ê¸ˆ",
            annualLeavePolicy: "ê·¼ë¡œê¸°ì¤€ë²•ì— ë”°ë¼ ìë™ ë¶€ì—¬ë©ë‹ˆë‹¤."
    };

    console.log("ğŸ“‹ ê³„ì•½ ë“±ë¡ ë°ì´í„°:", contractData);
    
    // ìœ íš¨ì„± ê²€ì‚¬ (í•„ìˆ˜ í•„ë“œ ì²´í¬)
    if (!contractData.employeeNum || !contractData.companyNum || !contractData.contractStartDate || !contractData.annualSalary) {
        Swal.fire({
            icon: 'error',
            title: 'ì…ë ¥ ì˜¤ë¥˜',
            text: 'í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!',
            width: '450px', // ğŸ“Œ ì ë‹¹í•œ ë„ˆë¹„ ìœ ì§€
            customClass: {
                popup: 'custom-swal-popup' // ğŸ“Œ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ì ìš©
            }
            
        });
        return;
    }

    // AJAX ìš”ì²­ (ê·¼ë¡œê³„ì•½ + ê¸‰ì—¬ ë“±ë¡ API í˜¸ì¶œ)
    fetch("/hr/rest/contract/register", { 
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": token
        },
        body: JSON.stringify(contractData)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.error("âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜:", text);
                throw new Error("âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: " + text);
            });
        }

        // ì‘ë‹µì´ JSONì¸ì§€ í™•ì¸
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) {
            return response.json();
        } else {
            return response.text().then(text => ({
                success: false, 
                message: "âš ï¸ JSONì´ ì•„ë‹Œ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤.",
                rawResponse: text
            }));
        }
    })
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'ê·¼ë¡œê³„ì•½ ë“±ë¡ ì™„ë£Œ!',
                text: 'ì‚¬ì› ì¡°íšŒ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                showCancelButton: true,
                confirmButtonText: 'ë„¤, ì´ë™í• ê²Œìš”',
                cancelButtonText: 'ì•„ë‹ˆìš”, ê³„ì† ë“±ë¡í• ê²Œìš”',
                width: '450px',
                customClass: { popup: 'custom-swal-popup' }
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "/hr/employee";
                } else {
                    window.location.reload();
                }
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'ê·¼ë¡œê³„ì•½ ë“±ë¡ ì‹¤íŒ¨',
                text: data.message || 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!',
                width: '450px',
                customClass: { popup: 'custom-swal-popup' }
            });
        }
    })
    .catch(error => {
        console.error("âŒ ê³„ì•½ ë“±ë¡ ì˜¤ë¥˜:", error);
        Swal.fire({
            icon: 'error',
            title: 'ì„œë²„ ì˜¤ë¥˜ ë°œìƒ',
            text: 'ê·¼ë¡œê³„ì•½ ë“±ë¡ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
            width: '450px',
            customClass: { popup: 'custom-swal-popup' }
        });
    });
}



function setContractPeriod(months) {
    let startDateInput = document.getElementById("contractStartDate");
    let endDateInput = document.getElementById("contractEndDate");

    // âœ… ì‹œì‘ì¼ì´ ë¹„ì–´ìˆë‹¤ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì…ë ¥
    if (!startDateInput.value) {
        let today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD í¬ë§·
        startDateInput.value = today;
    }

    let startDate = new Date(startDateInput.value);
    startDate.setMonth(startDate.getMonth() + months); // âœ… ê°œì›” ìˆ˜ ë”í•˜ê¸°
    startDate.setDate(startDate.getDate() - 1); // âœ… í•˜ë£¨ ë¹¼ê¸° (ì¢…ë£Œì¼ì€ ì „ë‚ )

    let formattedEndDate = startDate.toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹ ë³€í™˜
    endDateInput.value = formattedEndDate;
}


function resetEmployeeSelection() {
    // ì„ íƒëœ ì‚¬ì› ì •ë³´ ì´ˆê¸°í™”
    selectedEmployee = {}; 
    
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById("employeeNum").value = "";
    document.getElementById("employeeName").value = "";
    document.getElementById("companyName").value = "";
    document.getElementById("companyNum").value = "";
    document.getElementById("workLocation").value = "";
}

</script>


</body>
</html>
