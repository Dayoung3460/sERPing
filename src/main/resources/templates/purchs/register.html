<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <title>상품 등록</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- toast grid -->
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
    <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

<style>
	#custom-container{
		background-color: #f8f9fa; /* 연한 회색 배경 */
		padding: 20px;
		border-radius: 10px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* 박스 그림자 */
		margin-bottom: 20px;
	
	}
	/* 옵션 추가 버튼 스타일 */
    .btn-custom {
	    width: auto; /* 버튼 크기를 자동 조정 */
	    min-width: 120px; /* 최소 너비 설정 */
	    padding: 10px 20px; /* 패딩 조정 */
	}
    
</style>
</head>
<body layout:fragment="content">
<div class="container mt-4" >
	<h2 class="mb-4">상품 등록</h2>
	
    <form action="/purchs/register" method="get">
    	<div id="custom-container">
	    	<div class="row mb-3">
	            <div class="col-md-6">
	                <label class="form-label">상품명</label>
	                <input type="text" class="form-control" name="goodsName" th:value="${ProductDTO.goodsName}">
	            </div>
	            <div class="col-md-6">
	                <label class="form-label">상품번호</label>
	                <input type="text" class="form-control" name="goodsCode" th:value="${ProductDTO.goodsCode}" readonly>
	            </div>
	        </div>
	
	        <div class="row mb-3">
	            <div class="col-md-6">
	                <label class="form-label">상품분류</label>
	                <select class="form-select" name="classificationId" >
	                    <option value="" selected>선택</option>
	                    <option th:each="cate:${catelist}" th:value="${cate.classificationId}" th:text="${cate.classificationName}"></option>
	                </select>
                </div>
	            <div class="col-md-6">
	                <label class="form-label">브랜드</label>
	                <div class="input-group">
	                    <input type="text" class="form-control" name="brandName" id="brandName" th:value="${ProductDTO.brandName}" data-bs-toggle="modal" data-bs-target="#brandModal" readonly></input>
	        			<input type="hidden" id="brandId" name="brandId" value="${ProductDTO.brandId}">
	                	<!-- 공통 모달 호출 -->
						
						<!-- 브랜드 모달 -->
						
						    <div th:replace="purchs/ModalTemplate :: ModalTemplate (
						    	'brandModal', 
						    	'modal-xl', 
						    	'브랜드 조회', 
						    	'purchs/brandTable', 
						    	'purchs/brandFooter'
						    )"></div>
						

	                </div>
	            </div>
	        </div>
	
	        <div class="row mb-3">
	            <div class="col-md-6">
	                <label class="form-label">공급처</label>
	                <div class="input-group">
	                    <input type="text" class="form-control" name="vendorId" th:value="${ProductDTO.vendorId}" data-bs-toggle="modal" data-bs-target="#vendorModal"  readonly>
	                	<!-- 거래처 모달 -->
						
						    <div th:replace="purchs/ModalTemplate :: ModalTemplate (
						    'vendorModal', 
						    'modal-xl', 
						    '거래처 조회', 
						    'purchs/vendorTable', 
						    'purchs/brandFooter'
						    )"></div>
						
	                </div>
	            </div>
	            <div class="col-md-6">
	                <label class="form-label">원가</label>
	                <input type="text" class="form-control" name="goodsCost" th:value="${ProductDTO.goodsCost}">
	            </div>
	        </div>
	
	        <div class="row mb-3">
	            <div class="col-md-6">
	                <label class="form-label">판매가</label>
	                <input type="text" class="form-control" name="goodsPrice" th:value="${ProductDTO.goodsPrice}">
	            </div>
	            <div class="col-md-6">
	                <label class="form-label">공급가액</label>
	                <input type="text" class="form-control" name="goodsSupplyPrice" th:value="${ProductDTO.goodsSupplyPrice}">
	            </div>
	        </div>
	
	        <div class="row mb-3">
	            <div class="col-md-6">
	                <label class="form-label">규격</label>
	                <input type="text" class="form-control" name="goodsStandard" th:value="${ProductDTO.goodsStandard}">
	            </div>
	            <div class="col-md-6">
	                <label class="form-label">담당자</label>
	                <input type="text" class="form-control" name="employeeNum" th:value="${ProductDTO.employeeNum}" readonly>
	            </div>
	        </div>
	
	        <div class="row mb-3">
	            <div class="col-md-6">
	                <label class="form-label">대표 이미지</label>
	                <div class="input-group">
	                    <input type="file" class="form-control" name="goodsImage" th:value="${ProductDTO.goodsImage}" readonly>
	                </div>
	            </div>
	            <div class="col-md-6">
	                <label class="form-label">상품설명</label>
	                <div class="input-group">
	                    <textarea class="form-control" name="goodsDescription" rows="2" th:text="${ProductDTO.goodsDescription}"></textarea>
	                </div>
	            </div>
	        </div>
		
		</div>
       
        <div class="d-flex justify-content-between mb-3">
            <div>
                <input type="checkbox" id="singleRegister" name="registerType">
                <label for="singleRegister">단건 등록</label>
        
                <input type="checkbox" id="optionRegister" name="registerType">
                <label for="optionRegister">옵션 등록</label>
            </div>
        </div>
        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-primary btn-custom" id="bttAdd">옵션 추가</button>
        </div>
        <div id="myGrid" class="tui-grid-container" style="height: 200px;"></div>
        <div id="pagination" class="tui-pagination"></div>
        <div class=" d-flex justify-content-center mt-4">
            <button type="submit" class="btn btn-primary mx-2">등록</button>
            <button type="reset" class="btn btn-secondary mx-2">초기화</button>
        </div>
    </form>
</div>

<script>
    var Grid = tui.Grid;
    //입력 창의 경우 
    const dataSource = [];
    // 사용자 정의 렌더러 (삭제 버튼 추가)
    class DeleteRenderer {
        constructor(props) {
            const el = document.createElement('button');
            el.textContent = '삭제';
            el.className = 'btnDelete btn btn-danger btn-sm';
            el.addEventListener('click', () => {
                grid.removeRow(props.rowKey); // 클릭 시 해당 행 삭제
            });
            this.el = el;
        }
        getElement() {
            return this.el;
        }
    }

    const grid = new Grid({
        el: document.getElementById('myGrid'), // 컨테이너 엘리먼트
        rowHeaders: ['checkbox'], 
        columns: [ 
            {header : "옵션코드" , name:"optionCode",className: "tui-grid-cell-readonly"},
            {header : "옵션명" , name:"optionName" , editor: "text"},
            {header : "현재재고" , name:"currentAmount",className: "tui-grid-cell-readonly"},
            {header : "안전재고" , name:"optionSafetyInvoice" , className: "tui-grid-cell-readonly"},
            {header : "상품위치" , name:"warehouseName" , editor: "text"},
            {
                header : "삭제"
                ,name: "delete"
                ,renderer: {
                type: DeleteRenderer // 삭제버튼 정의 렌더러
                }  
                ,cellStyle: { textAlign: "center" }
                ,className: "tui-grid-cell-readonly"
            }
        ],
        data: dataSource
    });
    

    document.addEventListener("DOMContentLoaded", function(){
        const singleRegister = document.getElementById("singleRegister");
        const optionRegister = document.getElementById("optionRegister");
        const bttAdd = document.getElementById("bttAdd");
         // 단건 조회가 이미 있는지 확인하는 함수
        function isSingleRowExists() {
            return grid.getData().some(row => row.optionName === "단건");
        }

          // 모든 행 삭제 함수 (removeRow 사용)
        function deleteAllRows() {
            const rowKeys = grid.getData().map(row => row.rowKey); // 모든 행의 rowKey를 얻음
            rowKeys.forEach(key => {
                grid.removeRow(key); // 각 행을 삭제
            });
        }
        

        
        //단건등록시 체크박스 상태 
        singleRegister.addEventListener("change", function(){
             // 체크 상태 변경 시 기존 행 삭제
            deleteAllRows();

            if (this.checked) {
                if (!isSingleRowExists()) {
                    grid.appendRow({ optionName: "단건" }, { at: 0 }); // 옵션명 "단건" 추가
                }
                // 단건이 추가되면 bttAdd 비활성화
                bttAdd.disabled = true;
                optionRegister.checked= false;
            }else {
                bttAdd.disabled = false; // 다시 bttAdd 버튼 활성화
            }
        });
	// 옵션등록시 체크박스
        optionRegister.addEventListener("change", function(){
            if(this.checked){
                grid.appendRow({}, { at: 0 }); // 빈 행 추가
                singleRegister.checked= false;
                bttAdd.disabled = false; // bttAdd 버튼 활성화
            }else {
                bttAdd.disabled = false; // 다시 bttAdd 버튼 활성화
            }
        });

        // 버튼 이벤트 핸들러
        // 행추가
        bttAdd.addEventListener("click", function () {
            if (!singleRegister.checked && optionRegister.checked) {
                grid.appendRow({}, { at: 0 }); // 빈 행 추가
            }
        });
       
      //브랜드 모달 작업 
     // 모달이 열릴 때 그리드 다시 그리기
     document.getElementById('brandModal').addEventListener('shown.bs.modal', function () {
	    console.log("📢 모달이 열림. 그리드 리프레시 실행!");
	
	    if (typeof brandGrid !== 'undefined' && brandGrid !== null) {
	        brandGrid.refreshLayout();
	        brandGrid.readData(); // 모달이 열리면 데이터 다시 불러오기
	    } else {
	        console.warn(" brandGrid가 정의되지 않았습니다.");
	    }
	});

    document.getElementById('brandModal').addEventListener('hidden.bs.modal', function () {
   	    console.log("📢 모달이 닫힘. 선택된 브랜드를 input에 반영.");

   	    let selectedBrandName = sessionStorage.getItem("selectedBrandName");
   	    let selectedBrandId = sessionStorage.getItem("selectedBrandId");

   	    if (selectedBrandName && selectedBrandId) {
   	        let brandInput = document.getElementById("brandName");
   	        let brandIdInput = document.getElementById("brandId");

   	        if (brandInput && brandIdInput) {
   	            brandInput.value = selectedBrandName;
   	            brandIdInput.value = selectedBrandId;
   	        }

   	        console.log("브랜드 선택 완료:", selectedBrandName, selectedBrandId);
			
	   	 
   	     
   	        // ✅ 값 사용 후 sessionStorage에서 삭제
   	        sessionStorage.removeItem("selectedBrandName");
   	        sessionStorage.removeItem("selectedBrandId");
   	    } else {
   	        console.warn("저장된 브랜드 정보가 없습니다.");
   	    }
   	});


      
      
        
        
        
    });
    
    
</script>

</body>


</html>
