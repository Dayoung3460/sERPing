<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <title>상품 관리</title>
  
 
    
    <!-- toast grid -->
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
    <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

<style>
	#custom-container{
		background-color: #f8f9fa; /* 연한 회색 배경 */
		padding: 20px;
		border-radius: 10px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* 박스 그림자 */
		margin-bottom: 20px;
	
	}
	/* 옵션 추가 버튼 스타일 */
    .btn-custom {
	    width: auto; /* 버튼 크기를 자동 조정 */
	    min-width: 120px; /* 최소 너비 설정 */
	    padding: 10px 20px; /* 패딩 조정 */
	}



    
</style>
</head>
<body layout:fragment="content">
<div class="container mt-4">
    <h2 class="mb-4">상품 관리</h2>

    <div id="custom-container">
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">상품명</label>
                <input type="text" class="form-control" name="goodsName" id="goodsName"
                       th:value="${product?.goodsName}">
            </div>
            <div class="col-md-6">
                <label class="form-label">상품번호</label>
                <input type="text" class="form-control" name="goodsCode" id="goodsCode"
                       th:value="${product?.goodsCode}" readonly>
                 <input type="hidden" class="form-control" name="goodsNum" id="goodsNum"
                       th:value="${product?.goodsNum}" readonly>
            </div>
        </div>

        <div class="row mb-3">
		    <div class="col-md-6">
		        <label class="form-label">상품분류</label>
		        <input type="text" class="form-control" name="classificationName" id="classificationName"
                           th:value="${product?.classificationName}" readonly>
                <input type="hidden" class="form-control" name="classificationId" id="classificationId"
                           th:value="${product?.classificationId}" readonly>
		        
		    </div>

            <div class="col-md-6">
                <label class="form-label">브랜드</label>
                <div class="input-group">
                    <input type="text" class="form-control" name="brandName" id="brandName"
                           th:value="${product?.brandName}" readonly>
                    <input type="hidden" id="brandId" name="brandId" th:value="${product?.brandId}">

                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">공급처</label>
                <div class="input-group">
                    <input type="text" class="form-control" name="vendorName" id="vendorName"
                           th:value="${product?.vendorName}" 
                           readonly>
                    <input type="hidden" id="vendorId" name="vendorId" th:value="${product?.vendorId}">
                    
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label">원가</label>
                <input type="text" class="form-control" name="goodsCost" id="goodsCost"
                       th:value="${product?.goodsCost}">
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">판매가</label>
                <input type="text" class="form-control" name="goodsPrice" id="goodsPrice"
                       th:value="${product?.goodsPrice}">
            </div>
            <div class="col-md-6">
                <label class="form-label">공급가액</label>
                <input type="text" class="form-control" name="goodsSupplyPrice" id="goodsSupplyPrice"
                       th:value="${product?.goodsSupplyPrice}">
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">규격</label>
                <input type="text" class="form-control" name="goodsStandard" id="goodsStandard"
                       th:value="${product?.goodsStandard}">
            </div>
            <div class="col-md-6">
                <label class="form-label">담당자</label>
                <input type="text" class="form-control" name="employeeName" id="employeeName"
                       th:value="${product?.employeeName}" readonly>
                <input type="hidden" id="employeeNum" name="employeeNum" th:value="${session.employeeNum}">
                
            </div>
        </div>

        <div class="row mb-3">
             <div class="col-md-6">
		        <label class="form-label">대표 이미지</label>
		        <div class="input-group">
		            <!-- 파일명을 표시하는 input (클릭하면 파일 업로드 가능) -->
		            <input type="text" class="form-control" id="imageFileName" name="imageFileName" 
		                   th:value="${product?.goodsImage}" readonly onclick="document.getElementById('goodsImage').click();">
		
		            <!-- 실제 파일 업로드용 input (숨김) -->
		            <input type="file" class="form-control d-none" id="goodsImage" name="file"
		                   accept=".jpg, .jpeg, .png, .pdf">
		            
		            <!-- 업로드 버튼 -->
		            <button class="btn btn-outline-secondary" type="button" id="uploadImageBtn">업로드</button>
		        </div>
		
		        <!-- 실제 업로드된 파일명을 저장할 hidden input -->
		        <input type="hidden" id="uploadedImageName" name="goodsImage" th:value="${product?.goodsImage}">
		    </div>
            <div class="col-md-6">
                <label class="form-label">상품설명</label>
                <textarea class="form-control" name="goodsDescription" id="goodsDescription" rows="2"
                          th:text="${product?.goodsDescription}"></textarea>
            </div>
            <div class="col-md-6">
		        <label class="form-label">상품 상태</label>
		        <input type="text" class="form-control" id="goodsUseStatus" name="goodsUseStatus"
		               th:value="${product?.goodsUseStatus}" readonly>
		    </div>
		    <input type="hidden" id="companyNum" name="companyNum" th:value="${product?.companyNum}">
		    <input type="hidden" id="marginRate" name="marginRate" th:value="${product?.marginRate}">
		  
        </div>

        
    </div>

   
    <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-primary btn-custom" id="bttAdd">옵션 추가</button>
    </div>
    
    <div id="myGrid" class="tui-grid-container" style="height: 200px;"></div>
    <script th:inline="javascript">
	    let optionsData = /*[[${options}]]*/ [];
	    console.log("✅ Thymeleaf에서 받은 optionsData:", optionsData);
	</script>

    <div id="pagination" class="tui-pagination"></div>

    <!-- 창고 모달 -->
    <div th:replace="~{purchs/modal/ModalTemplate :: ModalTemplate (
        'warehouseModal',
        'modal-xl',
        '창고 조회',
        'purchs/modal/warehouseTable',
        'purchs/modal/warehouseFooter'
    )}"></div>

    <div class="d-flex justify-content-center mt-4">
        <button class="btn btn-primary mx-2" id="updateBtn">수정</button>
        <button class="btn btn-secondary mx-2">초기화</button>
    </div>
    
    
</div>
 



<script>



 document.addEventListener("DOMContentLoaded", function(){
	 
	 const header = document.querySelector('meta[name="_csrf_header"]').content;
	 const token = document.querySelector('meta[name="_csrf"]').content;

	 // ✅ Hidden input에서 값 가져올 때 안전한 방식으로 처리
	    let companyNum = parseInt(document.getElementById("companyNum")?.value || "0", 10);
	    let marginRate = parseInt(document.getElementById("marginRate")?.value || "0", 10);
	 

	 let grid;
	 
	 
	 // 파일 선택 시 파일명을 표시
	    document.getElementById("goodsImage").addEventListener("change", function(event) {
	        let file = event.target.files[0];
	        if (file) {
	            document.getElementById("imageFileName").value = file.name;
	            document.getElementById("uploadedImageName").value = file.name;
	        }
	    });

	    // 이미지 업로드 버튼 클릭 이벤트
	    document.getElementById("uploadImageBtn").addEventListener("click", function() {
	        document.getElementById("goodsImage").click();
	    });
	    
	    //원가 * 마진률 = 공급가액
   	    document.getElementById("goodsCost").addEventListener("input", function () {
   	        let goodsCost = parseFloat(this.value) || 0;
   	        
   	        
   	
   	        // 공급가액 계산: 원가 * (1 + 마진률 / 100)
   	        let supplyPrice = parseInt(goodsCost * (1 + (marginRate / 100)),10);
   	
   	        // 결과 반영
   	        document.getElementById("goodsSupplyPrice").value = supplyPrice;
   	    });
   	
   	    // 페이지 로드 시 공급가액 자동 계산 (초기 원가값이 있을 경우)
   	    let initialGoodsCost = parseFloat(document.getElementById("goodsCost").value) || 0;
   	    if (initialGoodsCost) {
   	        document.getElementById("goodsCost").dispatchEvent(new Event("input"));
   	    }

          // 모든 행 삭제 함수 (removeRow 사용)
        function deleteAllRows() {
            const rowKeys = grid.getData().map(row => row.rowKey); // 모든 행의 rowKey를 얻음
            rowKeys.forEach(key => {
                grid.removeRow(key); // 각 행을 삭제
            });
        }
          
          
        

        

	    // 옵션 추가 버튼
	    document.getElementById("bttAdd").addEventListener("click", function () {
	    	grid.appendRow({
	            optionCode: "",           // 옵션 코드 초기값
	            optionName: "",           // 옵션명 초기값
	            totalRemainingQuantity: 0, // 현재 재고 초기값
	            optionSafetyInvoice: 0,   // ✅ 안전재고 기본값 0
	            warehouseName: "",        // 상품 위치 초기값
	            warehouseId: 0,           // 창고 ID 초기값
	            optionUseFlag: 0          // 기본값 "사용중"
	        }, { at: 0 });

	    });
	    
        // 사용자 정의 렌더러 (삭제 버튼 추가)
        class DeleteRenderer {
            constructor(props) {
                const el = document.createElement('button');
                el.textContent = '삭제';
                el.className = 'btnDelete btn btn-danger btn-sm';
                el.addEventListener('click', () => {
                    grid.removeRow(props.rowKey); // 클릭 시 해당 행 삭제
                });
                this.el = el;
            }
            getElement() {
                return this.el;
            }
        }
        
     // ✅ 안전재고 렌더러 클래스 (오류 방지 버전)
       class SafetyStockRenderer {
		    constructor(props) {
		        const el = document.createElement('div');
		        el.className = "d-flex justify-content-between align-items-center w-100";
		
		        // 기존 값 표시
		        const input = document.createElement('input');
		        input.type = "text";
		        input.value = props.value ?? '0'; // 기본값 0
		        input.className = "form-control form-control-sm"; // 작은 입력창 스타일 적용
		
		        // Bootstrap 아이콘 버튼 생성
		        const btn = document.createElement('button');
		        btn.className = "safetyStockBtn btn btn-sm btn-link p-0 text-primary border-0 ms-auto";
		        btn.innerHTML = `📄`; // ✅ Bootstrap 아이콘 적용
		
		        // 버튼 클릭 시 `safetyStock` 값을 `optionSafetyInvoice` 칼럼에 반영
		        btn.addEventListener("click", () => {
		            let safetyStockValue = parseInt(grid.getValue(props.rowKey, "safetyStock")) || 0;
		            console.log(`📢 안전재고 버튼 클릭: rowKey=${props.rowKey}, value=${safetyStockValue}`);
		
		            grid.setValue(props.rowKey, "optionSafetyInvoice", safetyStockValue);
		            input.value = safetyStockValue; // UI에도 반영
		            setTimeout(() => grid.refreshLayout(), 50);
		        });
		
		        // 사용자가 직접 입력 시 데이터 업데이트 보장
		        input.addEventListener("change", () => {
		            let newValue = parseInt(input.value) || 0;
		            console.log(`📢 직접 입력한 안전재고: rowKey=${props.rowKey}, value=${newValue}`);
		            
		            grid.setValue(props.rowKey, "optionSafetyInvoice", newValue);
		            setTimeout(() => grid.refreshLayout(), 50);
		        });
		
		        el.appendChild(input);
		        el.appendChild(btn);
		        this.el = el;
		    }
		
		    getElement() {
		        return this.el;
		    }
		}



        
    

        	grid = new tui.Grid({
            el: document.getElementById('myGrid'), // 컨테이너 엘리먼트
            scrollX :false,
            scrollY : false,
            rowHeaders: ['checkbox'], 
            columns: [ 
                {header : "옵션코드" , name:"optionCode",align: "left",className: "tui-grid-cell-readonly"},
                {header : "옵션명" , name:"optionName" , editor: "text" ,align: "left"},
                {header : "현재재고" , name:"totalRemainingQuantity",align: "right",className: "tui-grid-cell-readonly"},
                {
	                header : "안전재고" , 
	                name:"optionSafetyInvoice",
	                editor: "text",
	                align: "right",
	                renderer: {
	                    type: SafetyStockRenderer  // 안전재고 버튼을 추가하는 렌더러
	                }
                },
                {header : "상품위치" , name:"warehouseName",editor: "text",align: "left",},
                {header : "창고id" , name:"warehouseId" , hidden: true,align: "left",},
                {
                    header: "옵션 사용유무",
                    name: "optionUseFlag",
                    formatter: function({ value }) {
                        return value == 0 ? "사용중" : "사용중단"; // ✅ 숫자 비교로 변환
                    },
                    editor: {
                        type: "select",
                        options: {
                            listItems: [
                                { text: "사용중", value: 0 },
                                { text: "사용중단", value: 1 }
                            ]
                        }
                    },
                    onAfterChange: function (ev) {
                        if (ev.columnName === "optionUseFlag") {
                            let newValue = ev.value === "사용중" ? 0 : 1;
                            grid.setValue(ev.rowKey, "optionUseFlag", newValue);
                        }
                    }
                }




            ],
            
        });
        	 console.log("📢 Toast Grid 초기화 완료!");
        	 
        	// ✅ 페이지가 로드될 때 서버에서 데이터 불러오기
    	   setTimeout(() => {
		        console.log("📢 optionsData 적용 전: ", JSON.stringify(optionsData, null, 2));
		
		        if (Array.isArray(optionsData) && optionsData.length > 0) {
		            grid.resetData(optionsData);
		            console.log("✅ 적용 후 Toast Grid 데이터:", grid.getData());
		        } else {
		            console.warn("⚠️ optionsData가 비어있음.");
		        }
		    }, 500);
        	
    	

       	
        // ✅ 엔터 입력 후 값이 초기화되지 않도록 `afterChange` 이벤트 추가
      grid.on('afterChange', (ev) => {
		    ev.changes.forEach(change => {
		        if (change.columnName === "optionSafetyInvoice") {
		            let newValue = change.value ?? grid.getValue(change.rowKey, "optionSafetyInvoice");
		            let rowKey = change.rowKey;
		
		            console.log(`✅ 안전재고 변경됨: rowKey=${rowKey}, newValue=${newValue}`);
		
		            setTimeout(() => {
		                grid.setValue(rowKey, "optionSafetyInvoice", newValue);
		                grid.refreshLayout(); // UI 갱신 보장
		            }, 50);
		        }
		    });
		});
        
      grid.on('afterChange', (ev) => {
    	    ev.changes.forEach(change => {
    	        if (change.columnName === "warehouseId") {
    	            let newValue = change.value && change.value !== "" ? parseInt(change.value) : 0;
    	            grid.setValue(change.rowKey, "warehouseId", newValue);
    	        }
    	    });
    	});



     // Toast Grid 셀 클릭 시 이벤트 추가
        grid.on('click', function(ev) {
            const { rowKey, columnName } = ev;

            // "상품위치" 컬럼 클릭 시 모달 열기
            if (columnName === "warehouseName") {
                openWarehouseModal(rowKey);
            }
        });

 
    //이미지전송 함수
    async function imgSave() {
        const fileInput = document.getElementById("goodsImage");
        const file = fileInput.files[0];

        if (!file) {
            console.warn("⚠️ 업로드할 파일이 선택되지 않았습니다.");
            return null;
        }

        const formData = new FormData();
        formData.append("file", file);
        
        try {
            const response = await fetch("/purchs/rest/product/uploadGoodsImages", {
                method: "POST",
                headers: {
                    'header': header,
                    'X-CSRF-Token': token
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error("❌ 서버 응답 오류: " + response.statusText);
            }

            // ✅ JSON 응답 처리
            const data = await response.json();

            if (data.success) {
                console.log("✅ 업로드된 파일명:", data.fileName);
                document.getElementById("uploadedImageName").value = data.fileName;
                return data.fileName; // ✅ 파일명 반환
            } else {
                console.warn("❌ 파일 업로드 실패:", data.message);
                return null;
            }
        } catch (error) {
            console.error("❌ 파일 업로드 중 오류 발생:", error);
            return null;
        }
    }
    
 // ✅ 이미지 업로드 버튼 클릭 시 imgSave() 실행
    document.getElementById("uploadImageBtn").addEventListener("click", async function () {
        try {
            const uploadedFileName = await imgSave(); // ✅ 이미지 업로드 후 파일명 반환
            if (uploadedFileName) {
                console.log("✅ 이미지 파일명 저장됨:", uploadedFileName);

                // ✅ 업로드된 파일명을 <input>에 반영
                //document.getElementById("uploadedImageName").value = uploadedFileName;
                //console.log("✅ Hidden Input 값 업데이트됨: ", document.getElementById("uploadedImageName").value);
            } else {
                console.warn("⚠️ 서버에서 파일명을 반환하지 않았습니다.");
            }
        } catch (error) {
            console.error("❌ 이미지 업로드 중 오류 발생:", error);
        }
    });

 
   
 //창고 모달 작업

function openWarehouseModal(rowKey) {
   	    sessionStorage.setItem("selectedRowKey", rowKey); // 클릭한 행(rowKey) 저장
   	    
   	 	let selectedRowKey = parseInt(sessionStorage.getItem("selectedRowKey"), 10);

   	
   	    // 모달 요소 가져오기
   	    const modalElement = document.getElementById('warehouseModal');
   	    if (!modalElement) {
   	        console.error("warehouseModal 요소를 찾을 수 없습니다.");
   	        return;
   	    }
   	    

   	    // 창고 그리드가 정의되어 있는지 확인 후 데이터 갱신
   	    if (typeof warehouseGrid !== 'undefined' && warehouseGrid !== null) {
   	        console.log("📢 창고 모달: 데이터 초기화 및 새로고침 시작");
   	
   	        // 기존 데이터 초기화
   	    
   	        let Data = warehouseGrid.getData();
   	        console.log("그리드데이터",Data)
   	        console.log(bootstrap.Version);

   	        
   			 warehouseGrid.readData();
   	        
   	        setTimeout(() => {
   		        warehouseGrid.refreshLayout();  // 기존 데이터 초기화
   	        	
   			}, 500);
  

   	        // 데이터를 다 불러온 후 모달 열기 (onGridUpdated 이벤트 활용)
   	         warehouseGrid.on("onGridUpdated", function () {
   	            console.log("창고 모달: 데이터 새로고침 완료");
   	            

   	            // 데이터 로드 완료 후 모달 열기
   	            const modalInstance = new bootstrap.Modal(modalElement);
   	            modalInstance.show(); // 모달 열기
   	            
   	            
   	            console.log("창고 모달 열림:", rowKey);
   	        }); 
   	    } else {
   	        console.warn("warehouseGrid가 정의되지 않았습니다.");
   	    } 
   	}
 
document.getElementById('warehouseModal').addEventListener('shown.bs.modal', function () {
	    console.log(" 창고 모달이 열렸습니다. 그리드 새로고침 실행");

	    if (typeof warehouseGrid !== 'undefined' && warehouseGrid !== null) {
	        warehouseGrid.readData();       // 🚀 데이터 새로고침
	  
	        console.log("창고 그리드 데이터 새로고침 완료");
	    } else {
	        console.warn("warehouseGrid가 정의되지 않았습니다.");
	    }
	}); 
	
	
  
	
		//모달 검은 화면 모두 제거 
	   document.querySelectorAll('[data-bs-toggle="modal"]').forEach(function (modalTrigger) {
		    modalTrigger.addEventListener("click", function () {
		        document.querySelectorAll('.modal-backdrop').forEach(function (element) {
		            element.remove(); // 중복 생성 방지
		        });
		    });
		});
   
	    const modalElement = document.getElementById("warehouseModal");
	    const closeButton = modalElement.querySelector('[data-bs-dismiss="modal"]');
	    
	    
	    console.log()
	    if (closeButton) {
	        closeButton.addEventListener("click", function () {
	            console.log("✅ 창고 모달 닫기 버튼 클릭됨!");

	            try {
	            	let modalInstance = bootstrap.Modal.getInstance("#warehouseModal") || new bootstrap.Modal("#warehouseModal");
	                modalInstance.hide(); // ✅ Bootstrap 방식으로 모달 닫기
	                
	            } catch (error) {
	                console.warn("❌ Bootstrap 5가 로드되지 않았음. 대체 방식 사용");
	                modalElement.classList.remove("show");
	                modalElement.style.display = "none";
	                document.body.classList.remove("modal-open");

	                setTimeout(() => {
	                    document.querySelectorAll(".modal-backdrop").forEach((element) => element.remove()); // 백그라운드 제거
	                }, 300);
	                
	                hiddenwmodal();
	            }
	        });
	    } else {
	        console.warn("❌ 창고 모달 닫기 버튼을 찾을 수 없습니다.");
	    } 
	  
	

	    function hiddenwmodal() {
	        let selectedWarehouseId = sessionStorage.getItem("selectedWarehouseId");
	        let selectedWarehouseName = sessionStorage.getItem("selectedWarehouseName");
	        let selectedRowKey = parseInt(sessionStorage.getItem("selectedRowKey"), 10); // ✅ 숫자로 변환

	        console.log("📢 저장된 데이터 확인:", selectedWarehouseId, selectedWarehouseName, selectedRowKey);

	        if (selectedWarehouseId && selectedWarehouseName && !isNaN(selectedRowKey)) {
	            setTimeout(() => {
	                grid.setValue(selectedRowKey, "warehouseId", selectedWarehouseId, false);
	                grid.setValue(selectedRowKey, "warehouseName", selectedWarehouseName, false);

	                console.log(`✅ 그리드에 값 설정 완료: ${selectedRowKey} => ${selectedWarehouseName} + ${selectedWarehouseId}`);

	                let currentData = grid.getData();
	                console.log("📢 현재 그리드 데이터:", currentData);

	                // ✅ UI 업데이트 보장
	                setTimeout(() => {
	                    grid.refreshLayout();
	                }, 50);

	                // ✅ sessionStorage 데이터 삭제
	                sessionStorage.removeItem("selectedWarehouseId");
	                sessionStorage.removeItem("selectedWarehouseName");
	                sessionStorage.removeItem("selectedRowKey");
	            }, 100);
	        } else {
	            console.warn("📢 저장된 상품 위치 정보가 없습니다.");
	        }
	    }


	    // ✅ 모달 클릭 시 중복 백그라운드 제거
	    document.querySelectorAll('[data-bs-toggle="modal"]').forEach(function (modalTrigger) {
	        modalTrigger.addEventListener("click", function () {
	            document.querySelectorAll('.modal-backdrop').forEach(function (element) {
	                element.remove(); // 중복 생성 방지
	            });
	        });
	    });
	    
	    // ✅ 수정 버튼 클릭 이벤트
	 // ✅ 수정 버튼 클릭 이벤트
	    document.getElementById("updateBtn").addEventListener("click", async function () {
	        try {
	            // 상품 정보 가져오기
	            let goodsNum = parseInt(document.getElementById("goodsNum").value) || 0;  // 상품번호 (PK)
	            let goodsName = document.getElementById("goodsName").value;
	            let goodsCost = parseInt(document.getElementById("goodsCost").value) || 0;
	            let goodsPrice = parseInt(document.getElementById("goodsPrice").value) || 0;
	            let goodsSupplyPrice = parseInt(document.getElementById("goodsSupplyPrice").value) || 0;
	            let goodsStandard = document.getElementById("goodsStandard").value;
	            let goodsDescription = document.getElementById("goodsDescription").value;
	            let goodsImage = document.getElementById("uploadedImageName").value;  // 업로드된 이미지 파일명
	            let employeeNum = parseInt(document.getElementById("employeeNum").value) || 0;
	            let companyNum = parseInt(document.getElementById("companyNum").value) || 0;

	            // ✅ 옵션 리스트 데이터 가져오기 (체크된 행만)
	            let optionData = grid.getCheckedRows().map(row => ({
	                optionNum: parseInt(row.optionNum) || 0,  // 옵션 코드
	                optionName: row.optionName,
	                optionSafetyInvoice: parseInt(row.optionSafetyInvoice) || 0,
	                warehouseId: row.warehouseId && row.warehouseId !== "" ? parseInt(row.warehouseId) : null, // ✅ 빈 값이면 null 유지
	                optionUseFlag: row.optionUseFlag == 0 ? 0 : 1 // ✅ 값이 숫자인지 확인 후 변환
	            }));

	            // ✅ 체크된 옵션이 없는 경우 알림
	            if (optionData.length === 0) {
	                alert("⚠️ 수정할 옵션을 선택해주세요!");
	                return;
	            }

	            console.log("📢 전송할 옵션 리스트:", optionData);

	            // ✅ 최종 데이터 JSON 구조 만들기
	            let updateData = {
	                goodsNum: goodsNum,
	                goodsName: goodsName,
	                goodsCost: goodsCost,
	                goodsPrice: goodsPrice,
	                goodsSupplyPrice: goodsSupplyPrice,
	                goodsStandard: goodsStandard,
	                goodsDescription: goodsDescription,
	                goodsImage: goodsImage,
	                employeeNum: employeeNum,
	                companyNum: companyNum,
	                files: optionData
	            };

	            console.log("📢 서버로 보낼 데이터:", updateData);

	            // ✅ 서버에 상품 수정 요청 (Ajax)
	            const response = await fetch("/purchs/rest/product/update", {
	                method: "POST",
	                headers: {
	                    "Content-Type": "application/json",
	                    "X-CSRF-Token": document.querySelector('meta[name="_csrf"]').content
	                },
	                body: JSON.stringify(updateData)
	            });

	            // ✅ 응답 처리
	            const result = await response.json();
	            if (result.status === "success") {
	                alert("✅ 상품이 성공적으로 수정되었습니다!");
	                location.reload();  // ✅ 페이지 새로고침
	            } else {
	                alert("❌ 상품 수정 실패: " + result.message);
	            }

	        } catch (error) {
	            console.error("❌ 상품 수정 중 오류 발생:", error);
	            alert("⚠️ 서버 오류가 발생했습니다.");
	        }
	    });

	    
	    
  
      
  });

 

    
 
    
</script>
<!-- ✅ Bootstrap 5 CDN 추가 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>


</html>
