
<body>

<div class="container">
    <!-- 검색 영역 -->
    <div class="header-box">
        <div class="row d-flex align-items-end gap-3">
            <div class="col-auto">
                <label class="form-label">상품명</label>
                <input type="text" class="form-control" id="searchGoodsName">
            </div>
            <div class="col-auto">
                <label class="form-label">브랜드</label>
                <input type="text" class="form-control" id="searchBrandName">
            </div>
            <div class="col-auto">
                <span class="label-search col-4">표시수량</span>
                <select id="product_display_amount" class="form-control" onchange="changeProductDisplay()">
                    <option value="5" selected>5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select> 
            </div>
            <div class="col-auto d-flex">
                <button class="btn btn-search w-50" onclick="productSearch()">검색</button>
                <button class="btn btn-reset w-50 ms-2" onclick="resetFilters()">초기화</button>
            </div>
        </div>
    </div>

    <!-- Toast Grid -->
    <div id="table-container">
        <div id="productGrid"></div>
        <div id="pagination" class="tui-pagination"></div>
    </div>

  
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
	console.log("DOMContentLoaded 이벤트 실행 = 스크립트 실행")
    initProductGrid();
});

let productGrid;

function initProductGrid() {
	
	console.log("initProductGrid()실행")

    const companyNum = [[${session.companyNum}]];
  

	if (!companyNum) {
        console.error("❌ 세션에서 companyNum 값을 찾을 수 없음.");
        return; // companyNum이 없으면 요청을 하지 않음
    } 
    
    //const companyNum = 1;

    console.log("✅ 설정된 companyNum:", companyNum);

    const productDataSource = {
            api: {  
                readData: { 
                    url: 'http://localhost:81/purchs/rest/product/list', 
                    method: 'GET',
                    requestOptions: { // ✅ 명확한 옵션 추가
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin' // ✅ CORS 문제 방지
                    },
                    initParams:{ 
                        page: 1,
                        perPage: 10,
                        companyNum: companyNum
                    },
                    beforeRequest: function(request) {
                        console.log("📢 서버로 요청 보내기 전 requestParams:", request.params);
                    },
                    afterResponse: function(response) {
                        console.log("📢 서버 응답:", response);

                        if (response.data && response.data.contents) {
                            console.log("✅ 변환된 데이터:", response.data.contents);
                            return { data: response.data.contents, totalCount: response.data.pagination.totalCount };
                        }

                        console.warn("⚠️ 서버 응답에 contents가 없습니다.");
                        return { data: [], totalCount: 0 };
                    }

                }
            },
            contentType: 'application/json',
            serverSidePagination: true
        };
        
        console.log("✅ productDataSource 설정 완료:", productDataSource);

        productGrid = new tui.Grid({
            el: document.getElementById('productGrid'),
            data: productDataSource,  
            pageOptions: {
                useClient: false,
                perPage: 5,
            },
            bodyHeight: 'auto', 
            columns: [
                { header: "상품명", name: "goodsName", rowSpan: true },
                { header: "상품코드", name: "goodsCode", rowSpan: true }, 
                { header: "옵션명", name: "optionName" },
                { header: "옵션번호", name: "optionCode" },
                { header: "브랜드", name: "brandName" },
                { header: "규격", name: "goodsStandard"},
                { header: "대표이미지", name: "goodsImage", align: "center", rowSpan: true }
            ]
        });
        
        console.log("✅ Toast Grid 초기화 완료");

}

// 표시 수량 변경
function changeProductDisplay() {
    let gap = parseInt(document.querySelector('#product_display_amount').value);
    productGrid.setPerPage(gap);
    productGrid.reloadData();
}

// 검색 실행
function productSearch() {
    let goodsName = document.querySelector('#searchGoodsName').value;
    let brandName = document.querySelector('#searchBrandName').value;

    productGrid.setRequestParams({
        "companyNum": [[${session.companyNum}]],
        "goodsName": goodsName,
        "brandName": brandName
    });

    productGrid.reloadData();
}

// 필터 초기화
function resetFilters() {
    document.querySelector('#searchGoodsName').value = '';
    document.querySelector('#searchBrandName').value = '';
    document.querySelector('#product_display_amount').value = '10';

    productGrid.setRequestParams({
        "companyNum": companyNum,
        "goodsName": '',
        "brandName": ''
    });

    productGrid.reloadData();
}
</script>


</body>




