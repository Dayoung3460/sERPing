<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}"
      lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>발주서 / 발주서 등록</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Toast Grid CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/tui.grid/latest/tui-grid.css">
    
    <!-- jQuery & Toast Grid JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://uicdn.toast.com/tui.grid/latest/tui-grid.js"></script>

    <style>
        .form-control { width: 100%; }
        
        .button-container { margin-top: 15px; }
        #custom-container{
		background-color: #f8f9fa; /* 연한 회색 배경 */
		padding: 20px;
		border-radius: 10px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* 박스 그림자 */
		margin-bottom: 20px;
	
		}
        #grid { height: 300px; }
    </style>
</head>
<body layout:fragment="content">
<div class="container mt-4" >
<h2 class="mb-4">발주서 등록</h2>
	<div class="container">
	    <!-- 🔹 발주서 정보 -->
	    <div id="custom-container">
	        <div class="row g-3">
	            <div class="col-md-3">
	                <label class="form-label">일자</label>
	               <input type="date" class="form-control" th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" readonly>
	            </div>
	            <div class="col-md-3">
	                <label class="form-label">담당자</label>
	                <input type="text" class="form-control" th:value="${session.employeeName}" readonly>
	            </div>
	            <div class="col-md-3">
	                <label class="form-label">납기일자</label>
	                <input type="date" class="form-control" th:value="${PurchaseDTO.puchaseDueDate}">
	            </div>
	        </div>
	
	        <!-- 🔹 부가세율(VAT) 선택 -->
	        <div class="d-flex align-items-center mt-3">
	            <div class="form-check me-3">
	                <input class="form-check-input" type="checkbox" id="vatUnchecked">
	                <label class="form-check-label" for="vatUnchecked">부가세율(VAT) 미적용</label>
	            </div>
	            <div class="form-check">
	                <input class="form-check-input" type="checkbox" id="vatChecked" checked>
	                <label class="form-check-label" for="vatChecked">부가세율(VAT) 적용</label>
	            </div>
	        </div>
	    </div>
	
	    <!-- 🔹 버튼 -->
	    <div class="mb-3 d-flex justify-content-between">
	        <div>
	            <button class="btn btn-secondary">주문서 조회</button>
	            <button class="btn btn-secondary">재고 조회</button>
	            <button class="btn btn-secondary">계획 조회</button>
	        </div>
	        <button class="btn btn-primary" id="bttAdd">발주 추가</button>
	    </div>
	
	    <!-- 🔹 Toast Grid -->
	    <div id="grid"></div>
	    <div id="pagination" class="tui-pagination"></div>
        
	 
	    <!-- 🔹 저장 및 초기화 버튼 -->
	    <div class="button-container text-center mt-3">
	        <button class="btn btn-success">저장</button>
	        <button class="btn btn-secondary">초기화</button>
	    </div>
	</div>
	
</div>


<script>

let grid;
const header = document.querySelector('meta[name="_csrf_header"]').content;
const token = document.querySelector('meta[name="_csrf"]').content;

document.addEventListener("DOMContentLoaded", function(){
	
	var Grid = tui.Grid;
	const dataSource = [];
	  // Toast Grid 데이터 설정
  	grid = new Grid({
        el: document.getElementById('grid'),
       
        columns: [
       
            { header: '상품코드', name: 'goodsCode' },
            { header: '상품명', name: 'goodsName' },
            { header: '옵션코드', name: 'optionCode'},
            { header: '옵션명', name: 'optionName'},
            { header: '거래처명', name: 'vendorName'},
            { header: '규격', name: 'goodsStandard'},
            { header: '수량', name: 'puchaseQuantity'},
            { header: '단가', name: 'puchaseUnitPrice'},
            { header: '공급가격', name: 'puchaseSupplyPrice'},
            { header: '부가세', name: 'puchaseVat'}
        ],
        rowHeaders: ['checkbox'],
        data : dataSource,
        scrollX: true,
        scrollY: 300
    });
    
    const bttAdd = document.getElementById("bttAdd");
    
    bttAdd.addEventListener("click", function () {
       grid.appendRow({}, { at: 0 }); // 빈 행 추가
    });
    
 	/* //상품 선택 시 적용될 데이터 예시
    function onProductSelect(selectedProduct) {
        // 현재 선택된 rowKey 가져오기
        const rowKey = grid.getFocusedCell().rowKey;
        
        if (rowKey === null) {
            alert("행을 먼저 선택하세요!");
            return;
        }

        // 선택된 상품 정보를 여러 칸(column)에 적용
        grid.setValue(rowKey, "goodsCode", selectedProduct.goodsCode);
        grid.setValue(rowKey, "goodsName", selectedProduct.goodsName);
        grid.setValue(rowKey, "optionCode", selectedProduct.optionCode);
        grid.setValue(rowKey, "optionName", selectedProduct.optionName);
        grid.setValue(rowKey, "vendorName", selectedProduct.vendorName);
        grid.setValue(rowKey, "goodsStandard", selectedProduct.goodsStandard);
        grid.setValue(rowKey, "goodsPrice", selectedProduct.goodsPrice);
        grid.setValue(rowKey, "goodsSupplyPrice", selectedProduct.goodsSupplyPrice);
    }
 	
    //상품 및 옵션 칸 클릭 하면 정보리스트 모달 출력 
    grid.on("click", (ev) => {
    if (ev.columnName === "goodsName" || ev.columnName === "goodsCode" || ev.columnName === "optionName" || ev.columnName === "optionCode") {
        openProductModal(ev.rowKey);
	    }
	});
	
    //모달이 열린 후 작업 
    function openProductModal(rowKey){
    	 sessionStorage.setItem("selectedRowKey", rowKey);
    	 let selectedRowKey = parseInt(sessionStorage.getItem("selectedRowKey"), 10);
    	 
    	 

    	    // 모달 요소 가져오기
    	    const modalElement = document.getElementById('goodsModal');
    	    if (!modalElement) {
    	        console.error("warehouseModal 요소를 찾을 수 없습니다.");
    	        return;
    	    }
    	    

    	    // 창고 그리드가 정의되어 있는지 확인 후 데이터 갱신
    	    if (typeof productGrid !== 'undefined' && productGrid !== null) {
    	        console.log("📢 창고 모달: 데이터 초기화 및 새로고침 시작");
    	
    	        // 기존 데이터 초기화
    	    
    	        let Data = productGrid.getData();
    	        console.log("그리드데이터",Data)
    	        console.log(bootstrap.Version);

    	        
    	        productGrid.readData();
    	        
    	        setTimeout(() => {
    	        	productGrid.refreshLayout();  // 기존 데이터 초기화
    	        	
    			}, 500);
   

    	        // 데이터를 다 불러온 후 모달 열기 (onGridUpdated 이벤트 활용)
    	         productGrid.on("onGridUpdated", function () {
    	            console.log("창고 모달: 데이터 새로고침 완료");
    	            

    	            // 데이터 로드 완료 후 모달 열기
    	            const modalInstance = new bootstrap.Modal(modalElement);
    	            modalInstance.show(); // 모달 열기
    	            
    	            
    	            console.log("창고 모달 열림:", rowKey);
    	        }); 
    	    } else {
    	        console.warn("warehouseGrid가 정의되지 않았습니다.");
    	    } 
    }
    
  */
    
})

  
</script>

</body>
</html>