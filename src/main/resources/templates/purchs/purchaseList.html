<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
 
 <head>


<!-- pdf ìº”ë²„ìŠ¤ ì„¤ì • -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
  // PDF.js ì›Œì»¤ ê²½ë¡œ ì„¤ì •
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';

</script>



 	<style>
    /* âœ… ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #custom-container {
        background-color: white; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* ë°•ìŠ¤ ê·¸ë¦¼ì */
        margin-bottom: 20px;
    }
    
    /* âœ… ê²€ìƒ‰ ë°” ìŠ¤íƒ€ì¼ */
    .search-container { margin-bottom: 15px; }
    .btn-search { background-color: #28a745; color: white; }
    .btn-reset { background-color: #007bff; color: white; }
    
    /* âœ… í…Œì´ë¸” & ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
    .tui-grid-container {
        border: 1px solid #ddd !important;
        border-radius: 5px;
        overflow: hidden;
    }

    .tui-grid-header-cell {
        background-color: #f1f1f1 !important;
        font-weight: bold;
        text-align: center;
        border-right: 1px solid #ddd !important;
    }

    .tui-grid-cell {
        border-right: 1px solid #ddd !important;
        border-bottom: 1px solid #ddd !important;
    }

    .tui-grid-cell:hover {
        background-color: #f9f9f9 !important;
    }

    /* âœ… í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
    .pagination-container {
        text-align: center;
        margin-top: 15px;
    }
    
	    .pdf-container {
	  max-width: 800px;       /* ìµœëŒ€ ë„ˆë¹„ 800px */
	  margin: 0 auto;         /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
	  display: flex;
	  justify-content: center;/* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ (ë‚´ë¶€ ì½˜í…ì¸  ì¤‘ì•™ ë°°ì¹˜) */
	  align-items: center;    /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
	  height: 1000px;          /* ì›í•˜ëŠ” ë†’ì´ (ì˜ˆ: 600px) */
	  border: 1px solid #ccc; /* í•„ìš” ì‹œ í…Œë‘ë¦¬ ì¶”ê°€ */
	  background-color: #f9f9f9;
	}
	
	#pdfCanvas {
	  width: 100%;            /* ì»¨í…Œì´ë„ˆ ë„ˆë¹„ì— ë§ì¶¤ */
	  height: auto;           /* ë¹„ìœ¨ ìœ ì§€ */
	  max-height: 100%;       /* ì»¨í…Œì´ë„ˆ ë†’ì´ ë‚´ì—ì„œ ì œí•œ */
	}
    
 
  /* ìŠ¤í”¼ë„ˆë¥¼ í™”ë©´ ì¤‘ì•™ì— ë°°ì¹˜ */
  .spinner-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* ë°˜íˆ¬ëª… ë°°ê²½ */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1050;
  }
  
 
    
   
</style>
 	
 </head>     
<body layout:fragment="content">


<div class="container mt-4">
  <h2 class="mb-4" style="font-weight: 900;">ë°œì£¼ì„œ ì¡°íšŒ</h2>
  <hr>
  <!-- ê²€ìƒ‰ ë°” í•œ ì¤„ ì •ë ¬ -->
  <div id="custom-container" class="mb-3">
    <div class="row g-2 align-items-center">
      <div class="col-auto">
        <label for="searchGoodsName" class="form-label">ìƒí’ˆëª…</label>
        <input type="text" id="searchGoodsName" class="form-control" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>
      <div class="col-auto">
        <label for="searchPurchaseNum" class="form-label">ë°œì£¼ë²ˆí˜¸</label>
        <input type="text" id="searchPurchaseNum" class="form-control" placeholder="ë°œì£¼ë²ˆí˜¸ ì…ë ¥">
      </div>
      <div class="col-auto">
        <label class="form-label">ë°œì£¼ì¼ì</label>
        <div class="input-group">
          <input type="date" id="searchStartDate" class="form-control">
          <span class="input-group-text">~</span>
          <input type="date" id="searchEndDate" class="form-control">
        </div>
      </div>
      <div class="col-auto">
        <label for="purchase_display_amount" class="form-label">í‘œì‹œìˆ˜ëŸ‰</label>
        <select id="purchase_display_amount" class="form-select" onchange="changeProductDisplay()">
          <option value="10" selected>10</option>
          <option value="20">20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div class="col-auto ">
        <button type="button" class="btn btn-primary" onclick="purchaseSearch()">ê²€ìƒ‰</button>
      </div>
      <div class="col-auto">
        <button type="button" class="btn btn-secondary" onclick="resetFilters()">ì´ˆê¸°í™”</button>
      </div>
    </div>
  </div>
  
  <!-- ë‚˜ë¨¸ì§€ í˜ì´ì§€ ë‚´ìš©... -->
  
   <!-- âœ… ë°œì£¼ì„œ ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” -->
    <div id="table-container" class="mt-3">
        <div id="purchaselistGrid"></div>
        <div id="pagination" class="tui-pagination"></div>
    </div>
    
    <!--  ë°œì£¼ì„œ ëª¨ë‹¬ -->
		    <div th:include="purchs/modal/ModalTemplate :: ModalTemplate (
		    'printModal', 
		    'modal-xl', 
		    'ë°œì£¼ì„œ ì¡°íšŒ', 
		    'purchs/modal/purchaseForm', 
		    'purchs/modal/purchaseFooter'
		    )"></div>
    <!--  ë©”ì¼ ëª¨ë‹¬ -->
		    <div th:include="purchs/modal/ModalTemplate :: ModalTemplate (
		    'mailsenderModal', 
		    'modal-xl', 
		    'EMAIL', 
		    'purchs/modal/mailsender', 
		    'purchs/modal/mailFooter'
		    )"></div>
    
    
    <!-- ë°œì£¼ì„œ ë“±ë¡ ë²„íŠ¼ -->
     <!-- ë°œì£¼ì„œ ë“±ë¡ ë° Excel ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
	<div class="d-flex justify-content-end gap-2 mt-3">
	    <a th:href="@{/purchs/purchaseRegister(menu='inventory')}" class="btn btn-success btn-custom">ë°œì£¼ë“±ë¡</a>
	    <button class="btn btn-dark" onClick="downExcel()">Excel</button>
	</div>

    
  
</div>

    
   





<script>



// (1) PDF.jsë¡œ PDF íŒŒì¼ì„ ìº”ë²„ìŠ¤ì— ë Œë”ë§
	function renderPDF(reportUrl) {
	  const canvas = document.getElementById('pdfCanvas');
	  const context = canvas.getContext('2d');
	
	  // PDF ë¡œë“œ
	  pdfjsLib.getDocument(reportUrl).promise.then(pdf => {
	    console.log('PDF loaded, total pages:', pdf.numPages);
	    // ì²« í˜ì´ì§€ë§Œ ë Œë”ë§ (í•„ìš”ì‹œ ì—¬ëŸ¬ í˜ì´ì§€ ì§€ì› ê°€ëŠ¥)
	    pdf.getPage(1).then(page => {
	      const scale = 1.5; // í™•ëŒ€/ì¶•ì†Œ ë¹„ìœ¨
	      const viewport = page.getViewport({ scale });
	      // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
	      canvas.width = viewport.width;
	      canvas.height = viewport.height;
	
	      // í˜ì´ì§€ ë Œë”ë§
	      const renderContext = {
	        canvasContext: context,
	        viewport: viewport
	      };
	      page.render(renderContext).promise.then(() => {
	        console.log('Page rendered');
	      });
	    });
	  }).catch(error => {
	    console.error('PDF ë¡œë“œ ì˜¤ë¥˜:', error);
	  });
	}
	
  // 2. ì»¤ìŠ¤í…€ ë Œë”ëŸ¬ í´ë˜ìŠ¤ ì •ì˜ (ìµœìƒë‹¨)
  class CustomTextRenderer {
      constructor(props) {
          const el = document.createElement('div');
          el.innerText = props.value;
          el.style.padding = '10px';
          el.style.fontWeight = 'bold';
          el.style.textAlign = 'left';
          this.el = el;
      }
      getElement() {
          return this.el;
      }
  }
	//ì‚¬ìš©ì ì •ì˜ ì´ë©”ì¼ ë²„íŠ¼ ë Œë”ëŸ¬ ì •ì˜
  class EmailRenderer {
      constructor(props) {
          const el = document.createElement('button');
          el.textContent = 'EMAIL';
          el.className = 'btn btn-outline-warning btn-sm';
          el.addEventListener('click', () => {
              //console.log("ë©”ì¼ ì „ì†¡ ë²„íŠ¼ í´ë¦­");
              const focusedCell = purchaselistGrid.getFocusedCell();
              if (!focusedCell) {
                  showAlert("ë¨¼ì € ë°œì£¼ í–‰ì„ ì„ íƒí•˜ì„¸ìš”.","danger");
                  return;
              }
              const rowData = purchaselistGrid.getRow(focusedCell.rowKey);
              if (!rowData) {
                  showAlert("ì„ íƒëœ í–‰ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.","danger");
                  return;
              }
              
              // vendor_emailê³¼ employee_email ì»¬ëŸ¼ëª…ì´ ì‹¤ì œ ë°ì´í„°ì— ë§ê²Œ ì¡°ì •í•˜ì„¸ìš”.
              const vendorEmail = rowData.vendor_email || rowData.vendorEmail;
              const employeeEmail = rowData.employee_email || rowData.employeeEmail;
              
              if (!vendorEmail || !employeeEmail) {
                  showAlert("ë©”ì¼ ì „ì†¡ì— í•„ìš”í•œ ì´ë©”ì¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.","danger");
                  return;
              }
              
              // sessionStorageì— ì €ì¥
              sessionStorage.setItem("vendorEmail", vendorEmail);
              sessionStorage.setItem("employeeEmail", employeeEmail);
            
              //console.log("vendorEmail:", vendorEmail, "employeeEmail:", employeeEmail);
              
              // mailsender ëª¨ë‹¬ í‘œì‹œ
              const mailSenderModalEl = document.getElementById("mailsenderModal");
              if (mailSenderModalEl) {
                  const mailSenderModal = new bootstrap.Modal(mailSenderModalEl);
                  
                  mailSenderModal.show();
                  const fromEmailInput = document.getElementById("fromEmail");
                  const toEmailInput = document.getElementById("toEmail");

                  if (fromEmailInput) {
                      fromEmailInput.value = employeeEmail || "";
                      //console.log("âœ… fromEmail í•„ë“œ ê°’ ì„¤ì • ì™„ë£Œ:", fromEmailInput.value);
                  } else {
                	  showAlert("ë°œì‹ ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš” " ,"danger");
                      
                  }

                  if (toEmailInput) {
                      toEmailInput.value = vendorEmail || "";
                      //console.log("âœ… toEmail í•„ë“œ ê°’ ì„¤ì • ì™„ë£Œ:", toEmailInput.value);
                  } else {
                	  showAlert("ìˆ˜ì‹ ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš” " ,"danger");
                      
                  }
              } else {
                  console.error("ë©”ì¼ ì „ì†¡ ëª¨ë‹¬(mailsenderModal)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              }
          });
          this.el = el;
      }
      getElement() {
          return this.el;
      }
  }

  // (3) PrintRenderer ìˆ˜ì • â†’ PDF.js ë Œë”ë§
  class PrintRenderer {
      constructor(props = {}) {
          this.props = props; // ì „ë‹¬ë°›ì€ props ì €ì¥
          const el = document.createElement('a');
          el.innerText = "ì¡°íšŒ";
          el.style.color = "#007bff";
          el.style.cursor = "pointer";
          el.style.textDecoration = "underline";
          el.addEventListener("click", (e) => {
              e.preventDefault();
              // í˜„ì¬ í–‰ì˜ ë°ì´í„°
              const rowData = this.props.grid.getRow(this.props.rowKey);
              const purchaseNum = rowData ? rowData.purchaseNum : null;

              if (purchaseNum) {
                  sessionStorage.setItem("purchaseNum", purchaseNum);
                  //console.log("sessionStorage ì €ì¥ ì™„ë£Œ:", purchaseNum);
              } else {
                  console.warn("ë°œì£¼ë²ˆí˜¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
              }

              // Thymeleafì—ì„œ ë Œë”ë§ëœ íšŒì‚¬ë²ˆí˜¸
              const companyNum = [[${session.companyNum}]];

              // (1) PDF ìƒì„± ì—”ë“œí¬ì¸íŠ¸ (Jasper â†’ PDF)
              //     ì˜ˆ: '/purchs/report/report?companynum=...&purchasenum=...'
              //     (HTMLì´ ì•„ë‹ˆë¼ PDF ë°”ì´ë„ˆë¦¬ë¥¼ ë°˜í™˜í•´ì•¼ í•¨)
              const reportUrl = `/purchs/report/report?companynum=${companyNum}&purchasenum=${purchaseNum}`;
              //console.log("PDF URL:", reportUrl);

              // (2) PDF.jsë¡œ ìº”ë²„ìŠ¤ ë Œë”ë§
              renderPDF(reportUrl);

              // (3) ëª¨ë‹¬ í‘œì‹œ
              const printModalEl = document.getElementById('printModal');
              if (printModalEl) {
                  const printModal = new bootstrap.Modal(printModalEl);
                  printModal.show();
              } else {
                  console.error("ëª¨ë‹¬ ìš”ì†Œ(printModal)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              }
          });
          this.el = el;
      }
      getElement() {
          return this.el;
      }
  }
  //pdfë‹¤ìš´
  document.getElementById('pdfDown').addEventListener('click', function() {
	  // Thymeleafë¡œ ë Œë”ë§ëœ íšŒì‚¬ë²ˆí˜¸ (ì˜ˆ: 1)
	  const companyNum = [[${session.companyNum}]];
	  // ê·¸ë¦¬ë“œë‚˜ PrintRendererë¥¼ í†µí•´ sessionStorageì— ì €ì¥ëœ ë°œì£¼ë²ˆí˜¸ ì‚¬ìš©
	  const purchaseNum = sessionStorage.getItem("purchaseNum");
	  if (!purchaseNum) {
	    showAlert("ë°œì£¼ë²ˆí˜¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.","danger");
	    return;
	  }
	  // ë‹¤ìš´ë¡œë“œ ì—”ë“œí¬ì¸íŠ¸ URL êµ¬ì„± (/purchs/report/reportDownload ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©)
	  const downloadUrl = `/purchs/report/reportDownload?companynum=${companyNum}&purchasenum=${purchaseNum}`;
	  //console.log("Download URL:", downloadUrl);
	  // ë¸Œë¼ìš°ì €ë¥¼ í•´ë‹¹ URLë¡œ ì´ë™ì‹œì¼œ íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ìœ ë„
	  window.location.href = downloadUrl;
	});

  
  
  // 2. í˜ì´ì§€ ë¡œë“œ í›„ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
  document.addEventListener("DOMContentLoaded", function () {
      //console.log("âœ… ë°œì£¼ì„œ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”");
      initPurchaseGrid();
  });

  let purchaselistGrid;

  function initPurchaseGrid() {
      const companyNum = [[${session.companyNum}]];
      if (!companyNum) {
          //console.error("âŒ ì„¸ì…˜ì—ì„œ companyNum ê°’ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ.");
          return;
      }
      const purchaselistDataSource = {
          api: {
              readData: {
                  url: '/purchs/rest/purchase/list',
                  method: 'GET',
                  requestOptions: {
                      headers: { 'Content-Type': 'application/json' },
                      credentials: 'same-origin'
                  },
                  initParams: {
                      page: 1,
                      perPage: 10,
                      companyNum: companyNum
                  },
                 
              }
          },
          contentType: 'application/json',
          serverSidePagination: true
      };

      purchaselistGrid = new tui.Grid({
          el: document.getElementById('purchaselistGrid'),
          data: purchaselistDataSource,
          pageOptions: {
              useClient: false,
              perPage: 10
          },
          bodyHeight: 'auto',
          columns: [
              { header: "ë°œì£¼ë²ˆí˜¸", name: "purchaseNum", rowSpan: true,align: "right", renderer: { type: CustomTextRenderer } },
              { header: "ê³µê¸‰ì²˜ëª…", name: "vendorName" ,align: "left",},
              { header: "ë‹´ë‹¹ì", name: "employeeName" ,align: "center",},
              { header: "ìƒí’ˆëª…", name: "goodsName" ,align: "left" ,minWidth: 200},
              { header: "ì˜µì…˜ëª…", name: "optionName" ,align: "left"},
              { header: "ê¸ˆì•¡", name: "purchaseTotalAmount",align: "right" ,formatter:(row)=>numberFormat(row.value)},
              { header: "ë°œì£¼ìƒíƒœ", name: "purchaseStatus",align: "center" },
              { header: "ë°œì£¼ì„œ", name: "print", renderer: { type: PrintRenderer },align: "center" },
              { header: "EMAIL", name: "email", align: "center",renderer: { type: EmailRenderer }, cellStyle: { textAlign: "center" } }
          ]
      });

    
      
   // âœ… ë°œì£¼ì„œ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
      purchaselistGrid.on("click", function(event) {
          const rowKey = event.rowKey;
          const columnName = event.columnName;
          const rowData = purchaselistGrid.getRow(rowKey);

          //console.log("âœ… ë°œì£¼ì„œ í´ë¦­:", rowData);

          // íŠ¹ì • ì»¬ëŸ¼ í´ë¦­ ì‹œ ì‹¤í–‰ (ì˜ˆ: purchaseNum, vendorName, goodsName ë“±)
          if (columnName === "purchaseNum" || columnName === "vendorName" || columnName === "goodsName") {
              const purchaseNum = rowData.purchaseNum;
              const companyNum = [[${session.companyNum}]]; // Thymeleafì—ì„œ ì„¸ì…˜ ê°’ ê°€ì ¸ì˜¤ê¸°

              if (purchaseNum && companyNum) {
                  const url = `/purchs/purchaseModify?purchaseNum=${purchaseNum}&companyNum=${companyNum}`;
                  window.location.href = url;
              } else {
                  console.error("ë°ì´í„°ê°€ ë¶€ì¡±í•˜ì—¬ í˜ì´ì§€ ì´ë™ ì‹¤íŒ¨", rowData);
              }
          }
      });

  }

  // 3. ê¸°íƒ€ í•¨ìˆ˜ë“¤ (ê²€ìƒ‰, í•„í„° ì´ˆê¸°í™”, í‘œì‹œ ìˆ˜ëŸ‰ ë³€ê²½ ë“±)
  function purchaseSearch() {
      let goodsName = document.querySelector('#searchGoodsName').value.trim();
      let purchaseNum = document.querySelector('#searchPurchaseNum').value.trim();
      let startDate = document.querySelector('#searchStartDate').value;
      let endDate = document.querySelector('#searchEndDate').value;
      purchaselistGrid.setRequestParams({
          "companyNum": [[${session.companyNum}]],
          "goodsName": goodsName,
          "purchaseNum": purchaseNum,
          "startDate": startDate,
          "endDate": endDate
      });
      purchaselistGrid.reloadData();
  }

  function changeProductDisplay() {
      let gap = parseInt(document.querySelector('#purchase_display_amount').value);
      purchaselistGrid.setPerPage(gap);
      purchaselistGrid.reloadData();
  }

  function resetFilters() {
      document.querySelector('#searchGoodsName').value = '';
      document.querySelector('#searchPurchaseNum').value = '';
      document.querySelector('#searchStartDate').value = '';
      document.querySelector('#searchEndDate').value = '';
      document.querySelector('#purchase_display_amount').value = '';
      purchaselistGrid.setRequestParams({
          "companyNum": companyNum,
          "goodsName": '',
          "purchaseNum": '',
          "startDate": '',
          "endDate": ''
      });
      purchaselistGrid.reloadData();
  }
  const modalElement = document.getElementById("printModal");
  const closeButton = modalElement.querySelector('[data-bs-dismiss="modal"]');
  if (closeButton) {
      closeButton.addEventListener("click", function () {
         

          try {
          	let modalInstance = bootstrap.Modal.getInstance("#printModal") || new bootstrap.Modal("#printModal");
              modalInstance.hide(); // âœ… Bootstrap ë°©ì‹ìœ¼ë¡œ ëª¨ë‹¬ ë‹«ê¸°
              
          } catch (error) {
             
              modalElement.classList.remove("show");
              modalElement.style.display = "none";
              document.body.classList.remove("modal-open");

              setTimeout(() => {
                  document.querySelectorAll(".modal-backdrop").forEach((element) => element.remove()); // ë°±ê·¸ë¼ìš´ë“œ ì œê±°
              }, 300);
           
          }
      });
  } else {
      console.warn("âŒ ì¸ì‡„ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
  
	//PDF ëª¨ë‹¬ ë‹«í˜ ì‹œ sessionStorageì˜ ë°œì£¼ë²ˆí˜¸ ì‚­ì œ (ì˜ˆ: printModal)
	  modalElement.addEventListener("hidden.bs.modal", function () {
	    
	      sessionStorage.removeItem("purchaseNum");
	  });
	
	
	
	
	// ë©”ì¼ ëª¨ë‹¬ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° (idê°€ "mailsenderModal"ì¸ ëª¨ë‹¬)
   const emailModal = document.getElementById("mailsenderModal");
	  if (emailModal) {
	    // ëª¨ë‹¬ ë‚´ë¶€ì—ì„œ ë‹«ê¸° ë²„íŠ¼(ì˜ˆ: data-bs-dismiss="modal" ì†ì„±)ì„ ì°¾ê¸°
	    const emailCloseBtn = emailModal.querySelector('[data-bs-dismiss="modal"]');
	    if (emailCloseBtn) {
	      emailCloseBtn.addEventListener("click", function () {
	        
	        // ì§ì ‘ í´ë˜ìŠ¤ ì œê±° ë°©ì‹ìœ¼ë¡œ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
	        emailModal.classList.remove("show");
	        emailModal.style.display = "none";
	        document.body.classList.remove("modal-open");
	        // ë§Œì•½ ëª¨ë‹¬ ë°±ë“œë¡­(overlay)ì´ ìˆë‹¤ë©´ ì œê±°
	        document.querySelectorAll(".modal-backdrop").forEach((element) => element.remove());
	        
	        sessionStorage.removeItem("vendorEmail");
		     sessionStorage.removeItem("employeeEmail");
	      });
	    } else {
	      console.warn(" ë©”ì¼ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	    }
	    
	    if (emailModal) {
	        const observer = new MutationObserver(() => {
	            if (!emailModal.classList.contains("show")) {
	               
	                sessionStorage.removeItem("vendorEmail");
	                sessionStorage.removeItem("employeeEmail");
	            }
	        });

	        observer.observe(emailModal, { attributes: true });

	        
	    } else {
	        console.warn("âŒ ë©”ì¼ ëª¨ë‹¬(mailsenderModal)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	    }
	    
	    // ëª¨ë‹¬ì´ ì™„ì „íˆ ë‹«íŒ í›„ sessionStorageì—ì„œ ì´ë©”ì¼ ê´€ë ¨ ê°’ì„ ì‚­ì œ
	   emailModal.addEventListener("hidden.bs.modal", function () {
	      
	      sessionStorage.removeItem("vendorEmail");
	      sessionStorage.removeItem("employeeEmail");
	    });
	  } else {
	    console.warn("âŒ ë©”ì¼ ëª¨ë‹¬(mailsenderModal)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	  }  
	  
	  function downExcel() {
		    if (!purchaselistGrid) {
		       
		        showAlert("ì—‘ì…€ ë‹¤ìš´ë¡œë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ì„¸ìš”.","danger");
		        return;
		    }

		    // ğŸ“¢ í˜„ì¬ ë‚ ì§œë¥¼ ê°€ì ¸ì™€ì„œ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
		    const today = new Date();
		    const formattedDate = today.toISOString().split('T')[0]; // "YYYY-MM-DD" í˜•ì‹

		    // ğŸ“¢ ëª¨ë“  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ í›„ íŠ¹ì • ì»¬ëŸ¼ ì œê±° í›„ ë‚´ë³´ë‚´ê¸°
		    const rawData = purchaselistGrid.getData(); // í˜„ì¬ ê·¸ë¦¬ë“œì˜ ëª¨ë“  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
		    console.log("ğŸ“¢ ì›ë³¸ ë°ì´í„° í™•ì¸:", rawData);

		    // ğŸ“¢ íŠ¹ì • ì»¬ëŸ¼(ë°œì£¼ì„œ, EMAIL) ì œê±°
		    const filteredData = rawData.map(({ print, email, ...rest }) => rest);
		    console.log("ğŸ“¢ í•„í„°ë§ëœ ë°ì´í„° í™•ì¸ (ë°œì£¼ì„œ, EMAIL ì œì™¸):", filteredData);

		    // ğŸ“¢ ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì˜µì…˜ ì„¤ì •
		    const options = {
		        fileName: `purchaseOrderlist_${formattedDate}.xlsx`, // âœ… í˜„ì¬ ë‚ ì§œ í¬í•¨ëœ íŒŒì¼ëª…
		        useFormattedValue: true, // í¬ë§·ëœ ê°’ ì ìš© (ì˜ˆ: 1,000 â†’ ì²œ ë‹¨ìœ„ êµ¬ë¶„ ìœ ì§€)
		        includeHiddenColumns: false, // ìˆ¨ê²¨ì§„ ì»¬ëŸ¼ ì œì™¸
		    };

		    try {
		        // ğŸ“¢ í•„í„°ë§ëœ ë°ì´í„°ë¡œ ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì‹¤í–‰
		        purchaselistGrid.export('xlsx', options, filteredData);
		        console.log(`âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì„±ê³µ! íŒŒì¼ëª…: purchaseOrderlist_${formattedDate}.xlsx`);
		    } catch (error) {
		        //console.error("âŒ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜ ë°œìƒ:", error);
		        showAlert("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.","danger");
		    }
		}



</script>

</body>

