<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
      
 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>제품 재고 / 제품 조회</title>

    <!-- CSS 라이브러리 -->
    <link rel="stylesheet" href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.css" />
    <link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
    <link rel="stylesheet" href="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.css" />
    <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
	<!-- JavaScript 라이브러리 -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.js"></script>
	<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
	<script src="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.js"></script>
	<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
	
    <style>
        .container { max-width: 1200px; margin: 20px auto; }
        .header-box { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px; }
        .search-container { margin-bottom: 15px; }
        .pagination-container { text-align: center; margin-top: 10px; }
        .btn-search { background-color: #28a745; color: white; }
        .btn-reset { background-color: #007bff; color: white; }
        .btn-register { background-color: #28a745; color: white; margin-top: 10px; }
    </style>
</head>
<body layout:fragment="content">

<div class="container">
    <!-- 검색 영역 -->
    <div class="header-box">
        <div class="row">
            <div class="col-md-5">
                <label class="form-label">상품명</label>
                <input type="text" class="form-control" id="searchGoodsName">
            </div>
            <div class="col-md-5">
                <label class="form-label">브랜드</label>
                <input type="text" class="form-control" id="searchBrandName">
            </div>
            <div class="col-5 row">
                <span class="label-search col-4">표시수량</span>
                <select id="product_display_amount" class="form-control" onchange="changeProductDisplay()">
                    <option value="5" selected>5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select> 
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-search w-50" onclick="productSearch()">검색</button>
                <button class="btn btn-reset w-50 ms-2" onclick="resetFilters()">초기화</button>
            </div>
        </div>
    </div>

    <!-- Toast Grid -->
    <div id="table-container">
        <div id="productGrid"></div>
        <div id="pagination" class="tui-pagination"></div>
    </div>

    <!-- 제품 등록 버튼 -->
    <div class="text-end">
        <button class="btn btn-register">제품 등록</button>
    </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
	console.log("DOMContentLoaded 이벤트 실행 = 스크립트 실행")
    initProductGrid();
});

let productGrid;

function initProductGrid() {
	
	console.log("initProductGrid()실행")
	
   /*  const companyNum = sessionStorage.getItem("companyNum");
	
	if (!companyNum) {
        console.error("❌ 세션에서 companyNum 값을 찾을 수 없음.");
        return; // companyNum이 없으면 요청을 하지 않음
    } */
    
    const companyNum = 1;

    console.log("✅ 설정된 companyNum:", companyNum);

    const productDataSource = {
        api: {  
            readData: { 
                url: 'http://localhost:81/purchs/rest/product/list', 
                method: 'GET',
                initParams: { 
                    page: 1,
                    perPage: 5,
                    companyNum: companyNum
                },
                beforeRequest: function(request) {
                    console.log("📢 서버로 요청 보내기 전 requestParams:", request.params);
                },
                afterResponse: function(response) {
                    console.log("📢 서버 응답:", response);
                }
            }
        },
        contentType: 'application/json',
        serverSidePagination: true
    };
    
    console.log("✅ productDataSource 설정 완료:", productDataSource);

    productGrid = new tui.Grid({
        el: document.getElementById('productGrid'),
        dataSource: productDataSource,  
        pageOptions: {
            useClient: false,
            perPage: 5,
        },
        columns: [
            { header: "상품명", name: "goodsName", rowSpan: true },
            { header: "상품코드", name: "goodsCode", rowSpan: true }, 
            { header: "옵션명", name: "optionName" },
            { header: "옵션번호", name: "optionCode" },
            { header: "브랜드", name: "brandName", rowSpan: true },
            { header: "규격", name: "goodsStandard", rowSpan: true },
            { header: "대표이미지", name: "goodsImage", align: "center", rowSpan: true }
        ]
    });
    
    console.log("✅ Toast Grid 초기화 완료");
}

// 표시 수량 변경
function changeProductDisplay() {
    let gap = parseInt(document.querySelector('#product_display_amount').value);
    productGrid.setPerPage(gap);
    productGrid.reloadData();
}

// 검색 실행
function productSearch() {
    let goodsName = document.querySelector('#searchGoodsName').value;
    let brandName = document.querySelector('#searchBrandName').value;

    productGrid.setRequestParams({
       "companyNum": sessionStorage.getItem("companyNum"),
        "goodsName": goodsName,
        "brandName": brandName
    });

    productGrid.reloadData();
}

// 필터 초기화
function resetFilters() {
    document.querySelector('#searchGoodsName').value = '';
    document.querySelector('#searchBrandName').value = '';
    document.querySelector('#product_display_amount').value = '5';

    productGrid.setRequestParams({
        "companyNum": sessionStorage.getItem("companyNum"),
        "goodsName": '',
        "brandName": ''
    });

    productGrid.reloadData();
}
</script>

</body>
</html>
