<html layout:decorate="~{layouts/layout}"
      lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
      

<body layout:fragment="content">
 
  

<style>
    /* ì „ì²´ ì»¨í…Œì´ë„ˆì˜ ìµœëŒ€ ë„ˆë¹„ ì¡°ì • */
    .container {
        max-width: 1200px; /* í™”ë©´ì´ ë„ˆë¬´ ì»¤ì§€ëŠ” ê²ƒ ë°©ì§€ */
        margin: 0 auto; /* ê°€ìš´ë° ì •ë ¬ */
    }

    /* ê²€ìƒ‰ í•„í„° ë° ë²„íŠ¼ ë°•ìŠ¤ */
    #custom-container {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        max-width: 100%;
    }

    /* Toast Grid í¬ê¸° ì¡°ì • */
    #productGrid, #myGrid {
        max-width: 100%;
        overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • */
        min-width: 100%;
    }

    /* Toast Grid ë‚´ë¶€ ìš”ì†Œ í¬ê¸° ì¡°ì • */
    .tui-grid-container {
        max-width: 100%;
        overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • */
        border-radius: 5px;
    }

    /* ë²„íŠ¼ í¬ê¸° ì¡°ì • */
    .btn-custom {
        width: auto;
        min-width: 120px;
        padding: 10px 20px;
    }

    /* ë°˜ì‘í˜• ì¡°ì • */
    @media (max-width: 1024px) {
        .container {
            max-width: 95%;
        }
        .tui-grid-container {
            max-width: 95%;
            min-width: auto;
            overflow-x: auto;
        }
    }

    @media (max-width: 768px) {
        .container {
            max-width: 100%;
        }
        .tui-grid-container {
            max-width: 100%;
            min-width: auto;
            overflow-x: auto;
        }
        .btn-custom {
            min-width: 100px;
            padding: 8px 16px;
        }
    }
    .label-search {
	    white-space: nowrap; /* âœ… ê¸€ìê°€ ì¤„ ë°”ê¿ˆë˜ì§€ ì•Šë„ë¡ ì„¤ì • */
	    font-weight: bold; /* âœ… ê°€ë…ì„±ì„ ìœ„í•´ ê¸€ì êµµê²Œ */
	}
    
    
 
</style>



<div class="container mt-4">
	<h2 class="mb-4" style="font-weight: 900;">ìƒí’ˆ ì¡°íšŒ</h2>
	<hr>
	   <!-- ê²€ìƒ‰ì°½ -->
	<div id="custom-container">
	    <div class="d-flex flex-wrap align-items-center gap-3 w-100">
	        <div class="d-flex align-items-center">
	            <span class="label-search me-3">ìƒí’ˆëª…</span>
	            <input type="text" name="goodsName" id="searchGoodsName" class="form-control" style="min-width: 150px;">
	        </div>
	        <div class="d-flex align-items-center">
	            <span class="label-search me-2">ë¸Œëœë“œëª…</span>
	            <input type="text" name="brandName" id="searchBrandName" class="form-control" style="min-width: 150px;">
	        </div>
	        <div class="d-flex align-items-center">
	            <span class="label-search me-2">í‘œì‹œìˆ˜ëŸ‰</span>
	            <select name="display_amount" id="product_display_amount" class="form-control" style="min-width: 100px;" onchange="changeProductDisplay()">
	                <option value="10" selected>10</option>
	                <option value="20">20</option>
	                <option value="50">50</option>
	                <option value="100">100</option>
	            </select>
	        </div>
	
	        <div class="d-flex align-items-center">
			    <span class="me-4 ms-2">ì‚¬ìš©ìœ ë¬´</span> <!-- ê¸°ì¡´ me-2 â†’ me-1 ë¡œ ì¤„ì„ -->
			    <div class="form-check me-1"> <!-- ê¸°ì¡´ me-2 â†’ me-1 ë¡œ ì¤„ì„ -->
			        <input class="form-check-input" type="checkbox" id="useGoods">
			        <label class="form-check-label" for="useGoods" style="margin-left: 3px;">ì‚¬ìš©</label> <!-- labelê³¼ ì²´í¬ë°•ìŠ¤ ê°„ê²© ì¡°ì • -->
			    </div>
			    <div class="form-check">
			        <input class="form-check-input" type="checkbox" id="unUseGoods">
			        <label class="form-check-label" for="unUseGoods" style="margin-left: 3px;">ì¤‘ì§€</label>
			    </div>
			</div>

	
	        <!-- ë²„íŠ¼ì„ ìš°ì¸¡ ì •ë ¬ -->
	        <div class="ms-auto d-flex gap-2">
	            <button type="button" class="btn btn-primary" onclick="productSearch()">ê²€ìƒ‰</button>
	            <button type="button" class="btn btn-secondary" onclick="resetFilters()">ì´ˆê¸°í™”</button>
	        </div>
	    </div>
	</div>
	
	<!-- ê·¸ë¦¬ë“œ -->
	<div id="table-container" class="mt-3">
	    <div id="productGrid"></div>
	</div>

    <!-- ì œí’ˆ ë“±ë¡ ë²„íŠ¼ -->
    <div class="text-end">
    	<a th:href="@{/purchs/goodsRegister(menu='inventory')}" class="btn btn-success btn-custom">ìƒí’ˆë“±ë¡</a>
	</div>

</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
	console.log("DOMContentLoaded ì´ë²¤íŠ¸ ì‹¤í–‰ = ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰")
    initProductGrid();
});
//âœ… í…ìŠ¤íŠ¸ë¥¼ êµµê²Œí•˜ê³  ì •ë ¬í•˜ëŠ” ë Œë”ëŸ¬
class CustomTextRenderer {
    constructor(props) {
        const el = document.createElement('div');
        el.innerText = props.value;
        el.style.padding = '10px';
        el.style.fontWeight = 'bold';
        el.style.textAlign = 'left';
        this.el = el;
    }
    getElement() {
        return this.el;
    }
}

//âœ… ëŒ€í‘œì´ë¯¸ì§€ë¥¼ í‘œì‹œí•˜ëŠ” ë Œë”ëŸ¬
 class ImageRenderer {
    constructor(props) {
        const el = document.createElement('div');
        el.style.textAlign = 'center';
        
        if (props.value) {
            el.innerHTML = `<img src="/image/${props.value}" 
                            alt="ìƒí’ˆ ì´ë¯¸ì§€" width="100" height="100" 
                            style="border-radius: 5px; object-fit: cover;">`;
        } else {
            el.innerText = "ì´ë¯¸ì§€ ì—†ìŒ";
            el.style.color = "#888"; // íšŒìƒ‰ ê¸€ì”¨
        }
        
        this.el = el;
    }
    
    getElement() {
        return this.el;
    }
}

let productGrid;
//í˜„ì¬ ê·¸ë¦¬ë“œì— ê°•ì¡°ëœí–‰ì„ ê¸°ë¡í•  ë³€ìˆ˜
let selectedRowKey = null;

function initProductGrid() {
	
	console.log("initProductGrid()ì‹¤í–‰")

    const companyNum = [[${session.companyNum}]];
  

	if (!companyNum) {
        console.error("âŒ ì„¸ì…˜ì—ì„œ companyNum ê°’ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ.");
        return; // companyNumì´ ì—†ìœ¼ë©´ ìš”ì²­ì„ í•˜ì§€ ì•ŠìŒ
    } 
    
    //const companyNum = 1;

    console.log("âœ… ì„¤ì •ëœ companyNum:", companyNum);

    const productDataSource = {
            api: {  
                readData: { 
                    url: '/purchs/rest/product/list', 
                    method: 'GET',
                    requestOptions: { // âœ… ëª…í™•í•œ ì˜µì…˜ ì¶”ê°€
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin' // âœ… CORS ë¬¸ì œ ë°©ì§€
                    },
                    initParams:{ 
                        page: 1,
                        perPage: 10,
                        companyNum: companyNum
                    },
                    beforeRequest: function(request) {
                        console.log("ğŸ“¢ ì„œë²„ë¡œ ìš”ì²­ ë³´ë‚´ê¸° ì „ requestParams:", request.params);
                    },
                    afterResponse: function(response) {
                        console.log("ğŸ“¢ ì„œë²„ ì‘ë‹µ:", response);

                        if (response.data && response.data.contents) {
                            console.log("âœ… ë³€í™˜ëœ ë°ì´í„°:", response.data.contents);
                            return { data: response.data.contents, totalCount: response.data.pagination.totalCount };
                        }

                        console.warn("âš ï¸ ì„œë²„ ì‘ë‹µì— contentsê°€ ì—†ìŠµë‹ˆë‹¤.");
                        return { data: [], totalCount: 0 };
                    }

                }
            },
            contentType: 'application/json',
            serverSidePagination: true
        };
        
        console.log("âœ… productDataSource ì„¤ì • ì™„ë£Œ:", productDataSource);

        productGrid = new tui.Grid({
            el: document.getElementById('productGrid'),
            scrollX :false,
            scrollY : false,
            data: productDataSource,  
            pageOptions: {
                useClient: false,
                perPage: 5,
            },
            bodyHeight: 500,
            minBodyHeight: 300,  // âœ… ìµœì†Œ ë†’ì´ ì„¤ì •
            columns: [
                { header: "ìƒí’ˆëª…",
                  name: "goodsName", 
                  rowSpan: true,
                  align: "left",
                  renderer: {
                      type: CustomTextRenderer
                  },
                  className: "merged-cell"
                  },
                { header: "ìƒí’ˆì½”ë“œ", 
                  name: "goodsCode",
                  align: "left",
                  rowSpan: true,
                  renderer: {
                      type: CustomTextRenderer
                  },
                  className: "merged-cell"
                  }, 
                { header: "ì˜µì…˜ëª…", align: "left",name: "optionName" },
                { header: "ì˜µì…˜ë²ˆí˜¸", align: "left",name: "optionCode" },
                { header: "ë¸Œëœë“œ",align: "left", name: "brandName" },
                { header: "ê·œê²©",align: "center", name: "goodsStandard"},
                { header: "ëŒ€í‘œì´ë¯¸ì§€", 
                  name: "goodsImage", 
                  align: "center", 
                  rowSpan: true,
                  renderer: {
                      type: ImageRenderer
                  }
                }
            ],
            rowClassName: function(row) {
                return getRowColorClass(row);
            }
        });
        
        console.log("âœ… Toast Grid ì´ˆê¸°í™” ì™„ë£Œ");
        
     // âœ… ì˜µì…˜ëª… í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ ì´ë™ (goodsCode, companyNumë§Œ ì „ë‹¬)
        productGrid.on("click", function(event) {
            const rowKey = event.rowKey;
            const columnName = event.columnName;
            const rowData = productGrid.getRow(rowKey);
            console.log("í´ë¦­")
            
            if (columnName === "optionName" ||columnName === "optionCode" || columnName === "goodsName" || columnName === "goodsCode" ) {  // ì˜µì…˜ëª…ì„ í´ë¦­í–ˆì„ ë•Œë§Œ ì‹¤í–‰
                const goodsCode = rowData.goodsCode;
                const companyNum = [[${session.companyNum}]];

                if (goodsCode && companyNum) {
                	
                	const url = `/purchs/info?goodsCode=${goodsCode}&companyNum=${companyNum}`;
                	window.location.href = url;

                	
                } else {
                    console.error("âŒ ë°ì´í„°ê°€ ë¶€ì¡±í•˜ì—¬ í˜ì´ì§€ ì´ë™ ì‹¤íŒ¨", rowData);
                }
            }
        });



}

// í‘œì‹œ ìˆ˜ëŸ‰ ë³€ê²½
function changeProductDisplay() {
    let gap = parseInt(document.querySelector('#product_display_amount').value);
    productGrid.setPerPage(gap);
    productGrid.reloadData();
}

// ê²€ìƒ‰ ì‹¤í–‰
function productSearch() {
    let goodsName = document.querySelector('#searchGoodsName').value;
    let brandName = document.querySelector('#searchBrandName').value;
	
    let useGoods = document.querySelector('#useGoods').checked;
    let unUseGoods = document.querySelector('#unUseGoods').checked;
    
    productGrid.setRequestParams({
        "companyNum": [[${session.companyNum}]],
        "goodsName": goodsName,
        "brandName": brandName,
        "useGoods": useGoods,
        "unUseGoods": unUseGoods
    });

    productGrid.reloadData();
}

// í•„í„° ì´ˆê¸°í™”
function resetFilters() {
    document.querySelector('#searchGoodsName').value = '';
    document.querySelector('#searchBrandName').value = '';
    document.querySelector('#product_display_amount').value = '10';

    productGrid.setRequestParams({
        "companyNum": companyNum,
        "goodsName": '',
        "brandName": '',
        "useGoods": null,
        "unUseGoods": null
    });

    productGrid.reloadData();
}



</script>

</body>



