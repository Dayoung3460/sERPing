<!DOCTYPE html>
<html 
lang="en"
layout:decorate="~{layouts/layout}" 
xmlns:th="http://www.thymeleaf.org"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>

<head>
 
  <style>
  	#custom-container{
		background-color: #f8f9fa; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
		padding: 20px;
		border-radius: 10px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* ë°•ìŠ¤ ê·¸ë¦¼ì */
		margin-bottom: 20px;
	
	}
	/* ê·¸ë¦¬ë“œ ì„ íƒí•˜ë©´ ìƒê¸°ëŠ” ìƒ‰ìƒ */
	.tui-grid-row-highlight {
		    background-color: #f0f8ff !important; /* ì—°í•œ í•˜ëŠ˜ìƒ‰ */
	}
	
  </style>
  

</head>

<body layout:fragment="content">
  <!-- í˜ì´ì§€ ë‚´ìš© ì‹œì‘ -->
  <div class="container">
	
    <h2 class="mt-2 mb-2"><b>ì£¼ë¬¸ ë“±ë¡</b></h2>
	<hr>
    <!-- ğŸ” ê²€ìƒ‰ ì¡°ê±´ -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    
                        <div class="row align-items-center ">
                            <!-- ë¼ë””ì˜¤ ë²„íŠ¼ -->
                            <div class="col-2  gap-3">
                            	<label for="selectedOption">ë‚ ì§œ</label>
                                <select class="form-select" onclick="toggleDateInputs()" id="selectedOption" style="height: 38px;">
                                	<option value="">ì„ íƒ</option>
                                	<option value="orderDate">ì£¼ë¬¸ì¼ì</option>
                                	<option value="dueDate">ë‚©ê¸°ì¼ì</option>
                                </select>    
                                
                            </div>
                            <!-- ë‚ ì§œ ì…ë ¥ -->
                            <div class="col-auto gap-3">
                                <div>
                                	<label for="startDate">From</label>
                                    <input type="date" class="form-control" id="startDate" name="startDate" disabled>
                                </div>
                            </div>
                            <div class="col-auto gap-3">
                                <div>
                                	<label for="endDate">To</label>
                                    <input type="date" class="form-control" id="endDate" name="endDate" disabled>
                                </div>
                            </div>
                            <!-- TODO: í˜„ì¬ëŠ” DBì—ì„œ ì§€ì ëª…ë“¤ì„ ê°€ì ¸ì˜¤ê¸° ê³¤ë€í•´ì„œ ì§€ì ì„ DBì—ì„œ ê°€ì ¸ì˜¤ëŠ” ë™ì  ë°©ì‹ì´ ì•„ë‹ˆë¼ ì‘ì„±ëœ ì§€ì  ëª©ë¡ì—ì„œ ì¡°íšŒí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ í–ˆìŠµë‹ˆë‹¤-->
							<!-- ì´ ì½”ë“œë¥¼ ì €ë§ê³  ë³´ëŠ” ë¶„ì´ ìˆë‹¤ë©´, í”„ë¡œì íŠ¸ë¥¼ ê°™ì´í•´ì¤˜ì„œ ê³ ë§™ë‹¤ëŠ” ë§ì„ ì „í•´ë“œë¦¬ê³  ì‹¶ì–´ìš”!-->
                            <div class="col-3 form-group m-3">
							    <label for="inputBhf">ë°œì£¼ì§€ì </label>
							    <input type="text" class="form-control" id="inputBhf" placeholder="ë°œì£¼ì§€ì ì„ ì…ë ¥í•˜ì„¸ìš”">
							    <ul id="suggestionList" class="list-group" style="position: absolute; width: 95%; z-index: 1000; display: none;"></ul>
							    
							</div>
                            
                            <div class="col-auto  text-center mt-4 mx-5">
	                        	<button class="btn btn-primary mr-2" onclick="search()">ê²€ìƒ‰</button>
	                        	<button class="btn btn-secondary"        onclick="reset()">ì´ˆê¸°í™”</button>
                        	</div>
                            
                        </div>

            	</div>
        	</div>
        </div>
    </div>

    <!-- ğŸ“‹ ë°œì£¼ ìš”ì²­ ë¦¬ìŠ¤íŠ¸ & ì„ íƒí•œ ë°œì£¼ ìš”ì²­ ì •ë³´ -->
    <div class="row">
        <!-- ë°œì£¼ ìš”ì²­ ë¦¬ìŠ¤íŠ¸ -->
        <div class="col-md-9 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">ë°œì£¼ ìš”ì²­ ëª©ë¡</h4>
                    <p class="card-description"></p>
                    <div id="orderList"></div>
                    <!-- <div id="pagination" class="tui-pagination"></div> -->
                </div>
            </div>
        </div>

        <!-- ì„ íƒí•œ ë°œì£¼ ìš”ì²­ ì •ë³´ -->
        <div class="col-md-3 col-12 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">ë°œì£¼ ìš”ì²­ ì •ë³´</h5>
                    <p class="card-description"></p>
                    <div id="selectedOrder"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ“¦ ì„ íƒí•œ ë°œì£¼ ìƒì„¸ ì •ë³´ -->
    <div class="row">
        <div class="col-12 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">ë°œì£¼ ìƒí’ˆ ëª©ë¡</h5>
                    <p class="card-description"></p>
                    <div id="orderDetailList"></div>
                    <div id="pagination" class="tui-pagination"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- âœ… ìŠ¹ì¸ / ğŸš« ê±°ë¶€ ë²„íŠ¼ -->
    <div class="row mt-3">
        <div class="col-12 text-center">
            <button class="btn btn-primary" id="registerButton">ìŠ¹ì¸</button>
            <button class="btn btn-danger"  id="cancelButton">ì·¨ì†Œ</button>
        </div>
    </div>
    
    <!-- ëª¨ë‹¬ë“¤  (ëª¨ë‹¬ID, ëª¨ë‹¬ì‚¬ì´ì¦ˆ(modal-xl,...), ëª¨ë‹¬ì œëª©, ëª¨ë‹¬ë‚´ìš© HTML, ëª¨ë‹¬í’‹í„° HTML)-->
      
       
    <div th:include="bsn/modal/bsnModalTemplate :: ModalTemplate (
						    	'registerModal', 
						    	'modal-md', 
						    	'ì£¼ë¬¸ ë“±ë¡', 
						    	'bsn/modal/bsnOrdRegister', 
						    	'bsn/modal/bsnCheckModalFooter'
						    )">
     </div>
     
      
     <div th:include="bsn/modal/bsnModalTemplate :: ModalTemplate(
						    	'cancelModal', 
						    	'modal-md', 
						    	'ë°œì£¼ ê±°ë¶€ ë° ì·¨ì†Œ', 
						    	'bsn/modal/bsnOrdCancel', 
						    	'bsn/modal/bsnModalFooter')">
     </div>
     
    
    
</div>

      <!-- container ë -->

  <!-- í˜ì´ì§€ ë‚´ìš© ë -->
  
  	<!-- ì„¸ì…˜ì •ë³´ -->
  	  <script th:inline="javascript">
	  	let companyNum = [[${session.companyNum}]];
	  	let employeeNum = [[${session.employeeNum}]];
	  </script>
	  
	  <script>
	  
	  <!-- ê²€ìƒ‰ì°½ ë‚ ì§œ ë¹„í™œì„± -->
	  	function toggleDateInputs() {
	  		let enable = true;
	  		if(event.target.value == ''){
	  			enable= false;
	  		}
	      document.getElementById("startDate").disabled = !enable;
	      document.getElementById("endDate").disabled = !enable;
	      //console.log(companyNum);
	      //console.log(employeeNum);;
	      
	     
	    }
	 	// TODO: DB ì—°ë™ í›„ branchListë¥¼ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ë„ë¡ ê°œì„  í•„ìš”
	 	
	    const branches = ["ë¶€ì‚°ì ", "ëŒ€êµ¬ì ", "í™ëŒ€ì "];
	    const inputBhf = document.getElementById("inputBhf");
	    const suggestionList = document.getElementById("suggestionList");
	
	    inputBhf.addEventListener("input", function() {
	        let inputValue = this.value.toLowerCase();
	        suggestionList.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì‚­ì œ
	
	        if (inputValue.trim() === "") {
	            suggestionList.style.display = "none";
	            return;
	        }
	
	        let matchedBranches = branches.filter(branch => branch.toLowerCase().includes(inputValue));
	        
	        if (matchedBranches.length > 0) {
	            matchedBranches.forEach(branch => {
	                let listItem = document.createElement("li");
	                listItem.classList.add("list-group-item");
	                listItem.textContent = branch;
	                listItem.addEventListener("click", function() {
	                    inputBhf.value = branch;
	                    suggestionList.style.display = "none";
	                });
	                suggestionList.appendChild(listItem);
	            });
	
	            suggestionList.style.display = "block";
	        } else {
	            suggestionList.style.display = "none";
	        }
	    });
	
	    // í´ë¦­í•˜ë©´ ìë™ì™„ì„± ëª©ë¡ ë‹«ê¸°
	    document.addEventListener("click", function(event) {
	        if (!inputBhf.contains(event.target) && !suggestionList.contains(event.target)) {
	            suggestionList.style.display = "none";
	        }
	    });
	 	/////////////////////////
	  
	  
	    var Grid = tui.Grid;
	    var selectedRow = null; // ì„ íƒëœ ì£¼ë¬¸ ì •ë³´
	    var detailData = [];    // ìƒì„¸ ë°ì´í„° ì •ë³´
	    
	    

		
		const dataSource = {
				api: {
					readData: { url: '/bsn/rest/bhfOrder', method: 'GET', 
						initParams: { page: 1 }},
				},
				contentType: 'application/json'
			};
		//ìƒí’ˆ í…Œì´ë¸”
		const grid = new Grid({
				el: document.getElementById('orderList'), // ì»¨í…Œì´ë„ˆ ì—˜ë¦¬ë¨¼íŠ¸
				scrollX:false,
			    scrollY:false,
				pageOptions: {
				useClient: false,
				perPage: 10,
			},
			//rowHeaders: ['checkbox'],
			columns: [ 
				{ header : "ì£¼ë¬¸ì½”ë“œ", name : "orderCode", align: "left",},
				{ header : "ì§€ì ", name : "branchOfficeId", align: "left",},
				{ header : "ì£¼ë¬¸ì¼", name : "orderDate", formatter: ({ value }) => formatDate(value, 'order'), sortable : true, align: "center",},
				{ header : "ë‚©ê¸°ì¼", name : "dueDate", formatter: ({ value }) => formatDate(value, 'due'), sortable : true, align: "center",},
				{ header : "ë¹„ê³ ", name : "remark", formatter: ({ value }) => truncate(value, 10), align: "left",},
				//{ header : "íšŒì‚¬ë²ˆí˜¸", name : "companyNum"},
			],
			data: dataSource
		});
		
		//ê·¸ë¦¬ë“œ ë‚ ì§œ í˜•ì‹ ë³€ê²½(ë°ì´í„° ìˆ˜ì •X, í‘œê¸°ë§Œ)
		function formatDate(dateString, type) {
		    if (!dateString) return ''; // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
		    const date = new Date(dateString);
		    if (isNaN(date)) return dateString; // ë‚ ì§œ ë³€í™˜ì´ ì‹¤íŒ¨í•˜ë©´ ì›ë³¸ ìœ ì§€

		    return type === 'order' 
		        ? `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
		        : date.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' })
	            .replace(/\. /g, '-')  // "2025. 02. 17." â†’ "2025-02-17"
	            .replace(/\.$/, '');
		}
		
		// remark ë‚´ìš©ì´ ê¸¸ë©´ ìë¥´ëŠ” í•¨ìˆ˜
		function truncate(value, maxLength) {
		  if (!value) return "";
		  return value.length > maxLength ? value.slice(0, maxLength) + "..." : value;
		}
		
	  	
		//<!-- ë°œì£¼ë¥¼ ì„ íƒí•˜ë©´ ì„ íƒí•œ ì£¼ë¬¸ ì½”ë“œë¡œ ìƒì„¸ ì •ë³´ ë¡œë“œ -->
		let selectedRowKey = null;
		
		grid.on('click', (ev) => {
			const rowKey = ev.rowKey;
			if (rowKey === null || rowKey === undefined) {
		        return;
		    }
			
			//ì„ íƒí•œ í‚¤ê°€ ìˆë‹¤ë©´ ìƒ‰ê°•ì¡° ì œê±°
		    if (selectedRowKey !== null) {
		    	grid.removeRowClassName(selectedRowKey, 'tui-grid-row-highlight');
		    }
		    
		 	// í´ë¦­í•œ í–‰ì— ê°•ì¡° íš¨ê³¼ ì¶”ê°€ + í˜„ì¬ ì„ íƒí•œ í‚¤ ë“±ë¡
			grid.addRowClassName(ev.rowKey, 'tui-grid-row-highlight');
			selectedRowKey = ev.rowKey;
			
			selectedRow = grid.getRow(rowKey);
			
			
			if (selectedRow) {
		        document.querySelector('#selectedOrder').innerHTML = `
		            <p><strong>ì£¼ë¬¸ ì½”ë“œ:</strong> ${selectedRow.orderCode}</p>
		            <p><strong>ì§€ì :</strong> ${selectedRow.branchOfficeId}</p>
		            <p><strong>ì£¼ë¬¸ì¼:</strong> ${formatDate(selectedRow.orderDate, 'order')}</p>
		            <p><strong>ë‚©ê¸°ì¼:</strong> ${formatDate(selectedRow.dueDate, 'due')}</p>
		            ${selectedRow.remark ? `<p><strong>ë¹„ê³ :</strong> ${selectedRow.remark}</p>` : ''}
		        `;
		        
		    }
			
			
		    if (selectedRow && selectedRow.orderCode) { // orderCodeê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
		        loadOrderDetails(selectedRow.orderCode);
		        console.log("ì„ íƒëœ ì£¼ë¬¸ ì½”ë“œ:", selectedRow.orderCode);
		        
		    } else {
		        console.warn("ì„ íƒëœ ì£¼ë¬¸ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");
		    }
		});
		
		function loadOrderDetails(orderCode) {
		    if (!orderCode) {
		        console.warn("ìœ íš¨í•˜ì§€ ì•Šì€ ì£¼ë¬¸ ì½”ë“œì…ë‹ˆë‹¤.");
		        return;
		    }
		    detailGrid.readData(1, {orderCode});
		    /*
		    fetch(`/bsn/rest/bhfOrder/detail?orderCode=${orderCode}&perPage=5&page=1`)
		        .then(response => {
		            if (!response.ok) throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ: ${response.status}`);
		            return response.json();
		        })
		        .then(data => {
		            if (data && data.data && data.data.contents) {
		            	detailData = data.data.contents; // ìƒì„¸ ë°ì´í„° ì €ì¥
		            	//
		                detailGrid.resetData(data.data.contents);
		            } else {
		                console.warn("ìƒì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
		                detailGrid.resetData([]); // ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
		                //
		                detailGrid.resetData(detailData);
		            }
		        })
		        .catch(error => console.error('Error:', error));
		    */
		}

		
		const detailDataSource = {
				api: {
					readData: { url: '/bsn/rest/bhfOrder/detail', method: 'GET', 
						initParams: { page: 1, orderCode:"0" }},
				},
				contentType: 'application/json'
		};
		
		const detailGrid = new Grid({
		    el: document.getElementById('orderDetailList'),
		    scrollX:false,
		    scrollY:false,
		    pageOptions: {
		        useClient: false,
		        perPage: 5,
		    },
		    data:detailDataSource,
		    columns: [
		        //{ header: "ë°œì£¼ìƒì„¸ì½”ë“œ", name: "orderDetailCode", },
		        //{ header: "ìƒí’ˆì½”ë“œ", name: "goodsCode" },
		        { header: "ìƒí’ˆì´ë¦„", name: "goodsName", align: "left", },
		        //{ header: "ì˜µì…˜ì½”ë“œ", name: "optionCode" },
		        { header: "ì˜µì…˜ëª…", name: "optionName", align: "left", },
		        { header: "ê·œê²©", name: "goodsStandard", align: "left", },
		        { header: "ìˆ˜ëŸ‰(box)", name: "quantity", align: "right", },
		    ]
		});
		
		//í˜ì´ì§€ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì „ì²´ ê²€ìƒ‰
		document.addEventListener('DOMContentLoaded', function() {
			REnodata();
		    REDnodata();
			
		    search();  // DOMContentLoaded ì´ë²¤íŠ¸ í›„ ìë™ìœ¼ë¡œ ê²€ìƒ‰ ì‹¤í–‰
		    
		});

		//ê²€ìƒ‰
		function search(){
			let selectedOption = document.getElementById('selectedOption').value; 
		    let startDate = document.getElementById("startDate").value; // ì‹œì‘ ë‚ ì§œ
		    let endDate = document.getElementById("endDate").value; // ë ë‚ ì§œ
		    //let selectedBhf = document.getElementById("selectBhf").value; // ë°œì£¼ì§€ì  ì„ íƒ ê°’
		    let selectedBhf = document.getElementById("inputBhf").value; // ë°œì£¼ì§€ì  í…ìŠ¤íŠ¸ ì…ë ¥ ê°’
		    
		    //console.log(selectedOption, startDate, endDate, selectedBhf);
		    
		    let params = {
		    		"companyNum": companyNum,
		    		"deteOption": selectedOption,
		            "startDate": startDate,
		            "endDate": endDate,
		            "branch": selectedBhf
		    };
		    
		    //console.log("ê²€ìƒ‰ ì¡°ê±´:", params);
		    
		 	grid.readData(1, params, true);
		 	refreshOrderGrid();
		   
		}
		
		//ê²€ìƒ‰ ì¡°ê±´ ì´ˆê¸°í™”
		function reset(){
			// ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ ê°’ ì´ˆê¸°í™”
		    // "ì‚¬ìš©ì•ˆí•¨" ë¼ë””ì˜¤ ë²„íŠ¼ì„ ì²´í¬í•˜ë„ë¡ ì„¤ì •
		    let notSelectRadio = document.getElementById('selectedOption'); 
			//.value
		    if (notSelectRadio) {
		    	notSelectRadio.value = "";   // "ì‚¬ìš©ì•ˆí•¨" ë¼ë””ì˜¤ ë²„íŠ¼ì„ ì„ íƒ ìƒíƒœë¡œ
		        toggleDateInputs();  // ë‚ ì§œ ì…ë ¥ ë¹„í™œì„±í™”
		    }
			

			// ì‹œì‘ ë‚ ì§œì™€ ë ë‚ ì§œ ì´ˆê¸°í™”
	    	document.getElementById("startDate").value = "";
	    	document.getElementById("endDate").value = "";
	    	// ë°œì£¼ì§€ì  ì„ íƒ ê°’ ì´ˆê¸°í™”
	        document.getElementById("inputBhf").value = "";
	    	
	        search();
	        

		}
		
		
		// ì£¼ë¬¸ë“±ë¡, ë°œì£¼ì·¨ì†Œ í•œë’¤ í™”ë©´ ì´ˆê¸°í™”
		function refreshOrderGrid() {
			REnodata();
			REDnodata();
			
		    // ìƒì„¸ í…Œì´ë¸” ì´ˆê¸°í™”
		    detailGrid.resetData([]);

		    // ê·¸ë¦¬ë“œ ë°ì´í„° ê°±ì‹ 
		    grid.reloadData();

		    // ìš”ì²­ ì •ë³´ ì¶œë ¥ ì‚­ì œ
		    document.querySelector('#selectedOrder').innerHTML = '';
		    
		    selectedRow = null; // ì„ íƒëœ ì£¼ë¬¸ ì •ë³´ ì´ˆê¸°í™”
			detailData = [];    // ìƒì„¸ ë°ì´í„° ì •ë³´ ì´ˆê¸°í™”
		}

		
		
		
		
		// ëª¨ë“  í˜ì´ì§€ì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
		async function loadAllOrderDetails(orderCode) {
		    if (!orderCode) {
		        console.warn("ìœ íš¨í•˜ì§€ ì•Šì€ ì£¼ë¬¸ ì½”ë“œì…ë‹ˆë‹¤.");
		        return;
		    }
		
		    let allDetails = [];
		    let page = 1;
		    let isLastPage = false;
		
		    while (!isLastPage) {
		        try {
		            const response = await fetch(`/bsn/rest/bhfOrder/detail?orderCode=${orderCode}&perPage=5&page=${page}`);
		            if (!response.ok) throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ: ${response.status}`);
		            
		            const data = await response.json();
		            if (data?.data?.contents?.length) {
		                allDetails = allDetails.concat(data.data.contents);
		                page++;
		            } else {
		                isLastPage = true;
		            }
		        } catch (error) {
		            console.error("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
		            isLastPage = true;
		        }
		    }
		
		    //console.log("ëª¨ë“  ìƒì„¸ ë°ì´í„°:", allDetails);
		
		    let orderDTO = {
		        orderCode: selectedRow.orderCode,
		        branchOfficeId: selectedRow.branchOfficeId,
		        orderDate: selectedRow.orderDate,
		        dueDate: selectedRow.dueDate,
		        remark: selectedRow.remark,
		        companyNum: selectedRow.companyNum,
		        employeeNum: employeeNum,
		        orderDetails: allDetails
		    };
		
		    //console.log("ë“±ë¡í•  ì£¼ë¬¸:", orderDTO);
		    
		 	// ë“±ë¡ í•¨ìˆ˜ í˜¸ì¶œ
		    registerOrder(orderDTO);
		 	
		 	//í™”ë©´ ì´ˆê¸°í™” í•¨ìˆ˜
		 	//refreshOrderGrid();
		 	
		}
		
		
	    
		// ì£¼ë¬¸ ë“±ë¡ í•¨ìˆ˜
		function registerOrder(orderDTO) {
			const header = document.querySelector('meta[name="_csrf_header"]').content;
		    const token = document.querySelector('meta[name="_csrf"]').content;
			
		    fetch('/bsn/rest/order/insert', {
		        method: 'POST',
		        headers: {
		        	'header': header,
		        	'X-CSRF-Token': token,
		            'Content-Type': 'application/json'  // JSON í˜•ì‹ìœ¼ë¡œ ë³´ë‚´ê¸°
		        },
		        body: JSON.stringify(orderDTO)  // ê°ì²´ë¥¼ JSONìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
		    })
		    .then(response => response.json())
		    .then(data => {
		        if (data.status === "success") {
		            showAlert('ì£¼ë¬¸ ë“±ë¡ ì„±ê³µ', 'success');
		         	// ê°’ ì´ˆê¸°í™” + ê°’ ì´ˆê¸°í™”
		            refreshOrderGrid();
		           
		        } else {
		            showAlert('ë°œì£¼ ë“±ë¡ ì‹¤íŒ¨:'+ data.message, 'danger');
		        }
		        //í…Œì´ë¸” ì´ˆê¸°í™”?

		    }) 
		}
		
		//ì·¨ì†Œ ì‚¬ìœ  ì…ë ¥ìš© ê°ì²´ ìƒì„±
		function createCancelRequest() {
			const cancelReasonInput = document.querySelector('#cancelReason');
		    const cancelReason = cancelReasonInput.value.trim(); // ê³µë°± ì œê±°

		    if (!cancelReason) { // ë¹ˆ ê°’ ì²´í¬
		        showAlert('ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'danger');
		        cancelReasonInput.focus(); // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
		        return null; // ìœ íš¨í•˜ì§€ ì•Šì€ ì…ë ¥ì´ë©´ null ë°˜í™˜
		    }
		    
		    return {
		        orderCode: selectedRow.orderCode, // ì„ íƒëœ ì£¼ë¬¸ ì½”ë“œ
		        orderCancelReason: cancelReason //cancelReasonInput.value
		    };
		}
		
		// ë°œì£¼ ì·¨ì†Œ í•¨ìˆ˜
		function cancelOrder(cancelRequest) {
			const header = document.querySelector('meta[name="_csrf_header"]').content;
		    const token = document.querySelector('meta[name="_csrf"]').content;
			
		    fetch('/bsn/rest/bhfOrder/cancel', {
		        method: 'POST',
		        headers: {
		        	'header': header,
		        	'X-CSRF-Token': token,
		            'Content-Type': 'application/json'  // JSON í˜•ì‹ìœ¼ë¡œ ë³´ë‚´ê¸°
		        },
		        body: JSON.stringify(cancelRequest)  // ê°ì²´ë¥¼ JSONìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
		    })
		    .then(response => response.json())
		    .then(data => {
		        if (data.status === "success") {
		            showAlert('ë°œì£¼ ì·¨ì†Œ ì™„ë£Œ', 'success');
		         	// ê·¸ë¦¬ë“œ ì´ˆê¸°í™” + ê°’ ì´ˆê¸°í™”
		            refreshOrderGrid();
		            document.querySelector('#cancelReason').value = '';
		           
		        } else {
		            showAlert('ë°œì£¼ ì·¨ì†Œ ì‹¤íŒ¨:'+ data.message, 'danger');
		        }


		    }) 
		}

		// ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
		const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
		const cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));

		// ì£¼ë¬¸ ì„ íƒ í™•ì¸ í•¨ìˆ˜
		function checkOrderSelection(modal) {
		    if (selectedRow && selectedRow.orderCode) {
		    	// ëª¨ë‹¬ì´ 'cancelModal'ì´ë©´ ë°œì£¼ ì½”ë“œ í‘œì‹œ
		        if (modal === cancelModal) {
		            document.getElementById("cancelOrderCode").textContent = selectedRow.orderCode;
		        } else {
		            document.getElementById("registerOrderCode").textContent = selectedRow.orderCode;
		        }
		        modal.show();
		    } else {
		        showAlert('ì£¼ë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”!', 'danger');
		    }
		}

		// ì£¼ë¬¸ ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
		document.getElementById('registerButton').addEventListener('click', () => {
		    checkOrderSelection(registerModal); // ë“±ë¡ ëª¨ë‹¬ ë„ìš°ê¸°
		});

		// ì£¼ë¬¸ ê±°ë¶€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
		document.getElementById('cancelButton').addEventListener('click', () => {
		    checkOrderSelection(cancelModal); // ê±°ë¶€ ëª¨ë‹¬ ë„ìš°ê¸°
		});

		// ê³µí†µëœ ë²„íŠ¼ì„ ë‹¤ë£¨ë˜, ëª¨ë‹¬ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ë™ì‘í•˜ë„ë¡ ì„¤ì •
		document.querySelectorAll('.modal-footer #btn-register').forEach(button => {
		    button.addEventListener('click', () => {
		        if (selectedRow && selectedRow.orderCode) {
		            // í˜„ì¬ show í´ë˜ìŠ¤ê°€ ìˆëŠ” ëª¨ë‹¬ ì°¾ê¸°
		            const activeModal = document.querySelector('.modal.show');
		            
		            if (activeModal) {
		                if (activeModal.id === 'registerModal') {
		                    // ì£¼ë¬¸ ë“±ë¡ ì²˜ë¦¬
		                    loadAllOrderDetails(selectedRow.orderCode);
		                    registerModal.hide();
		                    
		                } else if (activeModal.id === 'cancelModal') {
		                	// ë°œì£¼ìš”ì²­ ì·¨ì†Œìš© ê°ì²´ ìƒì„±
		                    const cancelRequest = createCancelRequest();
		                    if (!cancelRequest) return; // ì·¨ì†Œ ì‚¬ìœ ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
		                    //ë°œì£¼ìš”ì²­ ì·¨ì†Œ ì²˜ë¦¬
		                    cancelOrder(cancelRequest);
		                    //console.log(cancelRequest);
		                    cancelModal.hide();
		                }
		            }
		        } else {
		            showAlert('ì£¼ë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”!', 'danger');
		        }
		    });
		});

		document.querySelectorAll('.modal-footer .btn-danger').forEach(button => {
		    button.addEventListener('click', () => {
		        // í˜„ì¬ í™œì„±í™”ëœ ëª¨ë‹¬ ì°¾ê¸°
		        const activeModal = document.querySelector('.modal.show');

		        if (activeModal) {
		        	//console.log(activeModal);
		        	if (activeModal.id === 'registerModal') {
	                    // ì£¼ë¬¸ ë“±ë¡ ì²˜ë¦¬
	                    registerModal.hide();
	                } else if (activeModal.id === 'cancelModal') {
	                    // ë°œì£¼ ì·¨ì†Œ ì²˜ë¦¬ ë¡œì§
	                    document.querySelector('#cancelReason').value = '';
	                    cancelModal.hide();
	                }
		        }
		    });
		});
		
		
		
		
		
		// êµí™˜ë°ë°˜í’ˆ í…Œì´ë¸” ë°ì´í„° ì—†ì„ë•Œ ë‚˜ì˜¤ëŠ” ë¬¸êµ¬
		function REnodata(){
			setTimeout( () => {
				let nodata = document.querySelectorAll('.tui-grid-layer-state-content p')[0];
				nodata.innerHTML = 'ìš”ì²­ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
			}, 100)
		}
		// êµí™˜ë°ë°˜í’ˆ ìƒì„¸ í…Œì´ë¸” ë°ì´í„° ì—†ì„ë•Œ ë‚˜ì˜¤ëŠ” ë¬¸êµ¬
		function REDnodata(){
			setTimeout( () => {
				let nodata = document.querySelectorAll('.tui-grid-layer-state-content p')[1];
				nodata.innerHTML = 'ì£¼ë¬¸ì„ ì„ íƒí•´ì•¼í•©ë‹ˆë‹¤.';
			}, 100)
		}
		





	  </script>



</body>

</html>