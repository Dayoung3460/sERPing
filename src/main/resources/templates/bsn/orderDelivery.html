<!DOCTYPE html>
<html 
lang="en"
layout:decorate="~{layouts/layout}" 
xmlns:th="http://www.thymeleaf.org"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>

<head>

  <style>
  	#custom-container{
		background-color: #f8f9fa; /* 연한 회색 배경 */
		padding: 20px;
		border-radius: 10px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* 박스 그림자 */
		margin-bottom: 20px;
	
	}
  </style>

</head>
<body layout:fragment="content">
  <!-- 페이지 내용 시작 -->
	<div>
		<h1>출고 페이지</h1>
		<div class="row">
        	<div class="col-md-8  grid-margin stretch-card">
            	<div class="card">
              		<div class="card-body">
                		<h4 class="card-title">출고 목록</h4>
                		<p class="card-description">그리드 - 검색한 주문 리스트 출력</p>
                		<div id="orderList"></div>
               		 	<div id="pagination" class="tui-pagination"></div>
              		</div>
            	</div>
            	
          	</div>
          	
          	<div class="col-md-4  grid-margin stretch-card">
            	<div class="card">
              		<div class="card-body">
                		<h4 class="card-title">주문 목록</h4>
                		<p class="card-description">그리드 - 검색한 주문 리스트 출력</p>
                		<div id="deliDetail"></div>
               		 	<div id="pagination" class="tui-pagination"></div>
              		</div>
            	</div>
            	
          	</div>
        </div>
	</div>
	
<script>
var Grid = tui.Grid;
const OrderListDataSource = {
		api: {
			readData: { url: 'http://localhost:81/bsn/rest/deli', method: 'GET', initParams: { page: 1 }},
		},
		contentType: 'application/json'
};


//상품 테이블
const orderList = new Grid({
		el: document.getElementById('orderList'), // 컨테이너 엘리먼트
		pageOptions: {
		useClient: false,
		perPage: 10,
	},
	columns: [ 
		{ header : "출고ID", name : "deliveryId", sortable : true},
		{ header : "주문ID", name : "orderId", sortable : true},
		{ header : "주문명", name : "orderName", width: 'auto',  sortable : true},
		{ header : "지점코드", name : "branchOfficeId"},
		{ header : "담당자번호", name : "employeeNum"},
		// { header : "회사번호", name : "companyNum"},
		{ header : "주문일", name : "orderDate", formatter: ({ value }) => formatDate(value, 'order'), width: 'auto', sortable : true},
		{ header : "납기일", name : "dueDate", formatter: ({ value }) => formatDate(value, 'due'), width: 'auto', sortable : true},
		{ header : "출고일", name : "delivaryDate", formatter: ({ value }) => formatDate(value, 'due'), width: 'auto', sortable : true},
		{ header : "출고상태", name : "deliveryStatus", sortable : true},
		{ header : "비고", name : "remark", width: 'auto'},
	],
	data: OrderListDataSource
});

//그리드 날짜 형식 변경(데이터 수정X, 표기만)
function formatDate(dateString, type) {
    if (!dateString) return ''; // 데이터가 없으면 빈 문자열 반환
    const date = new Date(dateString);
    if (isNaN(date)) return dateString; // 날짜 변환이 실패하면 원본 유지

    return type === 'order' 
        ? date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' }) // "2025년 2월 17일"
        : date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' }); // "02/17 (월)"
}



//출고 클릭 시 상세 불러오기
orderList.on('click', (ev) => {
	
    const rowKey = ev.rowKey; // 클릭한 행의 키
    if (rowKey === null || rowKey === undefined) {
        return;
    }
    
    //console.log(rowKey);
    const rowData = orderList.getRow(rowKey); // 클릭한 행 데이터 가져오기
    console.log(rowData.deliveryId);
    if (rowData && rowData.deliveryId) {
    	loadDeliveryDetail(rowData.deliveryId); // 상세 정보 불러오기
    }
});

//불러오는 함수
function loadDeliveryDetail(deliveryId) {
	if (!deliveryId) {
        console.warn("유효하지 않은 주문 Id입니다.");
        return;
    }
	
    fetch(`http://localhost:81/bsn/rest/deli/detail?deliveryId=${deliveryId}`)
    	
        .then(response => {
	            if (!response.ok) throw new Error(`HTTP 오류! 상태: ${response.status}`);
	            return response.json();
	     })
	     
        .then(data => {
            if (data && data.data && data.data.contents) {
            	const detailData = data.data.contents; // 상세 데이터 저장
            	
            	
            	//
                deliveryDetailGrid.resetData(detailData);
            } else {
                console.warn("상세 데이터가 없습니다.");
                orderDetailGrid.resetData([]); // 빈 배열로 초기화
            }
        })
        .catch(error => console.error('Error fetching order detail:', error));
}

//상세 그리드 형식
const deliveryDetailGrid = new Grid({
el: document.getElementById('deliDetail'),
columns: [
    { header: "상품명", name: "goodsName", 
    //	width: 'auto' ,	
    },
    { header: "옵션명", name: "optionName", },
    { header: "옵션코드", name: "optionCode",  },
    { header: "수량", name: "quantity",  },

],
pageOptions: {
    useClient: false,
    perPage: 5
}
});
</script>
</body>
</html>