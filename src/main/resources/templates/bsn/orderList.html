<!DOCTYPE html>
<html 
lang="en"
layout:decorate="~{layouts/layout}" 
xmlns:th="http://www.thymeleaf.org"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>

<head>

  <style>
  	#custom-container{
		background-color: #f8f9fa; /* 연한 회색 배경 */
		padding: 20px;
		border-radius: 10px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* 박스 그림자 */
		margin-bottom: 20px;
	
	}
  </style>

</head>

<body layout:fragment="content">
  <!-- 페이지 내용 시작 -->

      <div class="container">
		<h3>주문 목록</h3>
        <div class="row mb-3">
	        <div class="col-12">
	            <div class="card">
	                <div class="card-body">
	                    <h4 class="card-title">검색 조건</h4>
	                    <p class="card-description">검색 조건을 선택하세요.</p>
	                        <div class="d-flex align-items-center gap-3">
	                            <!-- 라디오 버튼 -->
	                            <div class="d-flex gap-3">
	                                <div class="form-check">
	                                    <label class="form-check-label">
	                                        <input type="radio" class="form-check-input" name="optionsRadios" value="notSelect" checked onclick="toggleDateInputs(false)">
	                                        사용안함
	                                    </label>
	                                </div>
	                                <div class="form-check">
	                                    <label class="form-check-label">
	                                        <input type="radio" class="form-check-input" name="optionsRadios" value="orderDate" onclick="toggleDateInputs(true)">
	                                        주문일자
	                                    </label>
	                                </div>
	                                <div class="form-check">
	                                    <label class="form-check-label">
	                                        <input type="radio" class="form-check-input" name="optionsRadios" value="dueDate" onclick="toggleDateInputs(true)">
	                                        납기일자
	                                    </label>
	                                </div>
	                            </div>
	
	                            <!-- 날짜 입력 -->
	                            <div class="d-flex gap-3">
	                                <div>
	                                    <label for="startDate">시작 날짜</label>
	                                    <input type="date" class="form-control" id="startDate" name="startDate" disabled>
	                                </div>
	                                <div>
	                                    <label for="endDate">끝 날짜</label>
	                                    <input type="date" class="form-control" id="endDate" name="endDate" disabled>
	                                </div>
	                            </div>
	                        </div>
	
	                        <div class="form-group m-3">
	                            <label for="selectBhf">발주지점</label>
	                            <select class="form-control" id="selectBhf">
	                            	<option>all</option>
	                                <option>발주지점1</option>
	                                <option>발주지점2</option>
	                                <option>발주지점3</option>
	                                <option>yedam</option>
	                            </select>
	                        </div>
							<div class="col-12 text-center">
	                        	<button class="btn btn-primary mr-2" onclick="search()">검색</button>
	                        	<button class="btn btn-light"        onclick="reset()">초기화</button>
	                        </div>
	                </div>
	            </div>
	        </div>
	    </div>
        
        
        <div class="row">
        	<div class="col-md-12  grid-margin stretch-card">
            	<div class="card">
              		<div class="card-body">
                		<h4 class="card-title">주문 목록</h4>
                		<p class="card-description">그리드 - 검색한 주문 리스트 출력</p>
                		<div id="orderList"></div>
               		 	<div id="pagination" class="tui-pagination"></div>
              		</div>
            	</div>
          	</div>

        </div>
        <div class="row">
          	<div class="col-md-12  grid-margin stretch-card">
            	<div class="card">
              		<div class="card-body">
                		<h4 class="card-title">주문 상세</h4>
                		<p class="card-description"></p>
                		<div id="orderDetail"></div>
               		 	<div id="pagination" class="tui-pagination"></div>
              		</div>
            	</div>
          	</div>
        </div>
        
        
        
        
        
        
        
        
        
      </div>
      <!-- content-wrapper ends -->
  <!-- 페이지 내용 끝 -->
<script>
    function toggleDateInputs(enable) {
      document.getElementById("startDate").disabled = !enable;
      document.getElementById("endDate").disabled = !enable;
      
     
    }
    
	var Grid = tui.Grid;
	const OrderListDataSource = {
			api: {
				readData: { url: 'http://localhost:81/bsn/rest/orderList', method: 'GET', initParams: { page: 1 }},
			},
			contentType: 'application/json'
	};
	
	
	//상품 테이블
	const orderList = new Grid({
			el: document.getElementById('orderList'), // 컨테이너 엘리먼트
			pageOptions: {
			useClient: false,
			perPage: 10,
		},
		columns: [ 
			{ header : "주문ID", name : "orderId", sortable : true},
			{ header : "주문명", name : "orderName", width: 'auto',  sortable : true},
			{ header : "발주코드", name : "orderCode"},
			{ header : "지점코드", name : "branchOfficeId"},
			// { header : "회사번호", name : "companyNum"},
			{ header : "주문일", name : "orderDate", formatter: ({ value }) => formatDate(value, 'order'), width: 'auto', sortable : true},
			{ header : "납기일", name : "dueDate", formatter: ({ value }) => formatDate(value, 'due'), width: 'auto', sortable : true},
			{ header : "비고", name : "remark", width: 'auto'},
		],
		data: OrderListDataSource
	});
	
	//그리드 날짜 형식 변경(데이터 수정X, 표기만)
	function formatDate(dateString, type) {
	    if (!dateString) return ''; // 데이터가 없으면 빈 문자열 반환
	    const date = new Date(dateString);
	    if (isNaN(date)) return dateString; // 날짜 변환이 실패하면 원본 유지

	    return type === 'order' 
	        ? date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' }) // "2025년 2월 17일"
	        : date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' }); // "02/17 (월)"
	}
	
	//검색
	function search(){
		let selectedOption = document.querySelector('input[name="optionsRadios"]:checked').value; // 라디오 버튼 선택 값
	    let startDate = document.getElementById("startDate").value; // 시작 날짜
	    let endDate = document.getElementById("endDate").value; // 끝 날짜
	    let selectedBhf = document.getElementById("selectBhf").value; // 발주지점 선택 값
	    
	    console.log(selectedOption, startDate, endDate, selectedBhf);
	    
	    let params = {
	    		"deteOption": selectedOption,
	            "startDate": startDate,
	            "endDate": endDate,
	            "branch": selectedBhf
	    };
	    
	    console.log("검색 조건:", params);
	    
	    orderList.readData(1, params, true);
	}
	
	//주문 클릭 시 상세 불러오기
	orderList.on('click', (ev) => {
		
		
	    const rowKey = ev.rowKey; // 클릭한 행의 키
	    if (!rowKey) {
	        return;
	    }
	    
	    //console.log(rowKey);
	    const rowData = orderList.getRow(rowKey); // 클릭한 행 데이터 가져오기
	    console.log(rowData.orderId);
	    if (rowData && rowData.orderId) {
	        loadOrderDetail(rowData.orderId); // 상세 정보 불러오기
	    }
	});
	
	//불러오는 함수
	function loadOrderDetail(orderId) {
		if (!orderId) {
	        console.warn("유효하지 않은 주문 Id입니다.");
	        return;
	    }
		
	    fetch(`http://localhost:81/bsn/rest/orderList/detail?orderId=${orderId}`)
	    	
	        .then(response => {
		            if (!response.ok) throw new Error(`HTTP 오류! 상태: ${response.status}`);
		            return response.json();
		     })
		     
	        .then(data => {
	            if (data && data.data && data.data.contents) {
	            	const detailData = data.data.contents; // 상세 데이터 저장
	            	
	            	//총액 계산
	            	detailData.forEach(item => {
	                    if (item.unitPrice && item.quantity) {
	                        item.totalPrice = item.unitPrice * item.quantity;
	                    } else {
	                        item.totalPrice = 0; // 단가나 수량이 없으면 0으로 설정
	                    }
	                });
	            	//
	                orderDetailGrid.resetData(detailData);
	            } else {
	                console.warn("상세 데이터가 없습니다.");
	                orderDetailGrid.resetData([]); // 빈 배열로 초기화
	            }
	        })
	        .catch(error => console.error('Error fetching order detail:', error));
	}
	
	//상세 그리드 형식
	const orderDetailGrid = new Grid({
    el: document.getElementById('orderDetail'),
    columns: [
        { header: "상품명", name: "goodsName", 
        //	width: 'auto' ,	
        },
        { header: "옵션명", name: "optionName", },
        { header: "상품코드", name: "goodsCode",  },
        { header: "옵션코드", name: "optionCode",  },
        { header: "수량", name: "quantity",  },
        { header: "단가", name: "unitPrice",  },
        { header: "총액", name: "totalPrice",  }
    ],
    pageOptions: {
        useClient: false,
        perPage: 5
    }
	
	
});
	

</script>



</body>

</html>